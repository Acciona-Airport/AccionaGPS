<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
        }
        .control-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
        }
        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }
        .toggle-panel {
            background: var(--white);
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
            margin-left: 5px;
            flex-shrink: 0;
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }
        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }
        .control-panel.visible .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .control-panel.visible .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        .control-panel.visible .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: var(--online-color); }
        .offline { color: var(--offline-color); }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        /* Estilos para los iconos de autos */
        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
        }
        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        /* Estilo para los marcadores en el mapa */
        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        /* Estilo para la etiqueta del marcador */
        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }
        /* Estilos para el botón de actualización */
        .refresh-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
        }
        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.2s;
        }
        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* Añadido: Selector de proveedor de mapas */
        .map-provider-selector {
            position: fixed;
            bottom: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .map-provider-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);">🚗 Flota Acciona</h3>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="movil1-icon" class="vehicle-icon offline"></div>
                    Móvil 1
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="movil1-status" class="offline">Desconectado</span>
                </div>
            </div>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="movil2-icon" class="vehicle-icon offline"></div>
                    Móvil 2
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="movil2-status" class="offline">Desconectado</span>
                </div>
            </div>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="movil3-icon" class="vehicle-icon offline"></div>
                    Móvil 3
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="movil3-status" class="offline">Desconectado</span>
                </div>
            </div>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="movil4-icon" class="vehicle-icon offline"></div>
                    Móvil 4
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="movil4-status" class="offline">Desconectado</span>
                </div>
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
        </div>
        
        <button class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </button>
    </div>

    <!-- Botón de actualización -->
    <div class="refresh-container">
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Actualizar
        </button>
    </div>

    <!-- Selector de proveedor de mapas -->
    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="carto">CartoDB (Recomendado)</option>
            <option value="osm">OpenStreetMap</option>
            <option value="stadia">Stadia Maps</option>
            <option value="esri">ESRI World Imagery</option>
        </select>
    </div>

    <!-- Firebase y Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuración Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDT85qotm1EpAJzJzCFeoNwGyo-VKhM6dk",
            authDomain: "gpsaccionascl2025.firebaseapp.com",
            databaseURL: "https://gpsaccionascl2025-default-rtdb.firebaseio.com",
            projectId: "gpsaccionascl2025",
            storageBucket: "gpsaccionascl2025.appspot.com",
            messagingSenderId: "742246618721",
            appId: "1:742246618721:web:72d0046987416800f07c20"
        };

        // Inicializa Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Configuración del mapa
        const SCL_COORDS = [-33.3931, -70.7858];
        const INACTIVE_COORDS = [-33.409995, -70.788647];
        const ZOOM_INICIAL = 14;
        let map;
        let currentTileLayer;
        const markers = {};
        const lastUpdateTimes = {};
        let gpsInterval;
        const TEN_MINUTES = 10 * 60 * 1000;
        
        // Proveedores de mapas alternativos (solución al problema de User-Agent)
        const mapProviders = {
            carto: {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            },
            osm: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            },
            stadia: {
                url: 'https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://stadiamaps.com/">Stadia Maps</a>, &copy; <a href="https://openmaptiles.org/">OpenMapTiles</a> &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
                maxZoom: 20
            },
            esri: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            }
        };
        
        // Verificar autenticación al cargar
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                if (!auth) window.location.href = 'login.html';
                
                initMap();
                setupUI();
                initializeAllMarkers();
                
                if (!auth.isViewer) {
                    startGPSTracking(auth.username);
                } else {
                    startMonitoring();
                }
            }
        });
        
        function initMap() {
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            
            // Cargar el proveedor de mapas guardado o usar el recomendado por defecto
            const savedProvider = localStorage.getItem('mapProvider') || 'carto';
            document.getElementById('mapProvider').value = savedProvider;
            setMapProvider(savedProvider);
            
            // Marcador del aeropuerto
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('✈️ Aeropuerto SCL')
                .openPopup();
        }
        
        function setMapProvider(providerKey) {
            // Eliminar la capa actual si existe
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            // Obtener la configuración del proveedor
            const provider = mapProviders[providerKey];
            
            // Añadir la nueva capa
            currentTileLayer = L.tileLayer(provider.url, {
                attribution: provider.attribution,
                maxZoom: provider.maxZoom
            }).addTo(map);
            
            // Guardar la preferencia
            localStorage.setItem('mapProvider', providerKey);
        }
        
        function setupUI() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            const panel = document.getElementById('controlPanel');
            const toggleBtn = document.getElementById('togglePanel');
            
            toggleBtn.addEventListener('click', function() {
                panel.classList.toggle('visible');
            });
            
            // Configurar botón de actualización
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', function() {
                refreshBtn.classList.add('loading');
                
                setTimeout(() => {
                    const isPanelVisible = panel.classList.contains('visible');
                    localStorage.setItem('panelState', isPanelVisible ? 'open' : 'closed');
                    
                    window.location.reload();
                }, 500);
            });
            
            // Configurar selector de proveedor de mapas
            document.getElementById('mapProvider').addEventListener('change', function(e) {
                setMapProvider(e.target.value);
            });
            
            // Al cargar la página, verificar si el panel debe estar abierto o cerrado
            const savedPanelState = localStorage.getItem('panelState');
            if (savedPanelState === 'open') {
                panel.classList.add('visible');
            }
        }
        
        function initializeAllMarkers() {
            const mobileIds = ['Movil1', 'Movil2', 'Movil3', 'Movil4'];
            
            mobileIds.forEach(mobileId => {
                createMarker(mobileId, INACTIVE_COORDS, false);
                lastUpdateTimes[mobileId] = Date.now();
            });
        }
        
        function startGPSTracking(mobileId) {
            if (gpsInterval) clearInterval(gpsInterval);
            
            updatePosition(mobileId);
            
            gpsInterval = setInterval(() => {
                updatePosition(mobileId);
            }, 3000);
        }
        
        function updatePosition(mobileId) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const coords = [
                            position.coords.latitude.toFixed(6),
                            position.coords.longitude.toFixed(6)
                        ];
                        savePosition(mobileId, coords, position.coords.accuracy);
                    },
                    error => {
                        console.error('Error GPS:', error);
                        updateStatus(mobileId, 'offline');
                        database.ref(`vehicles/${mobileId}`).update({
                            status: 'offline',
                            lastUpdate: firebase.database.ServerValue.TIMESTAMP
                        });
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                alert("Tu navegador no soporta geolocalización");
            }
        }
        
        function savePosition(mobileId, coords, accuracy) {
            const now = Date.now();
            database.ref(`vehicles/${mobileId}`).set({
                coords: {
                    lat: parseFloat(coords[0]),
                    lng: parseFloat(coords[1])
                },
                status: 'online',
                lastUpdate: now,
                accuracy: accuracy
            });
            
            lastUpdateTimes[mobileId] = now;
            updateMarker(mobileId, coords, true);
            updateStatus(mobileId, 'online');
        }
        
        function startMonitoring() {
            setInterval(checkConnectionStatus, 60000);
            
            database.ref('vehicles').on('value', (snapshot) => {
                const vehiclesData = snapshot.val() || {};
                
                Object.keys(vehiclesData).forEach(mobileId => {
                    const vehicle = vehiclesData[mobileId];
                    if (vehicle && vehicle.coords) {
                        const now = Date.now();
                        lastUpdateTimes[mobileId] = vehicle.lastUpdate || now;
                        
                        const isOnline = (now - (vehicle.lastUpdate || 0)) < TEN_MINUTES;
                        const coords = isOnline ? 
                            [vehicle.coords.lat, vehicle.coords.lng] : 
                            INACTIVE_COORDS;
                        
                        updateMarker(mobileId, coords, isOnline);
                        updateStatus(mobileId, isOnline ? 'online' : 'offline');
                    }
                });
            });
        }
        
        function checkConnectionStatus() {
            const now = Date.now();
            Object.keys(lastUpdateTimes).forEach(mobileId => {
                const lastUpdate = lastUpdateTimes[mobileId] || 0;
                if ((now - lastUpdate) > TEN_MINUTES) {
                    updateStatus(mobileId, 'offline');
                    if (markers[mobileId]) {
                        const icon = L.divIcon({
                            className: 'vehicle-marker offline',
                            html: `
                                <div class="vehicle-marker offline"></div>
                                <div class="vehicle-label">${mobileId}</div>
                            `,
                            iconSize: [32, 42],
                            iconAnchor: [16, 16],
                            popupAnchor: [0, -16]
                        });
                        markers[mobileId]
                            .setIcon(icon)
                            .setLatLng(INACTIVE_COORDS)
                            .setPopupContent(`<b>${mobileId}</b><br>Desconectado<br>Última actualización: ${new Date(lastUpdate).toLocaleTimeString()}`);
                    }
                }
            });
        }
        
        function createMarker(mobileId, coords, isOnline) {
            if (markers[mobileId]) return;
            
            const container = L.divIcon({
                className: 'vehicle-marker-container',
                html: `
                    <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                    <div class="vehicle-label">${mobileId}</div>
                `,
                iconSize: [32, 42],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });

            markers[mobileId] = L.marker(coords, { 
                icon: container,
                title: mobileId
            }).addTo(map)
            .bindPopup(`<b>${mobileId}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}`);
        }
        
        function updateMarker(mobileId, coords, isOnline) {
            if (!markers[mobileId]) {
                createMarker(mobileId, coords, isOnline);
            } else {
                const container = L.divIcon({
                    className: 'vehicle-marker-container',
                    html: `
                        <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                        <div class="vehicle-label">${mobileId}</div>
                    `,
                    iconSize: [32, 42],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                markers[mobileId]
                    .setLatLng(coords)
                    .setIcon(container)
                    .setPopupContent(`<b>${mobileId}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}<br>Última actualización: ${new Date().toLocaleTimeString()}`);
            }
        }
        
        function updateStatus(mobileId, status) {
            const element = document.getElementById(`${mobileId.toLowerCase()}-status`);
            const iconElement = document.getElementById(`${mobileId.toLowerCase()}-icon`);
            
            if (element) {
                element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                element.className = status === 'online' ? 'online' : 'offline';
            }
            
            if (iconElement) {
                iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
            }
        }
        
        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            database.ref('vehicles').off();
            firebase.auth().signOut();
            localStorage.removeItem('gpsAuth');
            localStorage.removeItem('panelState');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
