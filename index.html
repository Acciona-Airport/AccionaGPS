<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f44336">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
            --user-position-color: #3498db;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background-color: #2c3e50;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
        }
        .control-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }
        .toggle-panel {
            background: var(--white);
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
            margin-left: 5px;
            flex-shrink: 0;
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }
        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: var(--online-color); }
        .offline { color: var(--offline-color); }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        /* Estilos para los iconos de autos */
        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
        }
        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        /* Estilo para los marcadores en el mapa */
        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        /* Estilo para la etiqueta del marcador */
        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }
        /* Estilos para el bot√≥n de actualizaci√≥n */
        .refresh-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
        }
        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.2s;
        }
        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* A√±adido: Selector de proveedor de mapas */
        .map-provider-selector {
            position: fixed;
            bottom: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .map-provider-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        /* Notificaci√≥n de estado */
        .status-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            font-size: 14px;
        }
        /* Indicador de ubicaci√≥n propia */
        .current-user-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: var(--red-dark);
        }
        /* Panel de diagn√≥stico */
        .diagnostic-panel {
            position: fixed;
            bottom: 100px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
            max-width: 300px;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .diagnostic-panel.hidden {
            transform: translateX(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }
        .diagnostic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .diagnostic-title {
            font-weight: bold;
            margin: 0;
        }
        .toggle-diagnostic {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .diagnostic-item {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .diagnostic-value {
            font-weight: bold;
        }
        .good { color: green; }
        .bad { color: red; }
        .warning { color: orange; }
        
        /* Pulsating circle for user location */
        .pulse-circle {
            border-radius: 50%;
            background-color: var(--user-position-color);
            width: 20px;
            height: 20px;
            position: absolute;
            left: -10px;
            top: -10px;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
        
        /* Emergency location button */
        .emergency-locate-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--user-position-color);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        /* Location accuracy circle */
        .accuracy-circle {
            fill: rgba(52, 152, 219, 0.2);
            stroke: rgba(52, 152, 219, 0.5);
            stroke-width: 1;
        }
        
        /* Ajuste para controles de zoom de Leaflet */
        .leaflet-control-zoom {
            margin-top: 80px !important;
        }
        
        /* Bot√≥n para mostrar/ocultar diagn√≥stico */
        .show-diagnostic-btn {
            position: fixed;
            bottom: 100px;
            right: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="status-notification" id="statusNotification"></div>
    
    <div class="current-user-indicator" id="currentUserIndicator">
        <span id="locationStatus">Buscando tu ubicaci√≥n...</span>
    </div>
    
    <div class="diagnostic-panel" id="diagnosticPanel">
        <div class="diagnostic-header">
            <h4 class="diagnostic-title">Diagn√≥stico GPS</h4>
            <button class="toggle-diagnostic" id="hideDiagnosticBtn">‚úï</button>
        </div>
        <div class="diagnostic-item">
            <span>Estado GPS:</span>
            <span id="gpsStatus" class="diagnostic-value warning">Comprobando...</span>
        </div>
        <div class="diagnostic-item">
            <span>Precisi√≥n:</span>
            <span id="accuracyValue" class="diagnostic-value">--</span>
        </div>
        <div class="diagnostic-item">
            <span>√öltima actualizaci√≥n:</span>
            <span id="lastUpdateValue" class="diagnostic-value">--</span>
        </div>
        <div class="diagnostic-item">
            <span>M√©todo:</span>
            <span id="methodValue" class="diagnostic-value">--</span>
        </div>
        <button id="forceLocationBtn" style="margin-top: 10px; width: 100%; padding: 5px; background: #3498db; color: white; border: none; border-radius: 3px; cursor: pointer;">
            Forzar Ubicaci√≥n
        </button>
    </div>
    
    <button class="show-diagnostic-btn" id="showDiagnosticBtn" style="display: none;">+</button>

    <button class="emergency-locate-btn" id="emergencyLocateBtn" title="Centrar en mi ubicaci√≥n">üìç</button>

    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);">üöó Flota Acciona</h3>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="current-user-icon" class="vehicle-icon offline"></div>
                    <span id="current-user-name">Mi Ubicaci√≥n</span>
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="current-user-status" class="offline">Desconectado</span>
                </div>
                <div class="vehicle-status">
                    <span>Coordenadas:</span>
                    <span id="current-user-coords">--</span>
                </div>
            </div>
            
            <div id="other-vehicles-container" style="display: none;">
                <h4 style="margin: 15px 0 10px 0; color: var(--red-dark);">Otros Veh√≠culos</h4>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil1-icon" class="vehicle-icon offline"></div>
                        M√≥vil 1
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil1-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil2-icon" class="vehicle-icon offline"></div>
                        M√≥vil 2
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil2-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil3-icon" class="vehicle-icon offline"></div>
                        M√≥vil 3
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil3-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil4-icon" class="vehicle-icon offline"></div>
                        M√≥vil 4
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil4-status" class="offline">Desconectado</span>
                    </div>
                </div>
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
        
        <button class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </button>
    </div>

    <!-- Bot√≥n de actualizaci√≥n -->
    <div class="refresh-container">
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Actualizar
        </button>
    </div>

    <!-- Selector de proveedor de mapas -->
    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="esri">ESRI World Imagery</option>
            <option value="carto">CartoDB</option>
            <option value="osm">OpenStreetMap</option>
        </select>
    </div>

    <!-- Firebase y Leaflet JS -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDT85qotm1EpAJzJzCFeoNwGyo-VKhM6dk",
            authDomain: "gpsaccionascl2025.firebaseapp.com",
            databaseURL: "https://gpsaccionascl2025-default-rtdb.firebaseio.com",
            projectId: "gpsaccionascl2025",
            storageBucket: "gpsaccionascl2025.appspot.com",
            messagingSenderId: "742246618721",
            appId: "1:742246618721:web:72d0046987416800f07c20"
        };

        // Inicializa Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Configuraci√≥n del mapa
        const SCL_COORDS = [-33.3931, -70.7858];
        const INACTIVE_COORDS = [-33.409995, -70.788647];
        const ZOOM_INICIAL = 14;
        let map;
        let currentTileLayer;
        const markers = {};
        const lastUpdateTimes = {};
        let gpsInterval;
        let wakeLock = null;
        let backgroundGeolocationWatchId = null;
        const TEN_MINUTES = 10 * 60 * 1000;
        let currentUserId = null;
        let isViewer = false;
        let userPositionMarker = null;
        let userAccuracyCircle = null;
        let lastKnownPosition = null;
        let locationUpdateInterval = null;
        
        // Proveedores de mapas alternativos (soluci√≥n al problema de User-Agent)
        const mapProviders = {
            esri: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            },
            carto: {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            },
            osm: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }
        };
        
        // Verificar autenticaci√≥n al cargar
        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                if (!auth) window.location.href = 'login.html';
                
                currentUserId = auth.username;
                isViewer = auth.isViewer;
                
                initMap();
                setupUI();
                
                // Mostrar solo la ubicaci√≥n del usuario actual
                document.getElementById('current-user-name').textContent = currentUserId;
                
                // Si es viewer, mostrar todos los veh√≠culos
                if (isViewer) {
                    document.getElementById('other-vehicles-container').style.display = 'block';
                    initializeAllMarkers();
                    startMonitoring();
                } else {
                    // Si es funcionario, mostrar solo su ubicaci√≥n
                    initializeCurrentUserMarker();
                    
                    // Iniciar seguimiento GPS para el usuario actual
                    startGPSTracking(currentUserId);
                }
            }
        });
        
        function initMap() {
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            
            // Cargar el proveedor de mapas guardado o usar ESRI por defecto
            const savedProvider = localStorage.getItem('mapProvider') || 'esri';
            document.getElementById('mapProvider').value = savedProvider;
            setMapProvider(savedProvider);
            
            // Marcador del aeropuerto
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('‚úàÔ∏è Aeropuerto SCL')
                .openPopup();
                
            // Crear marcador para la posici√≥n del usuario
            createUserPositionMarker(SCL_COORDS);
        }
        
        function setMapProvider(providerKey) {
            // Eliminar la capa actual si existe
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            // Obtener la configuraci√≥n del proveedor
            const provider = mapProviders[providerKey];
            
            // A√±adir la nueva capa
            currentTileLayer = L.tileLayer(provider.url, {
                attribution: provider.attribution,
                maxZoom: provider.maxZoom
            }).addTo(map);
            
            // Guardar la preferencia
            localStorage.setItem('mapProvider', providerKey);
        }
        
        function setupUI() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            const panel = document.getElementById('controlPanel');
            const toggleBtn = document.getElementById('togglePanel');
            
            toggleBtn.addEventListener('click', function() {
                panel.classList.toggle('visible');
            });
            
            // Configurar bot√≥n de actualizaci√≥n
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', function() {
                refreshBtn.classList.add('loading');
                
                setTimeout(() => {
                    const isPanelVisible = panel.classList.contains('visible');
                    localStorage.setItem('panelState', isPanelVisible ? 'open' : 'closed');
                    
                    window.location.reload();
                }, 500);
            });
            
            // Configurar selector de proveedor de mapas
            document.getElementById('mapProvider').addEventListener('change', function(e) {
                setMapProvider(e.target.value);
            });
            
            // Configurar bot√≥n de forzar ubicaci√≥n
            document.getElementById('forceLocationBtn').addEventListener('click', function() {
                forceLocationUpdate();
            });
            
            // Configurar bot√≥n de emergencia para centrar en ubicaci√≥n
            document.getElementById('emergencyLocateBtn').addEventListener('click', function() {
                centerOnUserLocation();
            });
            
            // Configurar botones para mostrar/ocultar diagn√≥stico
            document.getElementById('hideDiagnosticBtn').addEventListener('click', function() {
                document.getElementById('diagnosticPanel').classList.add('hidden');
                document.getElementById('showDiagnosticBtn').style.display = 'flex';
            });
            
            document.getElementById('showDiagnosticBtn').addEventListener('click', function() {
                document.getElementById('diagnosticPanel').classList.remove('hidden');
                document.getElementById('showDiagnosticBtn').style.display = 'none';
            });
            
            // Al cargar la p√°gina, verificar si el panel debe estar abierto o cerrado
            const savedPanelState = localStorage.getItem('panelState');
            if (savedPanelState === 'open') {
                panel.classList.add('visible');
            }
            
            // Detectar cambios de visibilidad de la p√°gina
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            // Detectar eventos de bloqueo/desbloqueo de pantalla
            if ('wakeLock' in navigator) {
                document.addEventListener('visibilitychange', async () => {
                    if (document.visibilityState === 'visible') {
                        await requestWakeLock();
                    }
                });
            }
        }
        
        function handleVisibilityChange() {
            const notification = document.getElementById('statusNotification');
            if (document.visibilityState === 'visible') {
                notification.textContent = 'Aplicaci√≥n en primer plano';
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 3000);
                
                // Reforzar la obtenci√≥n de ubicaci√≥n cuando la app vuelve a primer plano
                if (!isViewer) {
                    forceLocationUpdate();
                }
            } else {
                notification.textContent = 'Aplicaci√≥n en segundo plano - El GPS sigue activo';
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 3000);
            }
        }
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock activado para evitar que la pantalla se apague');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock liberado');
                    });
                }
            } catch (err) {
                console.error('Error activando Wake Lock:', err);
            }
        }
        
        function initializeAllMarkers() {
            const mobileIds = ['Movil1', 'Movil2', 'Movil3', 'Movil4'];
            
            mobileIds.forEach(mobileId => {
                createMarker(mobileId, INACTIVE_COORDS, false);
                lastUpdateTimes[mobileId] = Date.now();
            });
        }
        
        function initializeCurrentUserMarker() {
            createMarker(currentUserId, INACTIVE_COORDS, false);
            lastUpdateTimes[currentUserId] = Date.now();
        }
        
        function createUserPositionMarker(coords) {
            // Eliminar marcador existente si hay uno
            if (userPositionMarker) {
                map.removeLayer(userPositionMarker);
            }
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            
            // Crear un icono personalizado para la posici√≥n del usuario
            const userIcon = L.divIcon({
                className: 'user-position-marker',
                html: `
                    <div style="background-color: #3498db; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
                    <div class="pulse-circle"></div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            // Crear el marcador
            userPositionMarker = L.marker(coords, { icon: userIcon, zIndexOffset: 1000 })
                .addTo(map)
                .bindPopup('<b>Tu ubicaci√≥n actual</b>');
                
            // Centrar el mapa en la ubicaci√≥n del usuario
            map.setView(coords, 16);
        }
        
        function updateUserPositionMarker(coords, accuracy) {
            if (!userPositionMarker) {
                createUserPositionMarker(coords);
            } else {
                userPositionMarker.setLatLng(coords);
            }
            
            // Actualizar c√≠rculo de precisi√≥n
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            
            if (accuracy && accuracy < 1000) { // Solo mostrar si la precisi√≥n es razonable
                userAccuracyCircle = L.circle(coords, {
                    radius: accuracy,
                    className: 'accuracy-circle'
                }).addTo(map);
            }
            
            // Actualizar coordenadas en el panel
            document.getElementById('current-user-coords').textContent = 
                `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
                
            // Actualizar diagn√≥stico
            document.getElementById('accuracyValue').textContent = 
                accuracy ? `${accuracy.toFixed(1)} metros` : 'Desconocida';
            document.getElementById('lastUpdateValue').textContent = new Date().toLocaleTimeString();
        }
        
        function startGPSTracking(mobileId) {
            if (gpsInterval) clearInterval(gpsInterval);
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            
            // Solicitar Wake Lock para evitar que la pantalla se apague
            requestWakeLock();
            
            // Iniciar seguimiento de ubicaci√≥n inmediatamente
            updatePosition(mobileId);
            
            // Configurar intervalo de actualizaci√≥n de ubicaci√≥n
            locationUpdateInterval = setInterval(() => {
                updatePosition(mobileId);
            }, 5000);
            
            // Configurar seguimiento de geolocalizaci√≥n en segundo plano
            setupBackgroundGeolocation(mobileId);
            
            // Forzar una actualizaci√≥n adicional despu√©s de 2 segundos
            setTimeout(() => updatePosition(mobileId), 2000);
        }
        
        function setupBackgroundGeolocation(mobileId) {
            // Usar la API de Geolocalizaci√≥n con configuraciones para segundo plano
            if ('geolocation' in navigator) {
                const geoOptions = {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                };
                
                // Iniciar watchPosition para obtener actualizaciones continuas
                if (backgroundGeolocationWatchId !== null) {
                    navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
                }
                
                backgroundGeolocationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = [
                            position.coords.latitude,
                            position.coords.longitude
                        ];
                        const accuracy = position.coords.accuracy;
                        
                        updateDiagnostic('good', 'watchPosition', accuracy);
                        savePosition(mobileId, coords, accuracy);
                    },
                    (error) => {
                        console.error('Error en watchPosition:', error);
                        updateDiagnostic('bad', `Error: ${getGeolocationErrorText(error)}`);
                        updateStatus(mobileId, 'offline');
                    },
                    geoOptions
                );
            } else {
                updateDiagnostic('bad', 'Geolocalizaci√≥n no soportada');
            }
        }
        
        function updatePosition(mobileId) {
            if (navigator.geolocation) {
                // M√©todo 1: getCurrentPosition con timeout corto
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const coords = [
                            position.coords.latitude,
                            position.coords.longitude
                        ];
                        const accuracy = position.coords.accuracy;
                        
                        updateDiagnostic('good', 'getCurrentPosition', accuracy);
                        savePosition(mobileId, coords, accuracy);
                    },
                    error => {
                        console.error('Error GPS con getCurrentPosition:', error);
                        
                        // M√©todo 2: Intentar con opciones menos estrictas
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                const coords = [
                                    position.coords.latitude,
                                    position.coords.longitude
                                ];
                                const accuracy = position.coords.accuracy;
                                
                                updateDiagnostic('warning', 'M√©todo alternativo', accuracy);
                                savePosition(mobileId, coords, accuracy);
                            },
                            error2 => {
                                console.error('Error GPS con m√©todo alternativo:', error2);
                                updateDiagnostic('bad', `Error: ${getGeolocationErrorText(error2)}`);
                                updateStatus(mobileId, 'offline');
                                
                                // M√©todo 3: Usar √∫ltima posici√≥n conocida si est√° disponible
                                if (lastKnownPosition) {
                                    updateDiagnostic('warning', 'Usando √∫ltima posici√≥n conocida');
                                    savePosition(mobileId, lastKnownPosition, 1000);
                                }
                            },
                            { 
                                enableHighAccuracy: false,
                                timeout: 15000,
                                maximumAge: 300000  // 5 minutos
                            }
                        );
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateDiagnostic('bad', 'Geolocalizaci√≥n no soportada');
                alert("Tu navegador no soporta geolocalizaci√≥n");
            }
        }
        
        function forceLocationUpdate() {
            if (!currentUserId) return;
            
            updateDiagnostic('warning', 'Forzando actualizaci√≥n...');
            
            // Intentar con diferentes m√©todos
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = [
                        position.coords.latitude,
                        position.coords.longitude
                    ];
                    const accuracy = position.coords.accuracy;
                    
                    updateDiagnostic('good', 'Forzado exitoso', accuracy);
                    savePosition(currentUserId, coords, accuracy);
                    
                    // Mostrar notificaci√≥n
                    showNotification('Ubicaci√≥n actualizada forzosamente', 3000);
                },
                error => {
                    updateDiagnostic('bad', `Forzado fallido: ${getGeolocationErrorText(error)}`);
                    showNotification('Error al forzar ubicaci√≥n', 3000);
                },
                { 
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 0
                }
            );
        }
        
        function centerOnUserLocation() {
            if (lastKnownPosition) {
                map.setView(lastKnownPosition, 16);
                showNotification('Centrado en tu ubicaci√≥n', 2000);
            } else {
                updatePosition(currentUserId);
                showNotification('Buscando tu ubicaci√≥n...', 2000);
            }
        }
        
        function getGeolocationErrorText(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return "Permiso denegado";
                case error.POSITION_UNAVAILABLE:
                    return "Posici√≥n no disponible";
                case error.TIMEOUT:
                    return "Tiempo agotado";
                default:
                    return "Error desconocido";
            }
        }
        
        function updateDiagnostic(status, method, accuracy = null) {
            const statusElement = document.getElementById('gpsStatus');
            const methodElement = document.getElementById('methodValue');
            
            statusElement.textContent = status === 'good' ? 'ACTIVO' : 
                                      status === 'warning' ? 'LIMITADO' : 'INACTIVO';
            statusElement.className = `diagnostic-value ${status}`;
            
            methodElement.textContent = method;
            
            if (accuracy !== null) {
                document.getElementById('accuracyValue').textContent = `${accuracy.toFixed(1)} metros`;
            }
            
            document.getElementById('lastUpdateValue').textContent = new Date().toLocaleTimeString();
            
            // Actualizar indicador principal
            const locationStatus = document.getElementById('locationStatus');
            if (status === 'good') {
                locationStatus.textContent = 'Ubicaci√≥n activa';
                locationStatus.style.color = 'green';
            } else if (status === 'warning') {
                locationStatus.textContent = 'Ubicaci√≥n limitada';
                locationStatus.style.color = 'orange';
            } else {
                locationStatus.textContent = 'Ubicaci√≥n inactiva';
                locationStatus.style.color = 'red';
            }
        }
        
        function showNotification(message, duration) {
            const notification = document.getElementById('statusNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, duration);
        }
        
        function savePosition(mobileId, coords, accuracy) {
            const now = Date.now();
            
            // Guardar √∫ltima posici√≥n conocida
            lastKnownPosition = coords;
            
            // Actualizar marcador de usuario
            updateUserPositionMarker(coords, accuracy);
            
            // Solo guardar en Firebase si no es viewer
            if (!isViewer) {
                database.ref(`vehicles/${mobileId}`).set({
                    coords: {
                        lat: coords[0],
                        lng: coords[1]
                    },
                    status: 'online',
                    lastUpdate: now,
                    accuracy: accuracy
                });
            }
            
            lastUpdateTimes[mobileId] = now;
            updateMarker(mobileId, coords, true);
            updateStatus(mobileId, 'online');
            
            // Si es el usuario actual, centrar el mapa en su ubicaci√≥n
            if (mobileId === currentUserId) {
                map.setView(coords, Math.max(map.getZoom(), 16));
            }
        }
        
        function startMonitoring() {
            setInterval(checkConnectionStatus, 60000);
            
            database.ref('vehicles').on('value', (snapshot) => {
                const vehiclesData = snapshot.val() || {};
                
                Object.keys(vehiclesData).forEach(mobileId => {
                    const vehicle = vehiclesData[mobileId];
                    if (vehicle && vehicle.coords) {
                        const now = Date.now();
                        lastUpdateTimes[mobileId] = vehicle.lastUpdate || now;
                        
                        const isOnline = (now - (vehicle.lastUpdate || 0)) < TEN_MINUTES;
                        const coords = isOnline ? 
                            [vehicle.coords.lat, vehicle.coords.lng] : 
                            INACTIVE_COORDS;
                        
                        updateMarker(mobileId, coords, isOnline);
                        updateStatus(mobileId, isOnline ? 'online' : 'offline');
                    }
                });
            });
        }
        
        function checkConnectionStatus() {
            const now = Date.now();
            Object.keys(lastUpdateTimes).forEach(mobileId => {
                const lastUpdate = lastUpdateTimes[mobileId] || 0;
                if ((now - lastUpdate) > TEN_MINUTES) {
                    updateStatus(mobileId, 'offline');
                    if (markers[mobileId]) {
                        const icon = L.divIcon({
                            className: 'vehicle-marker offline',
                            html: `
                                <div class="vehicle-marker offline"></div>
                                <div class="vehicle-label">${mobileId}</div>
                            `,
                            iconSize: [32, 42],
                            iconAnchor: [16, 16],
                            popupAnchor: [0, -16]
                        });
                        markers[mobileId]
                            .setIcon(icon)
                            .setLatLng(INACTIVE_COORDS)
                            .setPopupContent(`<b>${mobileId}</b><br>Desconectado<br>√öltima actualizaci√≥n: ${new Date(lastUpdate).toLocaleTimeString()}`);
                    }
                }
            });
        }
        
        function createMarker(mobileId, coords, isOnline) {
            if (markers[mobileId]) return;
            
            const container = L.divIcon({
                className: 'vehicle-marker-container',
                html: `
                    <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                    <div class="vehicle-label">${mobileId}</div>
                `,
                iconSize: [32, 42],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });

            markers[mobileId] = L.marker(coords, { 
                icon: container,
                title: mobileId
            }).addTo(map)
            .bindPopup(`<b>${mobileId}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}`);
        }
        
        function updateMarker(mobileId, coords, isOnline) {
            if (!markers[mobileId]) {
                createMarker(mobileId, coords, isOnline);
            } else {
                const container = L.divIcon({
                    className: 'vehicle-marker-container',
                    html: `
                        <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                        <div class="vehicle-label">${mobileId}</div>
                    `,
                    iconSize: [32, 42],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });

                markers[mobileId]
                    .setLatLng(coords)
                    .setIcon(container)
                    .setPopupContent(`<b>${mobileId}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}<br>√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`);
            }
        }
        
        function updateStatus(mobileId, status) {
            // Actualizar estado del usuario actual
            if (mobileId === currentUserId) {
                const element = document.getElementById('current-user-status');
                const iconElement = document.getElementById('current-user-icon');
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            } 
            // Solo actualizar otros veh√≠culos si es viewer
            else if (isViewer) {
                const element = document.getElementById(`${mobileId.toLowerCase()}-status`);
                const iconElement = document.getElementById(`${mobileId.toLowerCase()}-icon`);
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            }
        }
        
        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            if (backgroundGeolocationWatchId !== null) {
                navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
            }
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                });
            }
            database.ref('vehicles').off();
            firebase.auth().signOut();
            localStorage.removeItem('gpsAuth');
            localStorage.removeItem('panelState');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
