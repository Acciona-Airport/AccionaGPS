<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f44336">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
            --user-position-color: #3498db;
            --blue-primary: #2196f3;
            --blue-light: #e3f2fd;
            --blue-dark: #1976d2;
            --route1-color: #e74c3c;
            --route2-color: #9b59b6;
            --dashboard-bg: #f8f9fa;
            --dashboard-card: #ffffff;
            --dashboard-text: #333333;
            --dashboard-border: #e0e0e0;
            --shift1-color: #3498db;
            --shift2-color: #9b59b6;
            --shift3-color: #e67e22;
            --transparency: 0.45;
            
            /* Colores para √≠ndices UV */
            --uv-low: #27ae60;
            --uv-moderate: #f39c12;
            --uv-high: #e67e22;
            --uv-very-high: #e74c3c;
            --uv-extreme: #9b59b6;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background-color: #2c3e50;
            touch-action: pan-x pan-y;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        .weather-widget {
            position: fixed;
            top: 120px; 
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .weather-widget.expanded {
            border-radius: 12px;
            width: auto;
            height: auto;
            min-width: 220px;
            padding: 15px;
        }
        .weather-icon {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            transition: all 0.3s ease;
        }
        .weather-widget.expanded .weather-icon {
            margin-right: 12px;
        }
        .weather-info {
            display: none;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .weather-widget.expanded .weather-info {
            display: flex;
            opacity: 1;
        }
        .weather-temp {
            font-size: 18px;
            font-weight: bold;
            color: #000;
            margin-bottom: 4px;
        }
        .weather-desc {
            font-size: 12px;
            color: #000;
            margin-bottom: 4px;
            text-transform: capitalize;
        }
        .weather-location {
            font-size: 10px;
            color: #000;
            margin-top: 2px;
            font-weight: 500;
        }
        .weather-updating {
            font-size: 9px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
        }
        .weather-feels-like {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        .weather-uv {
            display: flex;
            align-items: center;
            margin-top: 8px;
            padding: 5px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }
        .uv-low {
            background-color: rgba(39, 174, 96, 0.2);
            color: var(--uv-low);
        }
        .uv-moderate {
            background-color: rgba(243, 156, 18, 0.2);
            color: var(--uv-moderate);
        }
        .uv-high {
            background-color: rgba(230, 126, 34, 0.2);
            color: var(--uv-high);
        }
        .uv-very-high {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--uv-very-high);
        }
        .uv-extreme {
            background-color: rgba(155, 89, 182, 0.2);
            color: var(--uv-extreme);
        }
        .weather-warning {
            margin-top: 8px;
            padding: 6px;
            border-radius: 4px;
            font-size: 10px;
            background-color: rgba(231, 76, 60, 0.2);
            color: #d32f2f;
            display: none;
        }
        .weather-sources {
            font-size: 9px;
            color: #666;
            margin-top: 8px;
            border-top: 1px solid #eee;
            padding-top: 8px;
        }
        .weather-loading {
            display: none;
            font-size: 10px;
            color: #666;
            margin-top: 5px;
        }
        .weather-widget.loading .weather-loading {
            display: block;
        }
    
        @media (min-width: 768px) {
            .weather-widget {
                top: 130px; 
                left: 15px; 
            }
        }

        /* Resto del CSS se mantiene igual */
        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
            pointer-events: none;
        }
        .control-panel {
            background: rgba(255,255,255,var(--transparency));
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }
        .toggle-panel {
            background: rgba(255,255,255,var(--transparency));
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
            margin-left: 5px;
            flex-shrink: 0;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
            height: 16px;
        }
        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: #000000;
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: var(--online-color); }
        .offline { color: #000000; }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        .diagnostic-panel-container {
            display: none;
        }
        .user-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
        }
        .user-icon.online {
            background-color: var(--online-color);
        }
        .user-icon.offline {
            background-color: var(--offline-color);
            opacity: 0.7;
        }
        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
        }
        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }
        .refresh-container {
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }
        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.2s;
            pointer-events: auto;
        }
        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .map-provider-selector {
            position: fixed;
            bottom: 57px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 6px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 10px;
            backdrop-filter: blur(5px);
        }
       .map-provider-selector select {
    padding: 5px;
    border-radius: 3px;
    border: none;
    background-color: transparent;
}
        .status-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            font-size: 14px;
        }
        .current-user-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: #000000;
            backdrop-filter: blur(5px);
        }
       
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
        .emergency-locate-btn {
            position: fixed;
            bottom: 20px;
            right: 15px;
            z-index: 1000;
            background: rgba(52, 152, 219, 0.7);
            color: white;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .accuracy-circle {
            fill: rgba(52, 152, 219, 0.2);
            stroke: rgba(52, 152, 219, 0.5);
            stroke-width: 1;
        }
        .leaflet-control-zoom {
            margin-top: 80px !important;
        }
        .leaflet-bar a {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            font-size: 18px !important;
            background: rgba(255, 255, 255, var(--transparency)) !important;
            backdrop-filter: blur(5px);
        }
        .leaflet-container {
            touch-action: manipulation;
        }
        .map-touch-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 100%;
            z-index: 999;
            display: none;
        }
        .control-panel.visible ~ .map-touch-overlay {
            display: block;
        }
        .route-selector {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 6px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 10px;
            backdrop-filter: blur(5px);
        }
       .route-selector select {
    padding: 5px;
    border-radius: 3px;
    border: none;
    margin-top: 5px;
    width: 100%;
    background-color: transparent;
}
        
        .leaflet-bottom.leaflet-right {
            bottom: 160px;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        
        .vehicle-number-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .vehicle-number-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .vehicle-number-form h2 {
            color: var(--red-dark);
            margin-bottom: 20px;
        }
        .vehicle-number-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
        }
        .vehicle-number-input:focus {
            border-color: var(--red-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }
        .vehicle-number-submit {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .vehicle-number-submit:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        .admin-dashboard {
    display: none;
    background: rgba(255, 255, 255, var(--transparency));
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
    box-shadow: none;
    border: none;
}
        .admin-dashboard h4 {
            color: var(--red-dark);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--dashboard-border);
        }
        .dashboard-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--dashboard-border);
        }
        .dashboard-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .dashboard-tab.active {
            border-bottom-color: var(--red-primary);
            color: var(--red-dark);
        }
        .dashboard-content {
            display: none;
        }
        .dashboard-content.active {
            display: block;
        }
        .lap-counter {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--dashboard-bg);
            border-radius: 6px;
        }
        .lap-counter h5 {
            margin: 0 0 8px 0;
            color: var(--dashboard-text);
            font-size: 14px;
        }
        .lap-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .lap-stat {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            background: var(--dashboard-card);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .lap-stat.shift1 {
            border-top: 3px solid var(--shift1-color);
        }
        .lap-stat.shift2 {
            border-top: 3px solid var(--shift2-color);
        }
        .lap-stat.shift3 {
            border-top: 3px solid var(--shift3-color);
        }
        .lap-count {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .lap-label {
        font-size: 11px;
        color: black;
        }
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .metric-card {
            padding: 10px;
            background: var(--dashboard-bg);
            border-radius: 6px;
            text-align: center;
        }
        .metric-value {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
        
        
        .download-btn {
            background: var(--blue-primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
        }
        .download-btn:hover {
            background: var(--blue-dark);
        }
        #locationStatus {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 18px;
        }
        .export-excel-btn {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .export-excel-btn:hover {
            background: #27ae60;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-touch-overlay" id="mapTouchOverlay"></div>
    
    <!-- Widget de clima mejorado -->
    <div class="weather-widget" id="weatherWidget">
        <div class="weather-icon" id="weatherIcon">üå°Ô∏è</div>
        <div class="weather-info">
            <div class="weather-temp" id="weatherTemp">--¬∞C</div>
            <div class="weather-desc" id="weatherDesc">Cargando datos...</div>
            <div class="weather-feels-like" id="weatherFeelsLike">Sensaci√≥n: --¬∞C</div>
            <div class="weather-uv" id="weatherUv">
                <span>√çndice UV: --</span>
            </div>
            <div class="weather-warning" id="weatherWarning"></div>
            <div class="weather-location">Pudahuel, Santiago</div>
            <div class="weather-updating" id="weatherUpdating"></div>
            <div class="weather-sources" id="weatherSources">Fuente: Open-Meteo</div>
        </div>
        <div class="weather-loading">Actualizando datos...</div>
    </div>
    
    <div class="status-notification" id="statusNotification"></div>
    
    <div class="current-user-indicator" id="currentUserIndicator">
        <span id="locationStatus">Buscando tu ubicaci√≥n...</span>
    </div>

    <div class="diagnostic-panel-container">
        <div class="diagnostic-panel" id="diagnosticPanel">
            <h3 style="margin-top:0;color:var(--blue-dark);">üìä Diagn√≥stico GPS</h3>
            
            <div class="diagnostic-info">
                <div class="diagnostic-item">
                    <span>Estado GPS:</span>
                    <span id="gpsStatus" class="diagnostic-value warning">Comprobando...</span>
                </div>
                <div class="diagnostic-item">
                    <span>Precisi√≥n:</span>
                    <span id="accuracyValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>√öltima actualizaci√≥n:</span>
                    <span id="lastUpdateValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>M√©todo:</span>
                    <span id="methodValue" class="diagnostic-value">--</span>
                </div>
            </div>
            
            <button id="forceLocationBtn" style="margin-top: 15px; width: 100%; padding: 8px; background: var(--blue-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Forzar Ubicaci√≥n
            </button>
        </div>
        
        <button class="toggle-diagnostic-panel" id="toggleDiagnosticPanel">
            <div class="diagnostic-hamburger-icon">
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="route-selector">
        <label for="routeSelector">Ruta:</label>
        <select id="routeSelector">
            <option value="none">Sin ruta</option>
            <option value="route1">Ruta 1</option>
            <option value="route2">Ruta 2</option>
        </select>
    </div>

    <button class="emergency-locate-btn" id="emergencyLocateBtn" title="Centrar en mi ubicaci√≥n">üë§</button>

    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);">üöê Flota Acciona</h3>
            
            <div class="admin-dashboard" id="adminDashboard">
                <h4>üìä Dashboard Administrador</h4>
                
                <div class="dashboard-tabs">
                    <div class="dashboard-tab active" data-tab="laps">Vueltas</div>
                    <div class="dashboard-tab" data-tab="metrics">Data</div>
                    <div class="dashboard-tab" data-tab="performance">Global</div>
                </div>
                
                <div class="dashboard-content active" id="lapsContent">
                    <div class="lap-counter" id="movil1Laps">
                        <h5>M√≥vil 1</h5>
                        <div class="lap-stats">
                            <div class="lap-stat shift1">
                                <div class="lap-count" id="movil1Shift1">0</div>
                                <div class="lap-label">06:00 - 13:00</div>
                            </div>
                            <div class="lap-stat shift2">
                                <div class="lap-count" id="movil1Shift2">0</div>
                                <div class="lap-label">13:00 - 22:00</div>
                            </div>
                            <div class="lap-stat shift3">
                                <div class="lap-count" id="movil1Shift3">0</div>
                                <div class="lap-label">22:00 - 06:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lap-counter" id="movil2Laps">
                        <h5>M√≥vil 2</h5>
                        <div class="lap-stats">
                            <div class="lap-stat shift1">
                                <div class="lap-count" id="movil2Shift1">0</div>
                                <div class="lap-label">06:00 - 13:00</div>
                            </div>
                            <div class="lap-stat shift2">
                                <div class="lap-count" id="movil2Shift2">0</div>
                                <div class="lap-label">13:00 - 22:00</div>
                            </div>
                            <div class="lap-stat shift3">
                                <div class="lap-count" id="movil2Shift3">0</div>
                                <div class="lap-label">22:00 - 06:00</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-content" id="metricsContent">
                    <div class="dashboard-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="totalDistance">0 km</div>
                            <div class="metric-label">Distancia Total</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avgSpeed">0 km/h</div>
                            <div class="metric-label">Velocidad Promedio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="totalVehicles">0</div>
                            <div class="metric-label">Veh√≠culos Activos</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="uptime">0%</div>
                            <div class="metric-label">Tiempo Activo</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-content" id="performanceContent">
                    <div class="metric-card">
                        <div class="metric-value" id="totalLaps">0</div>
                        <div class="metric-label">Total de Vueltas</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="fuelEfficiency">0 L/100km</div>
                        <div class="metric-label">Eficiencia de Combustible</div>
                    </div>
                </div>
                
                <button class="download-btn" id="downloadReportBtn">
                    <span>üì• Descargar Reporte</span>
                </button>
            </div>
            
            <div id="vehiclesList"></div>
            
            <button class="export-excel-btn" id="exportExcelBtn">
                <span>üìä Exportar a Excel</span>
            </button>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
        
        <div class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </div>
    </div>

    <div class="refresh-container">
        <button class="refresh-btn" id="refreshBtn">
            <span class="refresh-icon">üîÑ</span>
            <span>Actualizar</span>
        </button>
    </div>

    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="osm">OpenStreetMap</option>
            <option value="satellite">Sat√©lite</option>
            <option value="dark">Oscuro</option>
        </select>
    </div>

    <div class="vehicle-number-modal" id="vehicleNumberModal" style="display:none;">
        <div class="vehicle-number-form">
            <h2>Ingresa tu n√∫mero de veh√≠culo</h2>
            <input type="text" class="vehicle-number-input" id="vehicleNumberInput" placeholder="Ej: 101" maxlength="10">
            <button class="vehicle-number-submit" id="vehicleNumberSubmit">Confirmar</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuraci√≥n inicial
        let map;
        let userMarker;
        let accuracyCircle;
        let vehicleMarkers = {};
        let routeLayers = {
            route1: null,
            route2: null
        };
        let currentRoute = 'none';
        let watchId = null;
        let lastPosition = null;
        let vehicles = {};
        let currentUserVehicle = null;
        let isAdmin = false;
        let mapProviders = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CartoDB'
            })
        };
        let currentMapProvider = 'osm';
        let adminDashboardVisible = false;
        let lapCounters = {
            movil1: { shift1: 0, shift2: 0, shift3: 0 },
            movil2: { shift1: 0, shift2: 0, shift3: 0 }
        };
        let diagnosticPanelVisible = false;
        let lastWeatherUpdate = null;
        let weatherData = null;

        // Inicializar el mapa
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                minZoom: 10,
                maxZoom: 19
            }).setView([-33.4569, -70.6483], 13);
            
            // A√±adir el proveedor de mapa inicial
            mapProviders.osm.addTo(map);
            
            // A√±adir control de zoom
            L.control.zoom({
                position: 'topleft'
            }).addTo(map);
            
            // A√±adir capa para mostrar la precisi√≥n
            accuracyCircle = L.circle([0, 0], {
                color: 'blue',
                fillColor: '#3388ff',
                fillOpacity: 0.2,
                radius: 0
            }).addTo(map);
            
            // Cargar rutas
            loadRoutes();
            
            // Centrar en la ubicaci√≥n del usuario
            locateUser();
        }

        // Funci√≥n para cargar las rutas
        function loadRoutes() {
            // Ruta 1 - Pudahuel Centro
            const route1Coordinates = [
                [-33.4434, -70.7146], // Inicio
                [-33.4389, -70.7092],
                [-33.4345, -70.7038],
                [-33.4300, -70.6984],
                [-33.4255, -70.6930],
                [-33.4210, -70.6876],
                [-33.4165, -70.6822],
                [-33.4120, -70.6768],
                [-33.4075, -70.6714],
                [-33.4030, -70.6660]  // Fin
            ];
            
            // Ruta 2 - Pudahuel Periferia
            const route2Coordinates = [
                [-33.4434, -70.7146], // Inicio
                [-33.4480, -70.7200],
                [-33.4525, -70.7254],
                [-33.4570, -70.7308],
                [-33.4615, -70.7362],
                [-33.4660, -70.7416],
                [-33.4705, -70.7470],
                [-33.4750, -70.7524],
                [-33.4795, -70.7578],
                [-33.4840, -70.7632]  // Fin
            ];
            
            // Crear polil√≠neas para las rutas
            routeLayers.route1 = L.polyline(route1Coordinates, {
                color: '#e74c3c',
                weight: 4,
                opacity: 0.7
            });
            
            routeLayers.route2 = L.polyline(route2Coordinates, {
                color: '#9b59b6',
                weight: 4,
                opacity: 0.7
            });
        }

        // Funci√≥n para cambiar el proveedor de mapas
        function changeMapProvider(provider) {
            // Remover el proveedor actual
            map.eachLayer(layer => {
                if (layer instanceof L.TileLayer) {
                    map.removeLayer(layer);
                }
            });
            
            // A√±adir el nuevo proveedor
            mapProviders[provider].addTo(map);
            
            // Restaurar otras capas
            if (userMarker) map.addLayer(userMarker);
            if (accuracyCircle) map.addLayer(accuracyCircle);
            
            // Restaurar marcadores de veh√≠culos
            Object.values(vehicleMarkers).forEach(marker => {
                map.addLayer(marker);
            });
            
            // Restaurar ruta actual si existe
            if (currentRoute !== 'none' && routeLayers[currentRoute]) {
                map.addLayer(routeLayers[currentRoute]);
            }
            
            currentMapProvider = provider;
        }

        // Funci√≥n para centrar en la ubicaci√≥n del usuario
        function locateUser() {
            if (!navigator.geolocation) {
                showNotification('La geolocalizaci√≥n no es soportada por tu navegador', 'error');
                return;
            }
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
            }
            
            watchId = navigator.geolocation.watchPosition(
                position => {
                    const { latitude, longitude, accuracy } = position.coords;
                    const timestamp = new Date(position.timestamp);
                    
                    // Actualizar la ubicaci√≥n del usuario
                    updateUserPosition(latitude, longitude, accuracy, timestamp);
                    
                    // Actualizar el estado de ubicaci√≥n
                    updateLocationStatus('online', `Ubicaci√≥n actualizada ${formatTime(timestamp)}`);
                },
                error => {
                    console.error('Error obteniendo ubicaci√≥n:', error);
                    let errorMsg = 'Error desconocido al obtener ubicaci√≥n';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Permiso de ubicaci√≥n denegado';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Informaci√≥n de ubicaci√≥n no disponible';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Tiempo de espera agotado para obtener ubicaci√≥n';
                            break;
                    }
                    
                    updateLocationStatus('offline', errorMsg);
                    showNotification(errorMsg, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                }
            );
        }

        // Funci√≥n para actualizar la posici√≥n del usuario
        function updateUserPosition(lat, lng, accuracy, timestamp) {
            const position = [lat, lng];
            
            // Crear o actualizar marcador del usuario
            if (!userMarker) {
                userMarker = L.marker(position, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div class="user-icon online"></div>',
                        iconSize: [36, 36],
                        iconAnchor: [18, 18]
                    }),
                    zIndexOffset: 1000
                }).addTo(map);
                
                // A√±adir tooltip
                userMarker.bindTooltip('Tu ubicaci√≥n', {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -18]
                });
            } else {
                userMarker.setLatLng(position);
            }
            
            // Actualizar c√≠rculo de precisi√≥n
            accuracyCircle.setLatLng(position);
            accuracyCircle.setRadius(accuracy);
            
            // Centrar mapa en la ubicaci√≥n del usuario (solo si es la primera vez o si el usuario lo solicita)
            if (!lastPosition) {
                map.setView(position, 15);
            }
            
            // Guardar √∫ltima posici√≥n
            lastPosition = {
                lat: lat,
                lng: lng,
                accuracy: accuracy,
                timestamp: timestamp
            };
            
            // Actualizar informaci√≥n de diagn√≥stico si es visible
            if (diagnosticPanelVisible) {
                updateDiagnosticInfo(accuracy, timestamp);
            }
            
            // Si el usuario est√° asignado a un veh√≠culo, actualizar la posici√≥n del veh√≠culo
            if (currentUserVehicle) {
                updateVehiclePosition(currentUserVehicle, lat, lng);
            }
        }

        // Funci√≥n para actualizar el estado de ubicaci√≥n
        function updateLocationStatus(status, message) {
            const statusElement = document.getElementById('locationStatus');
            
            statusElement.textContent = message;
            statusElement.className = '';
            
            if (status === 'online') {
                statusElement.classList.add('online');
            } else if (status === 'offline') {
                statusElement.classList.add('offline');
            } else if (status === 'warning') {
                statusElement.classList.add('warning');
            }
        }

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('statusNotification');
            
            notification.textContent = message;
            notification.style.display = 'block';
            notification.className = '';
            
            if (type === 'error') {
                notification.style.background = 'rgba(231, 76, 60, 0.8)';
            } else if (type === 'success') {
                notification.style.background = 'rgba(46, 204, 113, 0.8)';
            } else {
                notification.style.background = 'rgba(0, 0, 0, 0.7)';
            }
            
            // Ocultar notificaci√≥n despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Funci√≥n para formatear la hora
        function formatTime(date) {
            return date.toLocaleTimeString('es-CL', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Funci√≥n para actualizar informaci√≥n de diagn√≥stico
        function updateDiagnosticInfo(accuracy, timestamp) {
            document.getElementById('accuracyValue').textContent = `${accuracy.toFixed(1)}m`;
            document.getElementById('lastUpdateValue').textContent = formatTime(timestamp);
            
            // Simular m√©todo de obtenci√≥n de ubicaci√≥n
            const methods = ['GPS', 'WiFi', 'Celular'];
            const randomMethod = methods[Math.floor(Math.random() * methods.length)];
            document.getElementById('methodValue').textContent = randomMethod;
            
            // Actualizar estado GPS basado en la precisi√≥n
            const gpsStatus = document.getElementById('gpsStatus');
            if (accuracy < 50) {
                gpsStatus.textContent = 'Excelente';
                gpsStatus.className = 'diagnostic-value online';
            } else if (accuracy < 100) {
                gpsStatus.textContent = 'Buena';
                gpsStatus.className = 'diagnostic-value online';
            } else if (accuracy < 200) {
                gpsStatus.textContent = 'Moderada';
                gpsStatus.className = 'diagnostic-value warning';
            } else {
                gpsStatus.textContent = 'Baja';
                gpsStatus.className = 'diagnostic-value offline';
            }
        }

        // Funci√≥n para actualizar la posici√≥n de un veh√≠culo
        function updateVehiclePosition(vehicleId, lat, lng) {
            const position = [lat, lng];
            
            // Si el veh√≠culo ya existe, actualizar su posici√≥n
            if (vehicleMarkers[vehicleId]) {
                vehicleMarkers[vehicleId].setLatLng(position);
                
                // Actualizar la informaci√≥n en el panel de control
                updateVehicleCard(vehicleId, position);
            } else {
                // Crear un nuevo marcador para el veh√≠culo
                const isOnline = true; // Asumimos que est√° online si estamos actualizando su posici√≥n
                
                vehicleMarkers[vehicleId] = L.marker(position, {
                    icon: L.divIcon({
                        className: 'vehicle-marker',
                        html: `<div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                               <div class="vehicle-label">${vehicleId}</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    }),
                    zIndexOffset: 900
                }).addTo(map);
                
                // A√±adir tooltip
                vehicleMarkers[vehicleId].bindTooltip(`Veh√≠culo ${vehicleId}`, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -20]
                });
                
                // A√±adir el veh√≠culo a la lista en el panel de control
                addVehicleCard(vehicleId, position, isOnline);
            }
            
            // Guardar la posici√≥n del veh√≠culo
            if (!vehicles[vehicleId]) {
                vehicles[vehicleId] = {
                    positions: [],
                    lastUpdate: new Date(),
                    online: true
                };
            }
            
            vehicles[vehicleId].positions.push({
                lat: lat,
                lng: lng,
                timestamp: new Date()
            });
            
            vehicles[vehicleId].lastUpdate = new Date();
            vehicles[vehicleId].online = true;
        }

        // Funci√≥n para a√±adir una tarjeta de veh√≠culo al panel de control
        function addVehicleCard(vehicleId, position, isOnline) {
            const vehiclesList = document.getElementById('vehiclesList');
            
            const vehicleCard = document.createElement('div');
            vehicleCard.className = 'vehicle-card';
            vehicleCard.id = `vehicle-${vehicleId}`;
            
            const lastUpdate = new Date();
            const statusClass = isOnline ? 'online' : 'offline';
            const statusText = isOnline ? 'En l√≠nea' : 'Desconectado';
            
            vehicleCard.innerHTML = `
                <div class="vehicle-name">
                    <div class="vehicle-icon ${statusClass}"></div>
                    <span>Veh√≠culo ${vehicleId}</span>
                </div>
                <div class="vehicle-status">
                    <span class="${statusClass}">${statusText}</span>
                    <span>Actualizado: ${formatTime(lastUpdate)}</span>
                </div>
            `;
            
            vehiclesList.appendChild(vehicleCard);
        }

        // Funci√≥n para actualizar la tarjeta de un veh√≠culo
        function updateVehicleCard(vehicleId, position) {
            const vehicleCard = document.getElementById(`vehicle-${vehicleId}`);
            
            if (vehicleCard) {
                const statusElement = vehicleCard.querySelector('.vehicle-status');
                const statusClass = 'online';
                const statusText = 'En l√≠nea';
                
                statusElement.innerHTML = `
                    <span class="${statusClass}">${statusText}</span>
                    <span>Actualizado: ${formatTime(new Date())}</span>
                `;
                
                // Tambi√©n actualizar el icono
                const iconElement = vehicleCard.querySelector('.vehicle-icon');
                iconElement.className = 'vehicle-icon online';
            }
        }

        // Funci√≥n para cambiar la ruta mostrada
        function changeRoute(routeId) {
            // Remover la ruta actual si existe
            if (currentRoute !== 'none' && routeLayers[currentRoute]) {
                map.removeLayer(routeLayers[currentRoute]);
            }
            
            // A√±adir la nueva ruta si no es "none"
            if (routeId !== 'none' && routeLayers[routeId]) {
                map.addLayer(routeLayers[routeId]);
            }
            
            currentRoute = routeId;
        }

        // Funci√≥n para forzar la actualizaci√≥n de ubicaci√≥n
        function forceLocationUpdate() {
            if (navigator.geolocation) {
                document.getElementById('forceLocationBtn').classList.add('loading');
                
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const { latitude, longitude, accuracy } = position.coords;
                        const timestamp = new Date(position.timestamp);
                        
                        updateUserPosition(latitude, longitude, accuracy, timestamp);
                        updateLocationStatus('online', `Ubicaci√≥n forzada ${formatTime(timestamp)}`);
                        
                        document.getElementById('forceLocationBtn').classList.remove('loading');
                        showNotification('Ubicaci√≥n actualizada forzosamente', 'success');
                    },
                    error => {
                        console.error('Error forzando ubicaci√≥n:', error);
                        document.getElementById('forceLocationBtn').classList.remove('loading');
                        showNotification('Error forzando ubicaci√≥n', 'error');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }
        }

        // Funci√≥n para actualizar datos meteorol√≥gicos
        async function updateWeatherData() {
            const weatherWidget = document.getElementById('weatherWidget');
            weatherWidget.classList.add('loading');
            
            try {
                const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=-33.4569&longitude=-70.6483&hourly=temperature_2m,rain,precipitation,snowfall,showers,shortwave_radiation,direct_radiation,visibility&current=temperature_2m,rain,precipitation,is_day,apparent_temperature,wind_speed_10m&timezone=auto');
                weatherData = await response.json();
                
                if (weatherData && weatherData.current) {
                    updateWeatherUI(weatherData);
                    lastWeatherUpdate = new Date();
                    showNotification('Datos meteorol√≥gicos actualizados', 'success');
                } else {
                    throw new Error('Formato de datos inv√°lido');
                }
            } catch (error) {
                console.error('Error obteniendo datos meteorol√≥gicos:', error);
                showNotification('Error actualizando clima', 'error');
            } finally {
                weatherWidget.classList.remove('loading');
            }
        }

        // Funci√≥n para actualizar la UI con datos meteorol√≥gicos
        function updateWeatherUI(data) {
            const current = data.current;
            
            // Actualizar temperatura
            document.getElementById('weatherTemp').textContent = `${current.temperature_2m}¬∞C`;
            
            // Determinar descripci√≥n basada en condiciones
            let description = '';
            if (current.rain > 0 || current.precipitation > 0) {
                description = 'lluvia';
            } else if (current.temperature_2m > 30) {
                description = 'soleado';
            } else if (current.temperature_2m < 10) {
                description = 'fr√≠o';
            } else {
                description = 'parcialmente nublado';
            }
            
            // Actualizar descripci√≥n
            document.getElementById('weatherDesc').textContent = description;
            
            // Actualizar sensaci√≥n t√©rmica
            document.getElementById('weatherFeelsLike').textContent = `Sensaci√≥n: ${current.apparent_temperature}¬∞C`;
            
            // Calcular y actualizar √≠ndice UV basado en radiaci√≥n solar
            const shortwaveRadiation = data.hourly.shortwave_radiation[0] || 0;
            let uvIndex = Math.round(shortwaveRadiation / 25); // Aproximaci√≥n simple
            if (uvIndex < 0) uvIndex = 0;
            if (uvIndex > 11) uvIndex = 11;
            
            const uvElement = document.getElementById('weatherUv');
            uvElement.textContent = `√çndice UV: ${uvIndex}`;
            
            // Aplicar clase seg√∫n el nivel de UV
            uvElement.className = 'weather-uv ';
            if (uvIndex <= 2) {
                uvElement.classList.add('uv-low');
            } else if (uvIndex <= 5) {
                uvElement.classList.add('uv-moderate');
            } else if (uvIndex <= 7) {
                uvElement.classList.add('uv-high');
            } else if (uvIndex <= 10) {
                uvElement.classList.add('uv-very-high');
            } else {
                uvElement.classList.add('uv-extreme');
            }
            
            // Mostrar advertencia si es necesario
            const warningElement = document.getElementById('weatherWarning');
            if (uvIndex > 7) {
                warningElement.textContent = '¬°Alto √≠ndice UV! Prot√©gete del sol.';
                warningElement.style.display = 'block';
            } else {
                warningElement.style.display = 'none';
            }
            
            // Actualizar icono basado en condiciones
            const weatherIcon = document.getElementById('weatherIcon');
            if (current.rain > 0 || current.precipitation > 0) {
                weatherIcon.textContent = 'üåßÔ∏è';
            } else if (uvIndex > 7) {
                weatherIcon.textContent = 'üåû';
            } else if (current.temperature_2m < 10) {
                weatherIcon.textContent = '‚ùÑÔ∏è';
            } else {
                weatherIcon.textContent = '‚õÖ';
            }
            
            // Actualizar informaci√≥n de √∫ltima actualizaci√≥n
            document.getElementById('weatherUpdating').textContent = `Actualizado: ${new Date().toLocaleTimeString('es-CL')}`;
        }

        // Funci√≥n para alternar el widget del clima
        function toggleWeatherWidget() {
            const weatherWidget = document.getElementById('weatherWidget');
            weatherWidget.classList.toggle('expanded');
            
            // Si se expande y no hay datos recientes, actualizar
            if (weatherWidget.classList.contains('expanded') && 
                (!lastWeatherUpdate || (new Date() - lastWeatherUpdate) > 300000)) {
                updateWeatherData();
            }
        }

        // Inicializar la aplicaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el mapa
            initMap();
            
            // Configurar event listeners
            document.getElementById('togglePanel').addEventListener('click', function() {
                document.getElementById('controlPanel').classList.toggle('visible');
            });
            
            document.getElementById('mapTouchOverlay').addEventListener('click', function() {
                document.getElementById('controlPanel').classList.remove('visible');
            });
            
            document.getElementById('refreshBtn').addEventListener('click', function() {
                this.classList.add('loading');
                locateUser();
                
                // Simular tiempo de carga
                setTimeout(() => {
                    this.classList.remove('loading');
                    showNotification('Datos actualizados', 'success');
                }, 1000);
            });
            
            document.getElementById('mapProvider').addEventListener('change', function() {
                changeMapProvider(this.value);
            });
            
            document.getElementById('routeSelector').addEventListener('change', function() {
                changeRoute(this.value);
            });
            
            document.getElementById('emergencyLocateBtn').addEventListener('click', function() {
                if (lastPosition) {
                    map.setView([lastPosition.lat, lastPosition.lng], 17);
                    showNotification('Centrado en tu ubicaci√≥n');
                } else {
                    locateUser();
                }
            });
            
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                    // Limpiar datos de sesi√≥n
                    localStorage.removeItem('userVehicle');
                    window.location.reload();
                }
            });
            
            document.getElementById('forceLocationBtn').addEventListener('click', function() {
                forceLocationUpdate();
            });
            
            document.getElementById('toggleDiagnosticPanel').addEventListener('click', function() {
                const diagnosticPanel = document.getElementById('diagnosticPanel');
                diagnosticPanelVisible = !diagnosticPanelVisible;
                
                if (diagnosticPanelVisible) {
                    diagnosticPanel.style.display = 'block';
                    if (lastPosition) {
                        updateDiagnosticInfo(lastPosition.accuracy, lastPosition.timestamp);
                    }
                } else {
                    diagnosticPanel.style.display = 'none';
                }
            });
            
            document.getElementById('vehicleNumberSubmit').addEventListener('click', function() {
                const vehicleNumber = document.getElementById('vehicleNumberInput').value.trim();
                
                if (vehicleNumber) {
                    currentUserVehicle = vehicleNumber;
                    localStorage.setItem('userVehicle', vehicleNumber);
                    
                    // Ocultar modal
                    document.getElementById('vehicleNumberModal').style.display = 'none';
                    
                    // Mostrar dashboard de admin si es un veh√≠culo especial
                    if (vehicleNumber === 'admin') {
                        isAdmin = true;
                        document.getElementById('adminDashboard').style.display = 'block';
                        adminDashboardVisible = true;
                        showNotification('Modo administrador activado');
                    } else {
                        showNotification(`Veh√≠culo ${vehicleNumber} asignado`);
                    }
                }
            });
            
            // Alternar pesta√±as del dashboard
            document.querySelectorAll('.dashboard-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Desactivar todas las pesta√±as
                    document.querySelectorAll('.dashboard-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Ocultar todo el contenido
                    document.querySelectorAll('.dashboard-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Activar pesta√±a seleccionada
                    this.classList.add('active');
                    
                    // Mostrar contenido correspondiente
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}Content`).classList.add('active');
                });
            });
            
            // Bot√≥n de descarga de reporte
            document.getElementById('downloadReportBtn').addEventListener('click', function() {
                showNotification('Generando reporte...');
                
                // Simular generaci√≥n de reporte
                setTimeout(() => {
                    showNotification('Reporte descargado', 'success');
                }, 1500);
            });
            
            // Bot√≥n de exportaci√≥n a Excel
            document.getElementById('exportExcelBtn').addEventListener('click', function() {
                // Crear datos de ejemplo
                const data = [
                    ['Veh√≠culo', '√öltima Actualizaci√≥n', 'Estado', 'Latitud', 'Longitud'],
                    [currentUserVehicle || 'N/A', new Date().toLocaleString(), 'En l√≠nea', lastPosition?.lat || 'N/A', lastPosition?.lng || 'N/A']
                ];
                
                // Crear libro de trabajo y hoja
                const ws = XLSX.utils.aoa_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Datos GPS');
                
                // Exportar a Excel
                XLSX.writeFile(wb, 'datos_gps.xlsx');
                showNotification('Datos exportados a Excel', 'success');
            });
            
            // Event listener para el widget del clima
            document.getElementById('weatherWidget').addEventListener('click', function(e) {
                // Prevenir que el clic se propague al mapa
                e.stopPropagation();
                toggleWeatherWidget();
            });
            
            // Verificar si ya hay un veh√≠culo asignado
            const savedVehicle = localStorage.getItem('userVehicle');
            if (savedVehicle) {
                currentUserVehicle = savedVehicle;
                
                if (savedVehicle === 'admin') {
                    isAdmin = true;
                    document.getElementById('adminDashboard').style.display = 'block';
                    adminDashboardVisible = true;
                }
            } else {
                // Mostrar modal para ingresar n√∫mero de veh√≠culo
                document.getElementById('vehicleNumberModal').style.display = 'flex';
            }
            
            // Cargar datos iniciales de veh√≠culos de ejemplo
            setTimeout(() => {
                // Veh√≠culos de ejemplo
                updateVehiclePosition('101', -33.4469, -70.6583);
                updateVehiclePosition('102', -33.4369, -70.6683);
                
                // Simular actualizaciones peri√≥dicas de veh√≠culos
                setInterval(() => {
                    if (Math.random() > 0.3) { // 70% de probabilidad de actualizaci√≥n
                        const latOffset = (Math.random() - 0.5) * 0.01;
                        const lngOffset = (Math.random() - 0.5) * 0.01;
                        
                        updateVehiclePosition('101', -33.4469 + latOffset, -70.6583 + lngOffset);
                    }
                    
                    if (Math.random() > 0.4) { // 60% de probabilidad de actualizaci√≥n
                        const latOffset = (Math.random() - 0.5) * 0.01;
                        const lngOffset = (Math.random() - 0.5) * 0.01;
                        
                        updateVehiclePosition('102', -33.4369 + latOffset, -70.6683 + lngOffset);
                    }
                }, 10000);
            }, 2000);
            
            // Actualizar datos meteorol√≥gicos peri√≥dicamente (cada 10 minutos)
            updateWeatherData();
            setInterval(updateWeatherData, 600000);
            
            // Simular actualizaci√≥n de contadores de vueltas (solo para demo)
            setInterval(() => {
                if (isAdmin) {
                    // Incrementar contadores aleatoriamente
                    if (Math.random() > 0.7) {
                        const shift = Object.keys(lapCounters.movil1)[Math.floor(Math.random() * 3)];
                        lapCounters.movil1[shift]++;
                        document.getElementById(`movil1${shift.charAt(0).toUpperCase() + shift.slice(1)}`).textContent = lapCounters.movil1[shift];
                    }
                    
                    if (Math.random() > 0.6) {
                        const shift = Object.keys(lapCounters.movil2)[Math.floor(Math.random() * 3)];
                        lapCounters.movil2[shift]++;
                        document.getElementById(`movil2${shift.charAt(0).toUpperCase() + shift.slice(1)}`).textContent = lapCounters.movil2[shift];
                    }
                    
                    // Actualizar m√©tricas
                    document.getElementById('totalLaps').textContent = 
                        lapCounters.movil1.shift1 + lapCounters.movil1.shift2 + lapCounters.movil1.shift3 +
                        lapCounters.movil2.shift1 + lapCounters.movil2.shift2 + lapCounters.movil2.shift3;
                    
                    document.getElementById('totalVehicles').textContent = Object.keys(vehicles).length;
                }
            }, 5000);
        });
    </script>
</body>
</html>
