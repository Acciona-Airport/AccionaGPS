<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f44336">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- Biblioteca para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
            --user-position-color: #3498db;
            --blue-primary: #2196f3;
            --blue-light: #e3f2fd;
            --blue-dark: #1976d2;
            --route1-color: #e74c3c;
            --route2-color: #9b59b6;
            --dashboard-bg: #f8f9fa;
            --dashboard-card: #ffffff;
            --dashboard-text: #333333;
            --dashboard-border: #e0e0e0;
            --shift1-color: #3498db;
            --shift2-color: #9b59b6;
            --shift3-color: #e67e22;
            --transparency: 0.70;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background-color: #2c3e50;
            touch-action: pan-x pan-y;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        
        /* Widget del Clima - NUEVO ESTILO */
        .weather-widget {
            position: fixed;
            top: 120px; /* Bajado para que no quede sobre el bot√≥n de ruta */
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 8px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .weather-widget.expanded {
            border-radius: 12px;
            width: auto;
            height: auto;
            min-width: 180px;
            padding: 12px;
        }
        .weather-icon {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }
        .weather-info {
            display: none;
            flex-direction: column;
        }
        .weather-widget.expanded .weather-info {
            display: flex;
        }
        .weather-temp {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .weather-desc {
            font-size: 12px;
            color: #666;
        }
        .weather-location {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }
        .weather-updating {
            font-size: 9px;
            color: #aaa;
            margin-top: 4px;
            font-style: italic;
        }
        @media (min-width: 768px) {
            .weather-widget {
                top: 130px; /* Sube el logo 20 p√≠xeles m√°s arriba */
                left: 15px; /* Mueve el logo m√°s a la derecha */
            }
        }

        
        
        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
            pointer-events: none;
        }
        .control-panel {
            background: rgba(255,255,255,var(--transparency));
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }
        .toggle-panel {
            background: rgba(255,255,255,var(--transparency));
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
            margin-left: 5px;
            flex-shrink: 0;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
            height: 16px;
        }
        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: var(--online-color); }
        .offline { color: var(--offline-color); }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        .diagnostic-panel-container {
            display: none;
        }
        .user-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
        }
        .user-icon.online {
            background-color: var(--online-color);
        }
        .user-icon.offline {
            background-color: var(--offline-color);
            opacity: 0.7;
        }
        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
        }
        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }
        .refresh-container {
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }
        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.2s;
            pointer-events: auto;
        }
        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .map-provider-selector {
            position: fixed;
            bottom: 57px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 6px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 10px;
            backdrop-filter: blur(5px);
        }
       .map-provider-selector select {
    padding: 5px;
    border-radius: 3px;
    border: none;
    background-color: transparent;
}
        .status-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            font-size: 14px;
        }
        .current-user-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: var(--red-dark);
            backdrop-filter: blur(5px);
        }
        .pulse-circle {
            border-radius: 50%;
            background-color: var(--user-position-color);
            width: 20px;
            height: 20px;
            position: absolute;
            left: -10px;
            top: -10px;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
        .emergency-locate-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
           background: rgba(52, 152, 219, var(--transparency));
            color: white;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .accuracy-circle {
            fill: rgba(52, 152, 219, 0.2);
            stroke: rgba(52, 152, 219, 0.5);
            stroke-width: 1;
        }
        .leaflet-control-zoom {
            margin-top: 80px !important;
        }
        .leaflet-bar a {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            font-size: 18px !important;
            background: rgba(255, 255, 255, var(--transparency)) !important;
            backdrop-filter: blur(5px);
        }
        .leaflet-container {
            touch-action: manipulation;
        }
        .map-touch-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 100%;
            z-index: 999;
            display: none;
        }
        .control-panel.visible ~ .map-touch-overlay {
            display: block;
        }
        .route-selector {
            position: fixed;
            top: 60px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, var(--transparency));
            padding: 6px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 10px;
            backdrop-filter: blur(5px);
        }
       .route-selector select {
    padding: 5px;
    border-radius: 3px;
    border: none;
    margin-top: 5px;
    width: 100%;
    background-color: transparent;
}
        
        .leaflet-bottom.leaflet-right {
            bottom: 160px;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        
        .vehicle-number-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .vehicle-number-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .vehicle-number-form h2 {
            color: var(--red-dark);
            margin-bottom: 20px;
        }
        .vehicle-number-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
        }
        .vehicle-number-input:focus {
            border-color: var(--red-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }
        .vehicle-number-submit {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .vehicle-number-submit:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        .admin-dashboard {
            display: none;
            background: var(--dashboard-card);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid var(--dashboard-border);
        }
        .admin-dashboard h4 {
            color: var(--red-dark);
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--dashboard-border);
        }
        .dashboard-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--dashboard-border);
        }
        .dashboard-tab {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            font-weight: 500;
        }
        .dashboard-tab.active {
            border-bottom-color: var(--red-primary);
            color: var(--red-dark);
        }
        .dashboard-content {
            display: none;
        }
        .dashboard-content.active {
            display: block;
        }
        .lap-counter {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--dashboard-bg);
            border-radius: 6px;
        }
        .lap-counter h5 {
            margin: 0 0 8px 0;
            color: var(--dashboard-text);
            font-size: 14px;
        }
        .lap-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .lap-stat {
            text-align: center;
            padding: 8px;
            border-radius: 4px;
            background: var(--dashboard-card);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .lap-stat.shift1 {
            border-top: 3px solid var(--shift1-color);
        }
        .lap-stat.shift2 {
            border-top: 3px solid var(--shift2-color);
        }
        .lap-stat.shift3 {
            border-top: 3px solid var(--shift3-color);
        }
        .lap-count {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .lap-label {
            font-size: 11px;
            color: #666;
        }
        .dashboard-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .metric-card {
            padding: 10px;
            background: var(--dashboard-bg);
            border-radius: 6px;
            text-align: center;
        }
        .metric-value {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Bot√≥n para descargar datos */
        .download-btn {
            background: var(--blue-primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background 0.3s;
            display: none; /* Ocultado inicialmente */
        }
        .download-btn:hover {
            background: var(--blue-dark);
        }
        #locationStatus {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 18px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-touch-overlay" id="mapTouchOverlay"></div>
    
    <!-- Widget del Clima - NUEVO DISE√ëO -->
    <div class="weather-widget" id="weatherWidget">
        <div class="weather-icon" id="weatherIcon">‚òÄÔ∏è</div>
        <div class="weather-info">
            <div class="weather-temp" id="weatherTemp">--¬∞C</div>
            <div class="weather-desc" id="weatherDesc">Cargando...</div>
            <div class="weather-location">Pudahuel, Santiago</div>
            <div class="weather-updating" id="weatherUpdating"></div>
        </div>
    </div>
    
    <div class="status-notification" id="statusNotification"></div>
    
    <div class="current-user-indicator" id="currentUserIndicator">
        <span id="locationStatus">Buscando tu ubicaci√≥n...</span>
    </div>

    <div class="diagnostic-panel-container">
        <div class="diagnostic-panel" id="diagnosticPanel">
            <h3 style="margin-top:0;color:var(--blue-dark);">üìä Diagn√≥stico GPS</h3>
            
            <div class="diagnostic-info">
                <div class="diagnostic-item">
                    <span>Estado GPS:</span>
                    <span id="gpsStatus" class="diagnostic-value warning">Comprobando...</span>
                </div>
                <div class="diagnostic-item">
                    <span>Precisi√≥n:</span>
                    <span id="accuracyValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>√öltima actualizaci√≥n:</span>
                    <span id="lastUpdateValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>M√©todo:</span>
                    <span id="methodValue" class="diagnostic-value">--</span>
                </div>
            </div>
            
            <button id="forceLocationBtn" style="margin-top: 15px; width: 100%; padding: 8px; background: var(--blue-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Forzar Ubicaci√≥n
            </button>
        </div>
        
        <button class="toggle-diagnostic-panel" id="toggleDiagnosticPanel">
            <div class="diagnostic-hamburger-icon">
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="route-selector">
        <label for="routeSelector">Ruta:</label>
        <select id="routeSelector">
            <option value="none">Sin ruta</option>
            <option value="route1">Ruta 1</option>
            <option value="route2">Ruta 2</option>
        </select>
    </div>

    <button class="emergency-locate-btn" id="emergencyLocateBtn" title="Centrar en mi ubicaci√≥n">üìç</button>

    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);">üöó Flota Acciona</h3>
            
            <div class="admin-dashboard" id="adminDashboard">
                <h4>üìä Dashboard Administrador</h4>
                
                <div class="dashboard-tabs">
                    <div class="dashboard-tab active" data-tab="laps">Vueltas</div>
                    <div class="dashboard-tab" data-tab="metrics">Data</div>
                    <div class="dashboard-tab" data-tab="performance">Global</div>
                </div>
                
                <div class="dashboard-content active" id="lapsContent">
                    <div class="lap-counter" id="movil1Laps">
                        <h5>M√≥vil 1</h5>
                        <div class="lap-stats">
                            <div class="lap-stat shift1">
                                <div class="lap-count" id="movil1Shift1">0</div>
                                <div class="lap-label">06:00 - 13:00</div>
                            </div>
                            <div class="lap-stat shift2">
                                <div class="lap-count" id="movil1Shift2">0</div>
                                <div class="lap-label">13:00 - 22:00</div>
                            </div>
                            <div class="lap-stat shift3">
                                <div class="lap-count" id="movil1Shift3">0</div>
                                <div class="lap-label">22:00 - 06:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lap-counter" id="movil2Laps">
                        <h5>M√≥vil 2</h5>
                        <div class="lap-stats">
                            <div class="lap-stat shift1">
                                <div class="lap-count" id="movil2Shift1">0</div>
                                <div class="lap-label">06:00 - 13:00</div>
                            </div>
                            <div class="lap-stat shift2">
                                <div class="lap-count" id="movil2Shift2">0</div>
                                <div class="lap-label">13:00 - 22:00</div>
                            </div>
                            <div class="lap-stat shift3">
                                <div class="lap-count" id="movil2Shift3">0</div>
                                <div class="lap-label">22:00 - 06:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lap-counter" id="movil3Laps">
                        <h5>M√≥vil 3</h5>
                        <div class="lap-stats">
                            <div class="lap-stat shift1">
                                <div class="lap-count" id="movil3Shift1">0</div>
                                <div class="lap-label">06:00 - 13:00</div>
                            </div>
                            <div class="lap-stat shift2">
                                <div class="lap-count" id="movil3Shift2">0</div>
                                <div class="lap-label">13:00 - 22:00</div>
                            </div>
                            <div class="lap-stat shift3">
                                <div class="lap-count" id="movil3Shift3">0</div>
                                <div class="lap-label">22:00 - 06:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lap-counter" id="movil4Laps">
                        <h5>M√≥vil 4</h5>
                        <div class="lap-stats">
                            <div class="lap-stat shift1">
                                <div class="lap-count" id="movil4Shift1">0</div>
                                <div class="lap-label">06:00 - 13:00</div>
                            </div>
                            <div class="lap-stat shift2">
                                <div class="lap-count" id="movil4Shift2">0</div>
                                <div class="lap-label">13:00 - 22:00</div>
                            </div>
                            <div class="lap-stat shift3">
                                <div class="lap-count" id="movil4Shift3">0</div>
                                <div class="lap-label">22:00 - 06:00</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-content" id="metricsContent">
                    <div class="dashboard-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="totalLaps">0</div>
                            <div class="metric-label">Total Vueltas Hoy</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="activeVehicles">0</div>
                            <div class="metric-label">Veh√≠culos Activos</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avgLapTime">--</div>
                            <div class="metric-label">Tiempo Promedio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="lastUpdate">--</div>
                            <div class="metric-label">√öltima Actualizaci√≥n</div>
                        </div>
                    </div>
                    
                    <!-- Bot√≥n para descargar datos en Excel -->
                    <button class="download-btn" id="downloadExcelBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                            <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                        </svg>
                        Descargar Datos del D√≠a
                    </button>
                </div>
                
                <div class="dashboard-content" id="performanceContent">
                    <div class="dashboard-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="totalDistance">0 km</div>
                            <div class="metric-label">Distancia Total</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="avgSpeed">0 km/h</div>
                            <div class="metric-label">Velocidad Promedio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="fuelEfficiency">--</div>
                            <div class="metric-label">Eficiencia Combustible</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="operatingHours">0 h</div>
                            <div class="metric-label">Horas Operativas</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="current-user-icon" class="user-icon offline"></div>
                    <span id="current-user-name">Mi Ubicaci√≥n</span>
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="current-user-status" class="offline">Desconectado</span>
                </div>
                <div class="vehicle-status">
                    <span>Coordenadas:</span>
                    <span id="current-user-coords">--</span>
                </div>
            </div>
            
            <div id="other-vehicles-container" style="display: none;">
                <h4 style="margin: 15px 0 10px 0; color: var(--red-dark);">Carruseles:</h4>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil1-icon" class="vehicle-icon offline"></div>
                        <span id="movil1-name">M√≥vil 1</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil1-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil2-icon" class="vehicle-icon offline"></div>
                        <span id="movil2-name">M√≥vil 2</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil2-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil3-icon" class="vehicle-icon offline"></div>
                        <span id="movil3-name">M√≥vil 3</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil3-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil4-icon" class="vehicle-icon offline"></div>
                        <span id="movil4-name">M√≥vil 4</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil4-status" class="offline">Desconectado</span>
                    </div>
                </div>
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
        
        <button class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="refresh-container" id="refreshContainer">
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Actualizar
        </button>
    </div>

    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="esri">Satelital (Recomendada)</option>
            <option value="carto">Cartogr√°fica</option>
            <option value="osm">H√≠brida</option>
        </select>
    </div>

    <div class="vehicle-number-modal" id="vehicleNumberModal">
        <div class="vehicle-number-form">
            <h2>Ingrese n√∫mero de veh√≠culo</h2>
            <input type="text" class="vehicle-number-input" id="vehicleNumberInput" placeholder="Ej: 6142" maxlength="10">
            <button class="vehicle-number-submit" id="vehicleNumberSubmit">Continuar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDT85qotm1EpAJzJzCFeoNwGyo-VKhM6dk",
            authDomain: "gpsaccionascl2025.firebaseapp.com",
            databaseURL: "https://gpsaccionascl2025-default-rtdb.firebaseio.com",
            projectId: "gpsaccionascl2025",
            storageBucket: "gpsaccionascl2025.appspot.com",
            messagingSenderId: "742246618721",
            appId: "1:742246618721:web:72d0046987416800f07c20"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const SCL_COORDS = [-33.3931, -70.7858];
        const INACTIVE_COORDS = [-33.409995, -70.788647];
        const START_POINT = [-33.409455, -70.789421];
        const DETECTION_RADIUS = 100;
        const ZOOM_INICIAL = 14;
        let map;
        let currentTileLayer;
        const markers = {};
        const lastUpdateTimes = {};
        const vehicleCache = {};
        let gpsInterval;
        let wakeLock = null;
        let backgroundGeolocationWatchId = null;
        const TEN_MINUTES = 10 * 60 * 1000;
        const UPDATE_INTERVAL = 30000;
        let currentUserId = null;
        let isViewer = false;
        let userPositionMarker = null;
        let userAccuracyCircle = null;
        let lastKnownPosition = null;
        let locationUpdateInterval = null;
        let viewerUpdateInterval = null;
        let currentRouteLayer = null;
        let vehicleNames = {};
        
        // Variable para el intervalo de actualizaci√≥n del clima
        let weatherUpdateInterval = null;
        
        let lapCounters = {
            Movil1: { shift1: 0, shift2: 0, shift3: 0, lastLapTime: null, isNearStart: false, lastResetDate: null },
            Movil2: { shift1: 0, shift2: 0, shift3: 0, lastLapTime: null, isNearStart: false, lastResetDate: null },
            Movil3: { shift1: 0, shift2: 0, shift3: 0, lastLapTime: null, isNearStart: false, lastResetDate: null },
            Movil4: { shift1: 0, shift2: 0, shift3: 0, lastLapTime: null, isNearStart: false, lastResetDate: null }
        };
        let startPointMarker = null;
        
        const route1Coordinates = [
            [-33.4095444, -70.7893019],
            [-33.4092635, -70.7895518],
            [-33.404626, -70.7897795],
            [-33.4045659, -70.7889574],
            [-33.3965734, -70.7893183],
            [-33.3966737, -70.7910012],
            [-33.3970831, -70.790958],
            [-33.3971273, -70.7919677],
            [-33.4013289, -70.7917774],
            [-33.401446, -70.795415],
            [-33.399824, -70.7955015],
            [-33.3998119, -70.7961745],
            [-33.3963198, -70.796343],
            [-33.3960964, -70.7894296],
            [-33.3966985, -70.7893961],
            [-33.3967748, -70.7909972],
            [-33.3971721, -70.7909347],
            [-33.3972203, -70.792002],
            [-33.4045345, -70.7915771],
            [-33.4044984, -70.7897934],
            [-33.40931, -70.7895175],
            [-33.4096593, -70.7891232]
        ];
        const route2Coordinates = [
            [-33.4096489, -70.7892732],
            [-33.4093416, -70.7895579],
            [-33.4046013, -70.7898303],
            [-33.4045362, -70.7889762],
            [-33.3966243, -70.7893156],
            [-33.396535, -70.7894658],
            [-33.3960629, -70.7895151],
            [-33.3963403, -70.7977141],
            [-33.3964389, -70.7977093],
            [-33.3961615, -70.7895498],
            [-33.3966124, -70.7895158],
            [-33.3966597, -70.7909835],
            [-33.3970632, -70.7911581],
            [-33.3970881, -70.7919946],
            [-33.4044896, -70.7915298],
            [-33.4044823, -70.789894],
            [-33.4092579, -70.7896023],
            [-33.4096104, -70.7892531]
        ];
        const mapProviders = {
            esri: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            },
            carto: {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            },
            osm: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }
        };

        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                if (!auth) window.location.href = 'login.html';
                
                currentUserId = auth.username;
                isViewer = auth.isViewer;
                
                const savedVehicleNames = localStorage.getItem('vehicleNames');
                if (savedVehicleNames) {
                    vehicleNames = JSON.parse(savedVehicleNames);
                }
                
                initMap();
                setupUI();
                
                // Iniciar la obtenci√≥n del clima con intervalo de 1 minuto
                startWeatherUpdates();
                
                if (!isViewer && !auth.vehicleNumber) {
                    document.getElementById('vehicleNumberModal').style.display = 'flex';
                } else {
                    document.getElementById('vehicleNumberModal').style.display = 'none';
                    setupAfterVehicleNumber();
                }
            }
        });

        // Funci√≥n para iniciar las actualizaciones del clima cada minuto
        function startWeatherUpdates() {
            // Obtener datos inmediatamente
            getWeatherData();
            
            // Configurar intervalo para actualizar cada minuto (60000 ms)
            weatherUpdateInterval = setInterval(getWeatherData, 60000);
            
            // Mostrar el tiempo hasta la pr√≥xima actualizaci√≥n
            updateNextUpdateTime();
        }

        // Funci√≥n para mostrar el tiempo hasta la pr√≥xima actualizaci√≥n
        function updateNextUpdateTime() {
            const now = new Date();
            const nextUpdate = new Date(now.getTime() + 60000);
            const nextUpdateStr = nextUpdate.toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit'});
            
            document.getElementById('weatherUpdating').textContent = `Pr√≥xima actualizaci√≥n: ${nextUpdateStr}`;
        }

        // Funci√≥n para obtener datos del clima
        function getWeatherData() {
            // Coordenadas de Pudahuel, Santiago de Chile
            const lat = -33.4489;
            const lon = -70.6693;
            
            // API Key de OpenWeatherMap
            const apiKey = '5a3cb2a80455a22f4bc920458df1b521';
            
            // Actualizar el texto de pr√≥xima actualizaci√≥n
            updateNextUpdateTime();
            
            // Mostrar estado de carga
            document.getElementById('weatherDesc').textContent = 'Actualizando...';
            
            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=es`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta de la API');
                    }
                    return response.json();
                })
                .then(data => {
                    updateWeatherWidget(data);
                })
                .catch(error => {
                    console.error('Error obteniendo datos del clima:', error);
                    // Usar datos de muestra en caso de error
                    const sampleData = {
                        main: { temp: 22 + Math.floor(Math.random() * 5) },
                        weather: [{ 
                            description: "Soleado", 
                            icon: "01d",
                            main: "Clear"
                        }],
                        name: "Pudahuel"
                    };
                    updateWeatherWidget(sampleData);
                    document.getElementById('weatherDesc').textContent = 'Datos de muestra (error API)';
                });
        }

        // Funci√≥n para actualizar el widget del clima
        function updateWeatherWidget(data) {
            const tempElement = document.getElementById('weatherTemp');
            const descElement = document.getElementById('weatherDesc');
            const iconElement = document.getElementById('weatherIcon');
            
            if (data && data.main) {
                tempElement.textContent = `${Math.round(data.main.temp)}¬∞C`;
                descElement.textContent = data.weather[0].description;
                
                // Asignar icono seg√∫n el c√≥digo del clima
                const iconCode = data.weather[0].icon;
                iconElement.textContent = getWeatherIcon(iconCode);
            } else {
                tempElement.textContent = '--¬∞C';
                descElement.textContent = 'Error al cargar';
                iconElement.textContent = '‚ùì';
            }
        }

        // Funci√≥n para obtener el icono correspondiente al c√≥digo del clima
        function getWeatherIcon(iconCode) {
            const iconMap = {
                '01d': '‚òÄÔ∏è', // Clear sky (day)
                '01n': 'üåô', // Clear sky (night)
                '02d': '‚õÖ', // Few clouds (day)
                '02n': '‚õÖ', // Few clouds (night)
                '03d': 'üå§Ô∏è', // Scattered clouds
                '03n': 'üå§Ô∏è',
                '04d': '‚òÅÔ∏è', // Broken clouds
                '04n': '‚òÅÔ∏è',
                '09d': 'üåßÔ∏è', // Shower rain
                '09n': 'üåßÔ∏è',
                '10d': 'üå¶Ô∏è', // Rain (day)
                '10n': 'üå¶Ô∏è', // Rain (night)
                '11d': '‚õàÔ∏è', // Thunderstorm
                '11n': '‚õàÔ∏è',
                '13d': '‚ùÑÔ∏è', // Snow
                '13n': '‚ùÑÔ∏è',
                '50d': 'üå´Ô∏è', // Mist
                '50n': 'üå´Ô∏è'
            };
            
            return iconMap[iconCode] || 'üå°Ô∏è';
        }

        // Funci√≥n para alternar la expansi√≥n del widget del clima
        function toggleWeatherWidget() {
            const widget = document.getElementById('weatherWidget');
            widget.classList.toggle('expanded');
        }

        function setupAfterVehicleNumber() {
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            if (auth.vehicleNumber) {
                vehicleNames[currentUserId] = auth.vehicleNumber;
                localStorage.setItem('vehicleNames', JSON.stringify(vehicleNames));
            }

            const displayName = (currentUserId === 'Funcionarios') ? 'Yo' : (vehicleNames[currentUserId] || currentUserId);
            document.getElementById('current-user-name').textContent = displayName;
            
            // Ocultar bot√≥n de actualizar para usuarios Funcionarios
            if (currentUserId === 'Funcionarios') {
                document.getElementById('refreshContainer').style.display = 'none';
            }
            
            if (currentUserId === 'Admin') {
                document.getElementById('adminDashboard').style.display = 'block';
                loadLapCounters();
                setupDashboardTabs();
                
                // Configurar el bot√≥n de descarga de Excel
                document.getElementById('downloadExcelBtn').addEventListener('click', downloadExcelData);
            }
            
            if (isViewer) {
                document.getElementById('other-vehicles-container').style.display = 'block';
                updateVehicleNamesInUI();
                initializeAllMarkers();
                startMonitoring();
            } else {
                initializeCurrentUserMarker();
                startGPSTracking(currentUserId);
            }
            
            // A√±adir evento de clic al widget del clima
            document.getElementById('weatherWidget').addEventListener('click', toggleWeatherWidget);
        }
        
        function setupDashboardTabs() {
            const tabs = document.querySelectorAll('.dashboard-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.dashboard-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(`${tabId}Content`).classList.add('active');
                });
            });
        }
        
        function loadLapCounters() {
            const savedLapCounters = localStorage.getItem('lapCounters');
            if (savedLapCounters) {
                const savedData = JSON.parse(savedLapCounters);
                
                // Verificar si necesitamos resetear los contadores por cambio de d√≠a
                const today = new Date().toDateString();
                Object.keys(savedData).forEach(vehicle => {
                    if (savedData[vehicle].lastResetDate !== today) {
                        // Resetear contadores si es un nuevo d√≠a
                        savedData[vehicle].shift1 = 0;
                        savedData[vehicle].shift2 = 0;
                        savedData[vehicle].shift3 = 0;
                        savedData[vehicle].lastResetDate = today;
                    }
                });
                
                lapCounters = savedData;
                Object.keys(lapCounters).forEach(vehicle => {
                    updateLapCounterUI(vehicle);
                });
            } else {
                // Inicializar con fecha actual si no hay datos guardados
                const today = new Date().toDateString();
                Object.keys(lapCounters).forEach(vehicle => {
                    lapCounters[vehicle].lastResetDate = today;
                });
            }
            updateMetrics();
        }
        
        function saveLapCounters() {
            localStorage.setItem('lapCounters', JSON.stringify(lapCounters));
        }
        
        function updateLapCounterUI(vehicle) {
            const counter = lapCounters[vehicle];
            document.getElementById(`${vehicle.toLowerCase()}Shift1`).textContent = counter.shift1;
            document.getElementById(`${vehicle.toLowerCase()}Shift2`).textContent = counter.shift2;
            document.getElementById(`${vehicle.toLowerCase()}Shift3`).textContent = counter.shift3;
        }
        
        function updateMetrics() {
            let totalLaps = 0;
            Object.keys(lapCounters).forEach(vehicle => {
                totalLaps += lapCounters[vehicle].shift1 + lapCounters[vehicle].shift2 + lapCounters[vehicle].shift3;
            });
            document.getElementById('totalLaps').textContent = totalLaps;
            
            // CORRECCI√ìN: Contar solo veh√≠culos que est√©n realmente "En l√≠nea" (online)
            let activeCount = 0;
            Object.keys(vehicleCache).forEach(vehicle => {
                if (vehicleCache[vehicle] && vehicleCache[vehicle].status === 'online') {
                    // Verificar si la √∫ltima actualizaci√≥n fue hace menos de 10 minutos
                    const lastUpdate = vehicleCache[vehicle].lastUpdate || 0;
                    const isOnline = (Date.now() - lastUpdate) < TEN_MINUTES;
                    if (isOnline) {
                        activeCount++;
                    }
                }
            });
            document.getElementById('activeVehicles').textContent = activeCount;
            
            // Mostrar hora local de Chile
            const now = new Date();
            const chileTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Santiago"}));
            document.getElementById('lastUpdate').textContent = chileTime.toLocaleTimeString('es-CL');
            
            let totalDistance = 0;
            Object.keys(lapCounters).forEach(vehicle => {
                totalDistance += (lapCounters[vehicle].shift1 + lapCounters[vehicle].shift2 + lapCounters[vehicle].shift3) * 15;
            });
            document.getElementById('totalDistance').textContent = totalDistance + ' km';
            
            document.getElementById('avgSpeed').textContent = '20 km/h';
            document.getElementById('fuelEfficiency').textContent = '5.2 km/L';
            document.getElementById('operatingHours').textContent = '8.5 h';
        }
        
        function downloadExcelData() {
            // Obtener datos de coordenadas almacenados
            const coordinateData = getCoordinateDataForToday();
            
            // Crear libro de Excel
            const wb = XLSX.utils.book_new();
            
            // Crear hoja de datos
            const ws = XLSX.utils.json_to_sheet(coordinateData);
            
            // A√±adir hoja al libro
            XLSX.utils.book_append_sheet(wb, ws, "Coordenadas");
            
            // Generar nombre de archivo con fecha actual
            const today = new Date();
            const fileName = `coordenadas_${today.getDate()}-${today.getMonth()+1}-${today.getFullYear()}.xlsx`;
            
            // Descargar archivo
            XLSX.writeFile(wb, fileName);
            
            showNotification("Datos descargados exitosamente", 3000);
        }
        
        function getCoordinateDataForToday() {
            // Obtener datos almacenados
            const storedData = localStorage.getItem('coordinateData');
            const today = new Date().toDateString();
            
            if (!storedData) return [];
            
            const allData = JSON.parse(storedData);
            
            // Filtrar datos del d√≠a actual
            const todayData = allData.filter(item => {
                const itemDate = new Date(item.timestamp).toDateString();
                return itemDate === today;
            });
            
            // Formatear datos para Excel con fecha y hora separadas
            return todayData.map(item => {
                const date = new Date(item.timestamp);
                const chileDate = new Date(date.toLocaleString("en-US", {timeZone: "America/Santiago"}));
                
                return {
                    'N√∫mero de Equipo': item.vehicleName,
                    'ID del Veh√≠culo': item.vehicleId,
                    'Latitud': item.latitude,
                    'Longitud': item.longitude,
                    'Estado': item.status,
                    'N√∫mero de Vueltas': item.laps,
                    'Fecha': chileDate.toLocaleDateString('es-CL'),
                    'Hora': chileDate.toLocaleTimeString('es-CL')
                };
            });
        }
        
        function storeCoordinateData(vehicleId, coords, status, laps) {
            // Obtener datos existentes
            const storedData = localStorage.getItem('coordinateData');
            let coordinateData = storedData ? JSON.parse(storedData) : [];
            
            // A√±adir nuevo registro
            coordinateData.push({
                vehicleId: vehicleId,
                vehicleName: vehicleNames[vehicleId] || vehicleId,
                latitude: coords[0],
                longitude: coords[1],
                status: status,
                laps: laps || 0,
                timestamp: new Date().toISOString()
            });
            
            // Limitar datos a 7 d√≠as
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

            coordinateData = coordinateData.filter(item => {
                return new Date(item.timestamp) >= sevenDaysAgo;
            });
            
            // Guardar datos
            localStorage.setItem('coordinateData', JSON.stringify(coordinateData));
        }
        
        function checkLapCompletion(vehicle, coords) {
            const distance = calculateDistance(
                coords[0], coords[1],
                START_POINT[0], START_POINT[1]
            );
            
            if (distance <= DETECTION_RADIUS && !lapCounters[vehicle].isNearStart) {
                lapCounters[vehicle].isNearStart = true;
            }
            else if (distance > DETECTION_RADIUS && lapCounters[vehicle].isNearStart) {
                lapCounters[vehicle].isNearStart = false;
                registerLap(vehicle);
            }
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function registerLap(vehicle) {
            const now = new Date();
            const hour = now.getHours();
            let shift;
            
            // Determinar el turno seg√∫n la hora actual
            // Turno noche (22:00-6:00) se considera parte del d√≠a siguiente
            let adjustedHour = hour;
            let currentDate = now.toDateString();
            
            if (hour >= 22) {
                // Despu√©s de las 22:00, pertenece al turno 2 del d√≠a actual
                shift = 'shift3';
            } else if (hour < 6) {
                // Antes de las 6:00, pertenece al turno 2 del d√≠a anterior
                shift = 'shift3';
                // Pero lo contamos para el d√≠a actual en la interfaz
                currentDate = new Date(now.getTime() - 6 * 60 * 60 * 1000).toDateString();
            } else if (hour >= 6 && hour < 13) {
                shift = 'shift1';
            } else {
                shift = 'shift2';
            }
            
            // Verificar si necesitamos resetear los contadores por cambio de d√≠a
            if (lapCounters[vehicle].lastResetDate !== currentDate) {
                lapCounters[vehicle].shift1 = 0;
                lapCounters[vehicle].shift2 = 0;
                lapCounters[vehicle].shift3 = 0;
                lapCounters[vehicle].lastResetDate = currentDate;
            }
            
            lapCounters[vehicle][shift]++;
            lapCounters[vehicle].lastLapTime = now.getTime();
            
            updateLapCounterUI(vehicle);
            updateMetrics();
            saveLapCounters();
            
            showNotification(`¬°${vehicle} complet√≥ una vuelta en el turno ${shift}!`, 5000);
        }
        
        function updateVehicleNamesInUI() {
            for (let i = 1; i <= 4; i++) {
                const mobileId = 'Movil' + i;
                const element = document.getElementById(`${mobileId.toLowerCase()}-name`);
                if (element && vehicleNames[mobileId]) {
                    element.textContent = vehicleNames[mobileId];
                }
            }
        }
        
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                tap: false,
                dragging: true,
                preferCanvas: true, // Mejora el rendimiento usando canvas en lugar de SVG
                fadeAnimation: false, // Desactiva la animaci√≥n de desvanecimiento
                markerZoomAnimation: false // Desactiva la animaci√≥n de zoom de marcadores
            }).setView(SCL_COORDS, ZOOM_INICIAL);
            
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
            
            const savedProvider = localStorage.getItem('mapProvider') || 'esri';
            document.getElementById('mapProvider').value = savedProvider;
            setMapProvider(savedProvider);
            
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('‚úàÔ∏è Aeropuerto SCL')
                .openPopup();
                
            createUserPositionMarker(SCL_COORDS);
        }
        
        function setMapProvider(providerKey) {
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            const provider = mapProviders[providerKey];
            currentTileLayer = L.tileLayer(provider.url, {
                attribution: provider.attribution,
                maxZoom: provider.maxZoom,
                updateWhenIdle: true, // Mejora rendimiento: actualiza tiles cuando no hay movimiento
                reuseTiles: true, // Reutiliza tiles para mejorar rendimiento
                detectRetina: false // Desactiva detecci√≥n de retina para mejorar rendimiento
            }).addTo(map);
            
            localStorage.setItem('mapProvider', providerKey);
        }
        
        function setupUI() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            const panel = document.getElementById('controlPanel');
            const toggleBtn = document.getElementById('togglePanel');
            
            toggleBtn.addEventListener('click', function() {
                panel.classList.toggle('visible');
            });
            
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', function() {
                refreshBtn.classList.add('loading');
                
                if (isViewer) {
                    fetchVehicleData();
                }
                
                setTimeout(() => {
                    const isPanelVisible = panel.classList.contains('visible');
                    localStorage.setItem('panelState', isPanelVisible ? 'open' : 'closed');
                    refreshBtn.classList.remove('loading');
                }, 500);
            });
            
            document.getElementById('mapProvider').addEventListener('change', function(e) {
                setMapProvider(e.target.value);
            });
            
            document.getElementById('routeSelector').addEventListener('change', function(e) {
                showRoute(e.target.value);
            });
            
             document.getElementById('forceLocationBtn').addEventListener('click', function() {
                forceLocationUpdate();
            });
            
            document.getElementById('emergencyLocateBtn').addEventListener('click', function() {
                centerOnUserLocation();
            });
            
            document.getElementById('vehicleNumberSubmit').addEventListener('click', function() {
                const vehicleNumber = document.getElementById('vehicleNumberInput').value.trim();
                
                if (!vehicleNumber) {
                    alert('Por favor ingrese un n√∫mero de veh√≠culo');
                    return;
                }
                
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                auth.vehicleNumber = vehicleNumber;
                localStorage.setItem('gpsAuth', JSON.stringify(auth));
                
                document.getElementById('vehicleNumberModal').style.display = 'none';
                setupAfterVehicleNumber();
            });
            
            document.getElementById('vehicleNumberInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('vehicleNumberSubmit').click();
                }
            });
            
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            if ('wakeLock' in navigator) {
                document.addEventListener('visibilitychange', async () => {
                    if (document.visibilityState === 'visible') {
                        await requestWakeLock();
                    }
                });
            }
            
            const mapTouchOverlay = document.getElementById('mapTouchOverlay');
            mapTouchOverlay.addEventListener('click', function() {
                panel.classList.remove('visible');
            });
        }
        
        function showRoute(routeId) {
            if (currentRouteLayer) {
                map.removeLayer(currentRouteLayer);
                currentRouteLayer = null;
            }
            
            if (routeId === 'none') return;
            let coordinates;
            let color;
            
            if (routeId === 'route1') {
                coordinates = route1Coordinates;
                color = '#e74c3c';
            } else if (routeId === 'route2') {
                coordinates = route2Coordinates;
                color = '#9b59b6';
            }
            
            currentRouteLayer = L.polyline(coordinates, {
                color: color,
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map);
            
            const bounds = L.latLngBounds(coordinates);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        function handleVisibilityChange() {
            const notification = document.getElementById('statusNotification');
            if (document.visibilityState === 'visible') {
                notification.textContent = 'Aplicaci√≥n en primer plano';
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 3000);
                if (!isViewer) {
                    forceLocationUpdate();
                }
            } else {
                notification.textContent = 'Aplicaci√≥n en segundo plano - El GPS sigue activo';
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 3000);
            }
        }
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                    });
                }
            } catch (err) {
            }
        }
        
        function initializeAllMarkers() {
            const mobileIds = ['Movil1', 'Movil2', 'Movil3', 'Movil4'];
            mobileIds.forEach(mobileId => {
                createMarker(mobileId, INACTIVE_COORDS, false);
                lastUpdateTimes[mobileId] = Date.now();
            });
        }
        
        function initializeCurrentUserMarker() {
            createMarker(currentUserId, INACTIVE_COORDS, false);
            lastUpdateTimes[currentUserId] = Date.now();
        }
        
        function createUserPositionMarker(coords) {
            if (userPositionMarker) {
                map.removeLayer(userPositionMarker);
            }
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            
            const userIcon = L.divIcon({
                className: 'user-position-marker',
                html: `
                    <div style="background-color: #3498db; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
                    <div class="pulse-circle"></div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            userPositionMarker = L.marker(coords, { icon: userIcon, zIndexOffset: 1000 })
                .addTo(map)
                .bindPopup('<b>Tu ubicaci√≥n actual</b>');
                
            map.setView(coords, 16);
        }
        
        function updateUserPositionMarker(coords, accuracy) {
            if (!userPositionMarker) {
                createUserPositionMarker(coords);
            } else {
                userPositionMarker.setLatLng(coords);
            }
            
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            
            if (accuracy && accuracy < 1000) {
                userAccuracyCircle = L.circle(coords, {
                    radius: accuracy,
                    className: 'accuracy-circle'
                }).addTo(map);
            }
            
            document.getElementById('current-user-coords').textContent = 
                `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
            document.getElementById('accuracyValue').textContent = 
                accuracy ? `${accuracy.toFixed(1)} metros` : 'Desconocida';
            
            // Mostrar hora local de Chile
            const now = new Date();
            const chileTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Santiago"}));
            document.getElementById('lastUpdateValue').textContent = chileTime.toLocaleTimeString('es-CL');
            
            const locationStatus = document.getElementById('locationStatus');
            if (accuracy && accuracy < 1000) {
                updateDiagnostic('good', 'Ubicaci√≥n actualizada', accuracy);
                locationStatus.textContent = 'Ubicaci√≥n activa';
                locationStatus.style.color = 'green';
            } else if (accuracy) {
                updateDiagnostic('warning', 'Precisi√≥n limitada', accuracy);
                locationStatus.textContent = 'Precisi√≥n limitada';
                locationStatus.style.color = 'orange';
            } else {
                updateDiagnostic('bad', 'Sin datos de precisi√≥n');
                locationStatus.textContent = 'Ubicaci√≥n inactiva';
                locationStatus.style.color = 'red';
            }
        }
        
        function startGPSTracking(mobileId) {
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            
            requestWakeLock();
            
            updatePosition(mobileId);
            
            locationUpdateInterval = setInterval(() => {
                updatePosition(mobileId);
            }, 60000);
            
            setupBackgroundGeolocation(mobileId);
            
            setTimeout(() => updatePosition(mobileId), 2000);
        }
        
        function setupBackgroundGeolocation(mobileId) {
            if ('geolocation' in navigator) {
                const geoOptions = {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 10000
                };
                
                if (backgroundGeolocationWatchId !== null) {
                    navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
                }
                
                backgroundGeolocationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = [
                            position.coords.latitude,
                            position.coords.longitude
                        ];
                        const accuracy = position.coords.accuracy;
                        
                        updateDiagnostic('good', 'watchPosition', accuracy);
                        savePosition(mobileId, coords, accuracy);
                    },
                    (error) => {
                        updateDiagnostic('bad', `Error: ${getGeolocationErrorText(error)}`);
                        updateStatus(mobileId, 'offline');
                    },
                    geoOptions
                );
            } else {
                updateDiagnostic('bad', 'Geolocalizaci√≥n no soportada');
            }
        }
        
        function updatePosition(mobileId) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const coords = [
                            position.coords.latitude,
                            position.coords.longitude
                        ];
                        const accuracy = position.coords.accuracy;
                        
                        updateDiagnostic('good', 'getCurrentPosition', accuracy);
                        savePosition(mobileId, coords, accuracy);
                    },
                    error => {
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                const coords = [
                                    position.coords.latitude,
                                    position.coords.longitude
                                ];
                                const accuracy = position.coords.accuracy;
                                
                                updateDiagnostic('warning', 'M√©todo alternativo', accuracy);
                                savePosition(mobileId, coords, accuracy);
                            },
                            error2 => {
                                console.error('Error GPS con m√©todo alternativo:', error2);
                                updateDiagnostic('bad', `Error: ${getGeolocationErrorText(error2)}`);
                                updateStatus(mobileId, 'offline');
                                
                                if (lastKnownPosition) {
                                    updateDiagnostic('warning', 'Usando √∫ltima posici√≥n conocida');
                                    savePosition(mobileId, lastKnownPosition, 1000);
                                }
                            },
                            { 
                                enableHighAccuracy: false,
                                timeout: 15000,
                                maximumAge: 300000
                            }
                        );
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateDiagnostic('bad', 'Geolocalizaci√≥n no soportada');
                alert("Tu navegador no soporta geolocalizaci√≥n");
            }
        }
        
        function forceLocationUpdate() {
            if (!currentUserId) return;
            updateDiagnostic('warning', 'Forzando actualizaci√≥n...');
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = [
                        position.coords.latitude,
                        position.coords.longitude
                    ];
                    const accuracy = position.coords.accuracy;
                    
                    updateDiagnostic('good', 'Forzado exitoso', accuracy);
                    savePosition(currentUserId, coords, accuracy);
                    
                    showNotification('Ubicaci√≥n actualizada forzosamente', 3000);
                },
                error => {
                    updateDiagnostic('bad', `Forzado fallido: ${getGeolocationErrorText(error)}`);
                    showNotification('Error al forzar ubicaci√≥n', 3000);
                },
                { 
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 0
                }
            );
        }
        
        function centerOnUserLocation() {
            if (lastKnownPosition) {
                map.setView(lastKnownPosition, 16);
                showNotification('Centrado en tu ubicaci√≥n', 2000);
            } else {
                updatePosition(currentUserId);
                showNotification('Buscando tu ubicaci√≥n...', 2000);
            }
        }
        
        function getGeolocationErrorText(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return "Permiso denegado";
                case error.POSITION_UNAVAILABLE:
                    return "Posici√≥n no disponible";
                case error.TIMEOUT:
                    return "Tiempo agotado";
                default:
                    return "Error desconocido";
            }
        }
        
        function updateDiagnostic(status, method, accuracy = null) {
            const statusElement = document.getElementById('gpsStatus');
            const methodElement = document.getElementById('methodValue');
            
            statusElement.textContent = status === 'good' ? 'ACTIVO' : 
                                      status === 'warning' ? 'LIMITADO' : 'INACTIVO';
            statusElement.className = `diagnostic-value ${status}`;
            
            methodElement.textContent = method;
            
            if (accuracy !== null) {
                document.getElementById('accuracyValue').textContent = `${accuracy.toFixed(1)} metros`;
            }
            
            // Mostrar hora local de Chile
            const now = new Date();
            const chileTime = new Date(now.toLocaleString("en-US", {timeZone: "America/Santiago"}));
            document.getElementById('lastUpdateValue').textContent = chileTime.toLocaleTimeString('es-CL');
            
            const locationStatus = document.getElementById('locationStatus');
            if (status === 'good') {
                locationStatus.textContent = 'Ubicaci√≥n activa';
                locationStatus.style.color = 'green';
            } else if (status === 'warning') {
                locationStatus.textContent = 'Ubicaci√≥n limitada';
                locationStatus.style.color = 'orange';
            } else {
                locationStatus.textContent = 'Ubicaci√≥n inactiva';
                locationStatus.style.color = 'red';
            }
        }
        
        function showNotification(message, duration) {
            const notification = document.getElementById('statusNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, duration);
        }
        
        function savePosition(mobileId, coords, accuracy) {
            const now = Date.now();
            lastKnownPosition = coords;
            
            updateUserPositionMarker(coords, accuracy);
            
            if (!isViewer) {
                database.ref(`vehicles/${mobileId}`).set({
                    coords: {
                        lat: coords[0],
                        lng: coords[1]
                    },
                    status: 'online',
                    lastUpdate: now,
                    accuracy: accuracy,
                    displayName: vehicleNames[mobileId] || mobileId
                });
            }
            
            lastUpdateTimes[mobileId] = now;
            updateMarker(mobileId, coords, true);
            updateStatus(mobileId, 'online');
            
            if (currentUserId === 'Admin') {
                checkLapCompletion(mobileId, coords);
                // Almacenar datos de coordenadas
                const laps = lapCounters[mobileId] ? 
                    lapCounters[mobileId].shift1 + lapCounters[mobileId].shift2 + lapCounters[mobileId].shift3 : 0;
                storeCoordinateData(mobileId, coords, 'online', laps);
            }
            
            if (mobileId === currentUserId) {
                map.setView(coords, Math.max(map.getZoom(), 16));
            }
        }
        
        function startMonitoring() {
            fetchVehicleData();
            viewerUpdateInterval = setInterval(fetchVehicleData, UPDATE_INTERVAL);
        }
        
        function fetchVehicleData() {
            database.ref('vehicles').once('value')
                .then(snapshot => {
                    const vehiclesData = snapshot.val() || {};
                    let newDataFound = false;

                    Object.keys(vehiclesData).forEach(mobileId => {
                        const vehicle = vehiclesData[mobileId];
                        if (vehicle && vehicle.lastUpdate) {
                            if (!vehicleCache[mobileId] || vehicle.lastUpdate > vehicleCache[mobileId].lastUpdate) {
                                vehicleCache[mobileId] = vehicle;
                                newDataFound = true;
                                
                                if (currentUserId === 'Admin') {
                                    const coords = [vehicle.coords.lat, vehicle.coords.lng];
                                    checkLapCompletion(mobileId, coords);
                                    
                                    // Almacenar datos de coordenadas
                                    const laps = lapCounters[mobileId] ? 
                                        lapCounters[mobileId].shift1 + lapCounters[mobileId].shift2 + lapCounters[mobileId].shift3 : 0;
                                    storeCoordinateData(mobileId, coords, vehicle.status, laps);
                                }
                            }
                        }
                    });

                    if (newDataFound) {
                        updateMarkersFromCache();
                    } else {
                        console.log('No hay datos nuevos, usando cach√©.');
                        checkConnectionStatus();
                    }
                })
                .catch(error => {
                    console.error("Error al obtener datos de la flota:", error);
                    checkConnectionStatus();
                });
        }
        
        function updateMarkersFromCache() {
            const now = Date.now();
            Object.keys(vehicleCache).forEach(mobileId => {
                const vehicle = vehicleCache[mobileId];
                if (vehicle) {
                    const isOnline = (now - vehicle.lastUpdate) < TEN_MINUTES;
                    const coords = isOnline ? [vehicle.coords.lat, vehicle.coords.lng] : INACTIVE_COORDS;

                    if (vehicle.displayName && vehicle.displayName !== mobileId) {
                        vehicleNames[mobileId] = vehicle.displayName;
                        localStorage.setItem('vehicleNames', JSON.stringify(vehicleNames));
                        const nameElement = document.getElementById(`${mobileId.toLowerCase()}-name`);
                        if (nameElement) {
                            nameElement.textContent = vehicle.displayName;
                        }
                    }

                    updateMarker(mobileId, coords, isOnline);
                    updateStatus(mobileId, isOnline ? 'online' : 'offline');
                }
            });
            
            updateVehicleNamesInUI();
            
            if (currentUserId === 'Admin') {
                updateMetrics();
            }
        }

        function checkConnectionStatus() {
            const now = Date.now();
            Object.keys(vehicleCache).forEach(mobileId => {
                const vehicle = vehicleCache[mobileId];
                if (vehicle) {
                    const lastUpdate = vehicle.lastUpdate || 0;
                    const isOnline = (now - lastUpdate) < TEN_MINUTES;
                    
                    if (!isOnline) {
                        updateStatus(mobileId, 'offline');
                        if (markers[mobileId]) {
                            const icon = L.divIcon({
                                className: 'vehicle-marker offline',
                                html: `
                                    <div class="vehicle-marker offline"></div>
                                    <div class="vehicle-label">${vehicleNames[mobileId] || mobileId}</div>
                                `,
                                iconSize: [32, 42],
                                iconAnchor: [16, 16],
                                popupAnchor: [0, -16]
                            });
                            
                            markers[mobileId]
                                .setIcon(icon)
                                .setLatLng(INACTIVE_COORDS)
                                .setPopupContent(`<b>${vehicleNames[mobileId] || mobileId}</b><br>Desconectado<br>√öltima actualizaci√≥n: ${new Date(lastUpdate).toLocaleTimeString()}`);
                        }
                    }
                }
            });
        }
        
        function createMarker(mobileId, coords, isOnline) {
            if (markers[mobileId]) return;
            const displayName = vehicleNames[mobileId] || mobileId;
            
            const container = L.divIcon({
                className: 'vehicle-marker-container',
                html: `
                    <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                    <div class="vehicle-label">${displayName}</div>
                `,
                iconSize: [32, 42],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });
            
            markers[mobileId] = L.marker(coords, { 
                icon: container,
                title: displayName
            }).addTo(map)
            .bindPopup(`<b>${displayName}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}`);
        }
        
        function updateMarker(mobileId, coords, isOnline) {
            const displayName = vehicleNames[mobileId] || mobileId;
            
            if (!markers[mobileId]) {
                createMarker(mobileId, coords, isOnline);
            } else {
                const container = L.divIcon({
                    className: 'vehicle-marker-container',
                    html: `
                        <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                        <div class="vehicle-label">${displayName}</div>
                    `,
                    iconSize: [32, 42],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                
                markers[mobileId]
                    .setLatLng(coords)
                    .setIcon(container)
                    .setPopupContent(`<b>${displayName}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}<br>√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}`);
            }
        }
        
        function updateStatus(mobileId, status) {
            if (mobileId === currentUserId) {
                const element = document.getElementById('current-user-status');
                const iconElement = document.getElementById('current-user-icon');
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `user-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            } 
            else if (isViewer) {
                const element = document.getElementById(`${mobileId.toLowerCase()}-status`);
                const iconElement = document.getElementById(`${mobileId.toLowerCase()}-icon`);
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            }
        }
        
        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            if (viewerUpdateInterval) clearInterval(viewerUpdateInterval);
            
            if (backgroundGeolocationWatchId !== null) {
                navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
            }
            
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                });
            }
            
            database.ref('vehicles').off();
            firebase.auth().signOut();
            localStorage.removeItem('gpsAuth');
            localStorage.removeItem('panelState');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>










