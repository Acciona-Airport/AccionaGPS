<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f44336">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
            --user-position-color: #3498db;
            --blue-primary: #2196f3;
            --blue-light: #e3f2fd;
            --blue-dark: #1976d2;
            --route1-color: #e74c3c;
            --route2-color: #9b59b6;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background-color: #2c3e50;
            touch-action: pan-x pan-y;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
            pointer-events: none;
        }
        .control-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
        }
        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }
        .toggle-panel {
            background: var(--white);
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
            margin-left: 5px;
            flex-shrink: 0;
            pointer-events: auto;
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }
        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: var(--online-color); }
        .offline { color: var(--offline-color); }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        .diagnostic-panel-container {
            display: none;
        }
        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
        }
        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }
        .refresh-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }
        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.2s;
            pointer-events: auto;
        }
        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .map-provider-selector {
            position: fixed;
            bottom: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .map-provider-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        .status-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            font-size: 14px;
        }
        .current-user-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: var(--red-dark);
        }
        .pulse-circle {
            border-radius: 50%;
            background-color: var(--user-position-color);
            width: 20px;
            height: 20px;
            position: absolute;
            left: -10px;
            top: -10px;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
        .emergency-locate-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--user-position-color);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .accuracy-circle {
            fill: rgba(52, 152, 219, 0.2);
            stroke: rgba(52, 152, 219, 0.5);
            stroke-width: 1;
        }
        .leaflet-control-zoom {
            margin-top: 80px !important;
        }
        .leaflet-bar a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 24px !important;
        }
        .leaflet-container {
            touch-action: manipulation;
        }
        .map-touch-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 100%;
            z-index: 999;
            display: none;
        }
        .control-panel.visible ~ .map-touch-overlay {
            display: block;
        }
        .route-selector {
            position: fixed;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .route-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
            margin-top: 5px;
            width: 100%;
        }
        
        .leaflet-bottom.leaflet-right {
            bottom: 160px;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* Modal para n煤mero de veh铆culo */
        .vehicle-number-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .vehicle-number-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .vehicle-number-form h2 {
            color: var(--red-dark);
            margin-bottom: 20px;
        }
        .vehicle-number-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
        }
        .vehicle-number-input:focus {
            border-color: var(--red-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }
        .vehicle-number-submit {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .vehicle-number-submit:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-touch-overlay" id="mapTouchOverlay"></div>
    
    <div class="status-notification" id="statusNotification"></div>
    
    <div class="current-user-indicator" id="currentUserIndicator">
        <span id="locationStatus">Buscando tu ubicaci贸n...</span>
    </div>

    <div class="diagnostic-panel-container">
        <div class="diagnostic-panel" id="diagnosticPanel">
            <h3 style="margin-top:0;color:var(--blue-dark);"> Diagn贸stico GPS</h3>
            
            <div class="diagnostic-info">
                <div class="diagnostic-item">
                    <span>Estado GPS:</span>
                    <span id="gpsStatus" class="diagnostic-value warning">Comprobando...</span>
                </div>
                <div class="diagnostic-item">
                    <span>Precisi贸n:</span>
                    <span id="accuracyValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>ltima actualizaci贸n:</span>
                    <span id="lastUpdateValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>M茅todo:</span>
                    <span id="methodValue" class="diagnostic-value">--</span>
                </div>
            </div>
            
            <button id="forceLocationBtn" style="margin-top: 15px; width: 100%; padding: 8px; background: var(--blue-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Forzar Ubicaci贸n
            </button>
        </div>
        
        <button class="toggle-diagnostic-panel" id="toggleDiagnosticPanel">
            <div class="diagnostic-hamburger-icon">
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="route-selector">
        <label for="routeSelector">Ruta:</label>
        <select id="routeSelector">
            <option value="none">Sin ruta</option>
            <option value="route1">Ruta 1</option>
            <option value="route2">Ruta 2</option>
        </select>
    </div>

    <button class="emergency-locate-btn" id="emergencyLocateBtn" title="Centrar en mi ubicaci贸n"></button>

    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);"> Flota Acciona</h3>
            
            <div class="vehicle-card">
                <div class="vehicle-name">
                    <div id="current-user-icon" class="vehicle-icon offline"></div>
                    <span id="current-user-name">Mi Ubicaci贸n</span>
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="current-user-status" class="offline">Desconectado</span>
                </div>
                <div class="vehicle-status">
                    <span>Coordenadas:</span>
                    <span id="current-user-coords">--</span>
                </div>
            </div>
            
            <div id="other-vehicles-container" style="display: none;">
                <h4 style="margin: 15px 0 10px 0; color: var(--red-dark);">Carruseles:</h4>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil1-icon" class="vehicle-icon offline"></div>
                        <span id="movil1-name">M贸vil 1</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil1-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil2-icon" class="vehicle-icon offline"></div>
                        <span id="movil2-name">M贸vil 2</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil2-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil3-icon" class="vehicle-icon offline"></div>
                        <span id="movil3-name">M贸vil 3</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil3-status" class="offline">Desconectado</span>
                    </div>
                </div>
                
                <div class="vehicle-card">
                    <div class="vehicle-name">
                        <div id="movil4-icon" class="vehicle-icon offline"></div>
                        <span id="movil4-name">M贸vil 4</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil4-status" class="offline">Desconectado</span>
                    </div>
                </div>
            </div>
            
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi贸n</button>
        </div>
        
        <button class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="refresh-container">
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Actualizar
        </button>
    </div>

    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="esri">Satelital (Recomendada)</option>
            <option value="carto">Cartogr谩fica</option>
            <option value="osm">H铆brida</option>
        </select>
    </div>

    <div class="vehicle-number-modal" id="vehicleNumberModal">
        <div class="vehicle-number-form">
            <h2>Ingrese n煤mero de veh铆culo</h2>
            <input type="text" class="vehicle-number-input" id="vehicleNumberInput" placeholder="Ej: 6142" maxlength="10">
            <button class="vehicle-number-submit" id="vehicleNumberSubmit">Continuar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDT85qotm1EpAJzJzCFeoNwGyo-VKhM6dk",
            authDomain: "gpsaccionascl2025.firebaseapp.com",
            databaseURL: "https://gpsaccionascl2025-default-rtdb.firebaseio.com",
            projectId: "gpsaccionascl2025",
            storageBucket: "gpsaccionascl2025.appspot.com",
            messagingSenderId: "742246618721",
            appId: "1:742246618721:web:72d0046987416800f07c20"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const SCL_COORDS = [-33.3931, -70.7858];
        const INACTIVE_COORDS = [-33.409995, -70.788647];
        const ZOOM_INICIAL = 14;
        let map;
        let currentTileLayer;
        const markers = {};
        const lastUpdateTimes = {};
        const vehicleCache = {};
        let gpsInterval;
        let wakeLock = null;
        let backgroundGeolocationWatchId = null;
        const TEN_MINUTES = 10 * 60 * 1000;
        const UPDATE_INTERVAL = 30000;
        let currentUserId = null;
        let isViewer = false;
        let userPositionMarker = null;
        let userAccuracyCircle = null;
        let lastKnownPosition = null;
        let locationUpdateInterval = null;
        let viewerUpdateInterval = null;
        let currentRouteLayer = null;
        let vehicleNames = {};
        
        const route1Coordinates = [
            [-33.4095444, -70.7893019],
            [-33.4092635, -70.7895518],
            [-33.404626, -70.7897795],
            [-33.4045659, -70.7889574],
            [-33.3965734, -70.7893183],
            [-33.3966737, -70.7910012],
            [-33.3970831, -70.790958],
            [-33.3971273, -70.7919677],
            [-33.4013289, -70.7917774],
            [-33.401446, -70.795415],
            [-33.399824, -70.7955015],
            [-33.3998119, -70.7961745],
            [-33.3963198, -70.796343],
            [-33.3960964, -70.7894296],
            [-33.3966985, -70.7893961],
            [-33.3967748, -70.7909972],
            [-33.3971721, -70.7909347],
            [-33.3972203, -70.792002],
            [-33.4045345, -70.7915771],
            [-33.4044984, -70.7897934],
            [-33.40931, -70.7895175],
            [-33.4096593, -70.7891232]
        ];
        const route2Coordinates = [
            [-33.4096489, -70.7892732],
            [-33.4093416, -70.7895579],
            [-33.4046013, -70.7898303],
            [-33.4045362, -70.7889762],
            [-33.3966243, -70.7893156],
            [-33.396535, -70.7894658],
            [-33.3960629, -70.7895151],
            [-33.3963403, -70.7977141],
            [-33.3964389, -70.7977093],
            [-33.3961615, -70.7895498],
            [-33.3966124, -70.7895158],
            [-33.3966597, -70.7909835],
            [-33.3970632, -70.7911581],
            [-33.3970881, -70.7919946],
            [-33.4044896, -70.7915298],
            [-33.4044823, -70.789894],
            [-33.4092579, -70.7896023],
            [-33.4096104, -70.7892531]
        ];
        const mapProviders = {
            esri: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            },
            carto: {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            },
            osm: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }
        };

        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                if (!auth) window.location.href = 'login.html';
                
                currentUserId = auth.username;
                isViewer = auth.isViewer;
                
                const savedVehicleNames = localStorage.getItem('vehicleNames');
                if (savedVehicleNames) {
                    vehicleNames = JSON.parse(savedVehicleNames);
                }
                
                initMap();
                setupUI();
                
                if (!isViewer && !auth.vehicleNumber) {
                    document.getElementById('vehicleNumberModal').style.display = 'flex';
                } else {
                    document.getElementById('vehicleNumberModal').style.display = 'none';
                    setupAfterVehicleNumber();
                }
            }
        });

        function setupAfterVehicleNumber() {
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            if (auth.vehicleNumber) {
                vehicleNames[currentUserId] = auth.vehicleNumber;
                localStorage.setItem('vehicleNames', JSON.stringify(vehicleNames));
            }
            
            document.getElementById('current-user-name').textContent = 
                vehicleNames[currentUserId] || currentUserId;
            
            if (isViewer) {
                document.getElementById('other-vehicles-container').style.display = 'block';
                updateVehicleNamesInUI();
                initializeAllMarkers();
                startMonitoring();
            } else {
                initializeCurrentUserMarker();
                startGPSTracking(currentUserId);
            }
        }
        
        function updateVehicleNamesInUI() {
            for (let i = 1; i <= 4; i++) {
                const mobileId = 'Movil' + i;
                const element = document.getElementById(`${mobileId.toLowerCase()}-name`);
                if (element && vehicleNames[mobileId]) {
                    element.textContent = vehicleNames[mobileId];
                }
            }
        }
        
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                tap: false,
                dragging: true
            }).setView(SCL_COORDS, ZOOM_INICIAL);
            L.control.zoom({
                position: 'bottomright'
            }).addTo(map);
            const savedProvider = localStorage.getItem('mapProvider') || 'esri';
            document.getElementById('mapProvider').value = savedProvider;
            setMapProvider(savedProvider);
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('锔 Aeropuerto SCL')
                .openPopup();
            createUserPositionMarker(SCL_COORDS);
            
            if (L.Browser.touch) {
                map.doubleClickZoom.disable();
            }
        }
        
        function setMapProvider(providerKey) {
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            const provider = mapProviders[providerKey];
            currentTileLayer = L.tileLayer(provider.url, {
                attribution: provider.attribution,
                maxZoom: provider.maxZoom
            }).addTo(map);
            localStorage.setItem('mapProvider', providerKey);
        }
        
        function setupUI() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            const panel = document.getElementById('controlPanel');
            const toggleBtn = document.getElementById('togglePanel');
            
            toggleBtn.addEventListener('click', function() {
                panel.classList.toggle('visible');
            });
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', function() {
                refreshBtn.classList.add('loading');
                
                if (isViewer) {
                    fetchVehicleData();
                }
                
                setTimeout(() => {
                    const isPanelVisible = panel.classList.contains('visible');
                    localStorage.setItem('panelState', isPanelVisible ? 'open' : 'closed');
                    refreshBtn.classList.remove('loading');
                }, 500);
            });
            document.getElementById('mapProvider').addEventListener('change', function(e) {
                setMapProvider(e.target.value);
            });
            document.getElementById('routeSelector').addEventListener('change', function(e) {
                showRoute(e.target.value);
            });
            document.getElementById('forceLocationBtn').addEventListener('click', function() {
                forceLocationUpdate();
            });
            document.getElementById('emergencyLocateBtn').addEventListener('click', function() {
                centerOnUserLocation();
            });
            
            document.getElementById('vehicleNumberSubmit').addEventListener('click', function() {
                const vehicleNumber = document.getElementById('vehicleNumberInput').value.trim();
                
                if (!vehicleNumber) {
                    alert('Por favor ingrese un n煤mero de veh铆culo');
                    return;
                }
                
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                auth.vehicleNumber = vehicleNumber;
                localStorage.setItem('gpsAuth', JSON.stringify(auth));
                
                document.getElementById('vehicleNumberModal').style.display = 'none';
                setupAfterVehicleNumber();
            });
            
            document.getElementById('vehicleNumberInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('vehicleNumberSubmit').click();
                }
            });
            document.addEventListener('visibilitychange', handleVisibilityChange);
            
            if ('wakeLock' in navigator) {
                document.addEventListener('visibilitychange', async () => {
                    if (document.visibilityState === 'visible') {
                        await requestWakeLock();
                    }
                });
            }
            
            const mapTouchOverlay = document.getElementById('mapTouchOverlay');
            mapTouchOverlay.addEventListener('click', function() {
                panel.classList.remove('visible');
            });
        }
        
        function showRoute(routeId) {
            if (currentRouteLayer) {
                map.removeLayer(currentRouteLayer);
                currentRouteLayer = null;
            }
            
            if (routeId === 'none') return;
            let coordinates;
            let color;
            
            if (routeId === 'route1') {
                coordinates = route1Coordinates;
                color = '#e74c3c';
            } else if (routeId === 'route2') {
                coordinates = route2Coordinates;
                color = '#9b59b6';
            }
            
            currentRouteLayer = L.polyline(coordinates, {
                color: color,
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map);
            
            const bounds = L.latLngBounds(coordinates);
            map.fitBounds(bounds, { padding: [50, 50] });
        }
        
        function handleVisibilityChange() {
            const notification = document.getElementById('statusNotification');
            if (document.visibilityState === 'visible') {
                notification.textContent = 'Aplicaci贸n en primer plano';
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 3000);
                if (!isViewer) {
                    forceLocationUpdate();
                }
            } else {
                notification.textContent = 'Aplicaci贸n en segundo plano - El GPS sigue activo';
                notification.style.display = 'block';
                setTimeout(() => { notification.style.display = 'none'; }, 3000);
            }
        }
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                    });
                }
            } catch (err) {
            }
        }
        
        function initializeAllMarkers() {
            const mobileIds = ['Movil1', 'Movil2', 'Movil3', 'Movil4'];
            mobileIds.forEach(mobileId => {
                createMarker(mobileId, INACTIVE_COORDS, false);
                lastUpdateTimes[mobileId] = Date.now();
            });
        }
        
        function initializeCurrentUserMarker() {
            createMarker(currentUserId, INACTIVE_COORDS, false);
            lastUpdateTimes[currentUserId] = Date.now();
        }
        
        function createUserPositionMarker(coords) {
            if (userPositionMarker) {
                map.removeLayer(userPositionMarker);
            }
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            
            const userIcon = L.divIcon({
                className: 'user-position-marker',
                html: `
                    <div style="background-color: #3498db; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>
                    <div class="pulse-circle"></div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            userPositionMarker = L.marker(coords, { icon: userIcon, zIndexOffset: 1000 })
                .addTo(map)
                .bindPopup('<b>Tu ubicaci贸n actual</b>');
            map.setView(coords, 16);
        }
        
        function updateUserPositionMarker(coords, accuracy) {
            if (!userPositionMarker) {
                createUserPositionMarker(coords);
            } else {
                userPositionMarker.setLatLng(coords);
            }
            
            if (userAccuracyCircle) {
                map.removeLayer(userAccuracyCircle);
            }
            
            if (accuracy && accuracy < 1000) {
                userAccuracyCircle = L.circle(coords, {
                    radius: accuracy,
                    className: 'accuracy-circle'
                }).addTo(map);
            }
            
            document.getElementById('current-user-coords').textContent = 
                `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
            document.getElementById('accuracyValue').textContent = 
                accuracy ? `${accuracy.toFixed(1)} metros` : 'Desconocida';
            document.getElementById('lastUpdateValue').textContent = new Date().toLocaleTimeString();
        }
        
        function startGPSTracking(mobileId) {
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            
            requestWakeLock();
            
            updatePosition(mobileId);
            
            locationUpdateInterval = setInterval(() => {
                updatePosition(mobileId);
            }, 60000);
            setupBackgroundGeolocation(mobileId);
            
            setTimeout(() => updatePosition(mobileId), 2000);
        }
        
        function setupBackgroundGeolocation(mobileId) {
            if ('geolocation' in navigator) {
                const geoOptions = {
                    enableHighAccuracy: true,
                    maximumAge: 10000,
                    timeout: 10000
                };
                if (backgroundGeolocationWatchId !== null) {
                    navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
                }
                
                backgroundGeolocationWatchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const coords = [
                            position.coords.latitude,
                            position.coords.longitude
                        ];
                        const accuracy = position.coords.accuracy;
                        
                        updateDiagnostic('good', 'watchPosition', accuracy);
                        savePosition(mobileId, coords, accuracy);
                    },
                    (error) => {
                        updateDiagnostic('bad', `Error: ${getGeolocationErrorText(error)}`);
                        updateStatus(mobileId, 'offline');
                    },
                    geoOptions
                );
            } else {
                updateDiagnostic('bad', 'Geolocalizaci贸n no soportada');
            }
        }
        
        function updatePosition(mobileId) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const coords = [
                            position.coords.latitude,
                            position.coords.longitude
                        ];
                        const accuracy = position.coords.accuracy;
                        
                        updateDiagnostic('good', 'getCurrentPosition', accuracy);
                        savePosition(mobileId, coords, accuracy);
                    },
                    error => {
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                const coords = [
                                    position.coords.latitude,
                                    position.coords.longitude
                                ];
                                const accuracy = position.coords.accuracy;
                                
                                updateDiagnostic('warning', 'M茅todo alternativo', accuracy);
                                savePosition(mobileId, coords, accuracy);
                            },
                            error2 => {
                                console.error('Error GPS con m茅todo alternativo:', error2);
                                updateDiagnostic('bad', `Error: ${getGeolocationErrorText(error2)}`);
                                updateStatus(mobileId, 'offline');
                                
                                if (lastKnownPosition) {
                                    updateDiagnostic('warning', 'Usando 煤ltima posici贸n conocida');
                                    savePosition(mobileId, lastKnownPosition, 1000);
                                }
                            },
                            { 
                                enableHighAccuracy: false,
                                timeout: 15000,
                                maximumAge: 300000
                            }
                        );
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                updateDiagnostic('bad', 'Geolocalizaci贸n no soportada');
                alert("Tu navegador no soporta geolocalizaci贸n");
            }
        }
        
        function forceLocationUpdate() {
            if (!currentUserId) return;
            updateDiagnostic('warning', 'Forzando actualizaci贸n...');
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = [
                        position.coords.latitude,
                        position.coords.longitude
                    ];
                    const accuracy = position.coords.accuracy;
                    
                    updateDiagnostic('good', 'Forzado exitoso', accuracy);
                    savePosition(currentUserId, coords, accuracy);
                    
                    showNotification('Ubicaci贸n actualizada forzosamente', 3000);
                },
                error => {
                    updateDiagnostic('bad', `Forzado fallido: ${getGeolocationErrorText(error)}`);
                    showNotification('Error al forzar ubicaci贸n', 3000);
                },
                { 
                    enableHighAccuracy: true,
                    timeout: 20000,
                    maximumAge: 0
                }
            );
        }
        
        function centerOnUserLocation() {
            if (lastKnownPosition) {
                map.setView(lastKnownPosition, 16);
                showNotification('Centrado en tu ubicaci贸n', 2000);
            } else {
                updatePosition(currentUserId);
                showNotification('Buscando tu ubicaci贸n...', 2000);
            }
        }
        
        function getGeolocationErrorText(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    return "Permiso denegado";
                case error.POSITION_UNAVAILABLE:
                    return "Posici贸n no disponible";
                case error.TIMEOUT:
                    return "Tiempo agotado";
                default:
                    return "Error desconocido";
            }
        }
        
        function updateDiagnostic(status, method, accuracy = null) {
            const statusElement = document.getElementById('gpsStatus');
            const methodElement = document.getElementById('methodValue');
            
            statusElement.textContent = status === 'good' ? 'ACTIVO' : 
                                      status === 'warning' ? 'LIMITADO' : 'INACTIVO';
            statusElement.className = `diagnostic-value ${status}`;
            
            methodElement.textContent = method;
            if (accuracy !== null) {
                document.getElementById('accuracyValue').textContent = `${accuracy.toFixed(1)} metros`;
            }
            
            document.getElementById('lastUpdateValue').textContent = new Date().toLocaleTimeString();
            const locationStatus = document.getElementById('locationStatus');
            if (status === 'good') {
                locationStatus.textContent = 'Ubicaci贸n activa';
                locationStatus.style.color = 'green';
            } else if (status === 'warning') {
                locationStatus.textContent = 'Ubicaci贸n limitada';
                locationStatus.style.color = 'orange';
            } else {
                locationStatus.textContent = 'Ubicaci贸n inactiva';
                locationStatus.style.color = 'red';
            }
        }
        
        function showNotification(message, duration) {
            const notification = document.getElementById('statusNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, duration);
        }
        
        function savePosition(mobileId, coords, accuracy) {
            const now = Date.now();
            lastKnownPosition = coords;
            
            updateUserPositionMarker(coords, accuracy);
            
            if (!isViewer) {
                database.ref(`vehicles/${mobileId}`).set({
                    coords: {
                        lat: coords[0],
                        lng: coords[1]
                    },
                    status: 'online',
                    lastUpdate: now,
                    accuracy: accuracy,
                    displayName: vehicleNames[mobileId] || mobileId
                });
            }
            
            lastUpdateTimes[mobileId] = now;
            updateMarker(mobileId, coords, true);
            updateStatus(mobileId, 'online');
            
            if (mobileId === currentUserId) {
                map.setView(coords, Math.max(map.getZoom(), 16));
            }
        }
        
        function startMonitoring() {
            fetchVehicleData();
            viewerUpdateInterval = setInterval(fetchVehicleData, UPDATE_INTERVAL);
        }
        
        function fetchVehicleData() {
            database.ref('vehicles').once('value')
                .then(snapshot => {
                    const vehiclesData = snapshot.val() || {};
                    let newDataFound = false;

                    Object.keys(vehiclesData).forEach(mobileId => {
                        const vehicle = vehiclesData[mobileId];
                        if (vehicle && vehicle.lastUpdate) {
                            if (!vehicleCache[mobileId] || vehicle.lastUpdate > vehicleCache[mobileId].lastUpdate) {
                                vehicleCache[mobileId] = vehicle;
                                newDataFound = true;
                            }
                        }
                    });

                    if (newDataFound) {
                        updateMarkersFromCache();
                    } else {
                        console.log('No hay datos nuevos, usando cach茅.');
                        checkConnectionStatus();
                    }
                })
                .catch(error => {
                    console.error("Error al obtener datos de la flota:", error);
                    checkConnectionStatus();
                });
        }
        
        function updateMarkersFromCache() {
            const now = Date.now();
            Object.keys(vehicleCache).forEach(mobileId => {
                const vehicle = vehicleCache[mobileId];
                if (vehicle) {
                    const isOnline = (now - vehicle.lastUpdate) < TEN_MINUTES;
                    const coords = isOnline ? [vehicle.coords.lat, vehicle.coords.lng] : INACTIVE_COORDS;

                    if (vehicle.displayName && vehicle.displayName !== mobileId) {
                        vehicleNames[mobileId] = vehicle.displayName;
                        localStorage.setItem('vehicleNames', JSON.stringify(vehicleNames));
                        const nameElement = document.getElementById(`${mobileId.toLowerCase()}-name`);
                        if (nameElement) {
                            nameElement.textContent = vehicle.displayName;
                        }
                    }

                    updateMarker(mobileId, coords, isOnline);
                    updateStatus(mobileId, isOnline ? 'online' : 'offline');
                }
            });
            updateVehicleNamesInUI();
        }

        function checkConnectionStatus() {
            const now = Date.now();
            Object.keys(vehicleCache).forEach(mobileId => {
                const vehicle = vehicleCache[mobileId];
                if (vehicle) {
                    const lastUpdate = vehicle.lastUpdate || 0;
                    const isOnline = (now - lastUpdate) < TEN_MINUTES;
                    
                    if (!isOnline) {
                        updateStatus(mobileId, 'offline');
                        if (markers[mobileId]) {
                            const icon = L.divIcon({
                                className: 'vehicle-marker offline',
                                html: `
                                    <div class="vehicle-marker offline"></div>
                                    <div class="vehicle-label">${vehicleNames[mobileId] || mobileId}</div>
                                `,
                                iconSize: [32, 42],
                                iconAnchor: [16, 16],
                                popupAnchor: [0, -16]
                            });
                            markers[mobileId]
                                .setIcon(icon)
                                .setLatLng(INACTIVE_COORDS)
                                .setPopupContent(`<b>${vehicleNames[mobileId] || mobileId}</b><br>Desconectado<br>ltima actualizaci贸n: ${new Date(lastUpdate).toLocaleTimeString()}`);
                        }
                    }
                }
            });
        }
        
        function createMarker(mobileId, coords, isOnline) {
            if (markers[mobileId]) return;
            const displayName = vehicleNames[mobileId] || mobileId;
            
            const container = L.divIcon({
                className: 'vehicle-marker-container',
                html: `
                    <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                    <div class="vehicle-label">${displayName}</div>
                `,
                iconSize: [32, 42],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16]
            });
            markers[mobileId] = L.marker(coords, { 
                icon: container,
                title: displayName
            }).addTo(map)
            .bindPopup(`<b>${displayName}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}`);
        }
        
        function updateMarker(mobileId, coords, isOnline) {
            const displayName = vehicleNames[mobileId] || mobileId;
            
            if (!markers[mobileId]) {
                createMarker(mobileId, coords, isOnline);
            } else {
                const container = L.divIcon({
                    className: 'vehicle-marker-container',
                    html: `
                        <div class="vehicle-marker ${isOnline ? 'online' : 'offline'}"></div>
                        <div class="vehicle-label">${displayName}</div>
                    `,
                    iconSize: [32, 42],
                    iconAnchor: [16, 16],
                    popupAnchor: [0, -16]
                });
                markers[mobileId]
                    .setLatLng(coords)
                    .setIcon(container)
                    .setPopupContent(`<b>${displayName}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}<br>ltima actualizaci贸n: ${new Date().toLocaleTimeString()}`);
            }
        }
        
        function updateStatus(mobileId, status) {
            if (mobileId === currentUserId) {
                const element = document.getElementById('current-user-status');
                const iconElement = document.getElementById('current-user-icon');
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            } 
            else if (isViewer) {
                const element = document.getElementById(`${mobileId.toLowerCase()}-status`);
                const iconElement = document.getElementById(`${mobileId.toLowerCase()}-icon`);
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            }
        }
        
        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            if (viewerUpdateInterval) clearInterval(viewerUpdateInterval);
            if (backgroundGeolocationWatchId !== null) {
                navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
            }
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                });
            }
            database.ref('vehicles').off();
            firebase.auth().signOut();
            localStorage.removeItem('gpsAuth');
            localStorage.removeItem('panelState');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
