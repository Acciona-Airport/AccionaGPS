<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f44336">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
            --user-position-color: #3498db;
            --blue-primary: #2196f3;
            --blue-light: #e3f2fd;
            --blue-dark: #1976d2;
            --route1-color: #e74c3c;
            --route2-color: #9b59b6;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background-color: #2c3e50;
            touch-action: pan-x pan-y;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
            pointer-events: none;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
        }

        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }

        .toggle-panel {
            background: var(--white);
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0, 0, 0, 0.1);
            margin-left: 5px;
            flex-shrink: 0;
            pointer-events: auto;
        }

        .toggle-panel:hover {
            background: var(--red-light);
        }

        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }

        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }

        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }

        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(2) {
            opacity: 0;
        }

        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }

        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }

        .vehicle-card:last-child {
            border-bottom: none;
        }

        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }

        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }

        .online {
            color: var(--online-color);
        }

        .offline {
            color: var(--offline-color);
        }

        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: var(--red-dark);
        }

        .diagnostic-panel-container {
            display: none;
        }

        .user-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin-right: 8px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
        }

        .user-icon.online {
            background-color: var(--online-color);
        }

        .user-icon.offline {
            background-color: var(--offline-color);
            opacity: 0.7;
        }

        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            margin-right: 8px;
        }

        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }

        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }

        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }

        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }

        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }

        .refresh-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }

        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: background 0.3s, transform 0.2s;
            pointer-events: auto;
        }

        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }

        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .map-provider-selector {
            position: fixed;
            bottom: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }

        .map-provider-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }

        .status-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            font-size: 14px;
        }

        .current-user-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            font-weight: bold;
            color: var(--red-dark);
        }

        .pulse-circle {
            border-radius: 50%;
            background-color: var(--user-position-color);
            width: 20px;
            height: 20px;
            position: absolute;
            left: -10px;
            top: -10px;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.8);
                opacity: 0.6;
            }

            70% {
                transform: scale(2.5);
                opacity: 0;
            }

            100% {
                transform: scale(0.8);
                opacity: 0;
            }
        }

        .emergency-locate-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--user-position-color);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .accuracy-circle {
            fill: rgba(52, 152, 219, 0.2);
            stroke: rgba(52, 152, 219, 0.5);
            stroke-width: 1;
        }

        .leaflet-control-zoom {
            margin-top: 80px !important;
        }

        .leaflet-bar a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 24px !important;
        }

        .leaflet-container {
            touch-action: manipulation;
        }

        .map-touch-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 100%;
            z-index: 999;
            display: none;
        }

        .control-panel.visible ~ .map-touch-overlay {
            display: block;
        }

        .route-selector {
            position: fixed;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            font-size: 12px;
        }

        .route-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
            margin-top: 5px;
            width: 100%;
        }

        .leaflet-bottom.leaflet-right {
            bottom: 160px;
        }

        .leaflet-control-attribution {
            display: none !important;
        }

        .vehicle-number-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .vehicle-number-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .vehicle-number-form h2 {
            color: var(--red-dark);
            margin-bottom: 20px;
        }

        .vehicle-number-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
        }

        .vehicle-number-input:focus {
            border-color: var(--red-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }

        .vehicle-number-submit {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .vehicle-number-submit:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        #adminPanel {
            background: var(--gray-light);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        #adminPanel h4 {
            color: var(--blue-dark);
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        #adminPanel p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .metric-card {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .metric-title {
            font-weight: 600;
            color: var(--blue-dark);
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .metric-card ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .metric-card li {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }

        .metric-card li.highlight {
            font-weight: bold;
            color: var(--online-color);
        }

        #vehicles-list li {
            list-style: none;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #vehicles-list li:hover {
            background-color: #f0f0f0;
        }
        
    </style>
</head>

<body>
    <div id="map"></div>
    <div class="map-touch-overlay" id="mapTouchOverlay"></div>

    <div class="status-notification" id="statusNotification"></div>

    <div class="current-user-indicator" id="currentUserIndicator">
        <span id="locationStatus">Buscando tu ubicación...</span>
    </div>

    <div class="diagnostic-panel-container">
        <div class="diagnostic-panel" id="diagnosticPanel">
            <h3 style="margin-top:0;color:var(--blue-dark);">📊 Diagnóstico GPS</h3>

            <div class="diagnostic-info">
                <div class="diagnostic-item">
                    <span>Estado GPS:</span>
                    <span id="gpsStatus" class="diagnostic-value warning">Comprobando...</span>
                </div>
                <div class="diagnostic-item">

                    <span>Precisión:</span>
                    <span id="accuracyValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>Última actualización:</span>

                    <span id="lastUpdateValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>Método:</span>
                    <span id="methodValue" class="diagnostic-value">--</span>

                </div>
            </div>

            <button id="forceLocationBtn" style="margin-top: 15px;
width: 100%; padding: 8px; background: var(--blue-primary); color: white; border: none; border-radius: 6px; cursor: pointer;
font-weight: 600;">
                Forzar Ubicación
            </button>
        </div>

        <button class="toggle-diagnostic-panel" id="toggleDiagnosticPanel">
            <div class="diagnostic-hamburger-icon">
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="route-selector">
        <label for="routeSelector">Ruta:</label>
        <select id="routeSelector">
            <option value="none">Sin ruta</option>
            <option value="route1">Ruta 1</option>
            <option value="route2">Ruta 2</option>
        </select>
    </div>

    <button class="emergency-locate-btn" id="emergencyLocateBtn" title="Centrar en mi ubicación">📍</button>

    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);">🚗 Flota Acciona</h3>

            <div id="user-info-panel" class="vehicle-card">
                <div class="vehicle-name">
                    <div id="current-user-icon" class="user-icon offline"></div>
                    <span id="current-user-name">Mi Ubicación</span>
                </div>
                <div class="vehicle-status">
                    <span>Estado:</span>
                    <span id="current-user-status" class="offline">Desconectado</span>
                </div>
                <div class="vehicle-status">
                    <span>Coordenadas:</span>
                    <span id="current-user-coords">--</span>
                </div>
            </div>

            <div id="adminPanel" style="display: none;">
                <h4>Dashboard de Administrador</h4>
                <div class="metric-card">
                    <span class="metric-title">Vueltas por Equipo</span>
                    <ul id="lapCountList"></ul>
                </div>
                <div class="metric-card">
                    <span class="metric-title">Métricas Adicionales</span>
                    <div id="additionalMetrics">
                        <p><strong>Vueltas totales hoy:</strong> <span id="totalLapsToday">0</span></p>
                        <p><strong>Tramos horarios:</strong></p>
                        <ul>
                            <li id="shift1-laps">13:00 - 22:00: 0 vueltas</li>
                            <li id="shift2-laps">22:00 - 06:00: 0 vueltas</li>
                            <li id="shift3-laps">06:00 - 13:00: 0 vueltas</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="other-vehicles-container" style="display: none;">
                <h4 style="margin: 15px 0 10px 0; color: var(--red-dark);">Carruseles:</h4>
                <ul id="vehicles-list"></ul>
            </div>

            <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
        </div>

        <button class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="refresh-container">
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
            </svg>
            Actualizar
        </button>
    </div>

    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="esri">Satelital (Recomendada)</option>
            <option value="carto">Cartográfica</option>
            <option value="osm">Híbrida</option>
        </select>
    </div>

    <div class="vehicle-number-modal" id="vehicleNumberModal">
        <div class="vehicle-number-form">
            <h2>Ingrese número de vehículo</h2>
            <input type="text" class="vehicle-number-input" id="vehicleNumberInput" placeholder="Ej: 6142" maxlength="10">
            <button class="vehicle-number-submit" id="vehicleNumberSubmit">Continuar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDT85qotm1EpAJzJzCFeoNwGyo-VKhM6dk",
            authDomain: "gpsaccionascl2025.firebaseapp.com",
            databaseURL: "https://gpsaccionascl2025-default-rtdb.firebaseio.com",
            projectId: "gpsaccionascl2025",
            storageBucket: "gpsaccionascl2025.appspot.com",
            messagingSenderId: "742246618721",
            appId: "1:742246618721:web:72d0046987416800f07c20"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const SCL_COORDS = [-33.3931, -70.7858];
        const INACTIVE_COORDS = [-33.409995, -70.788647];
        const ZOOM_INICIAL = 14;
        let map;
        let currentTileLayer;
        const markers = {};
        const lastUpdateTimes = {};
        const vehicleCache = {};
        let gpsInterval;
        let wakeLock = null;
        let backgroundGeolocationWatchId = null;
        const TEN_MINUTES = 10 * 60 * 1000;
        const UPDATE_INTERVAL = 30000;
        let currentUserId = null;
        let isViewer = false;
        let userPositionMarker = null;
        let userAccuracyCircle = null;
        let lastKnownPosition = null;
        let locationUpdateInterval = null;
        let viewerUpdateInterval = null;
        let currentRouteLayer = null;
        let vehicleNames = {};

        const CHECKPOINT_COORDS = [-33.409455, -70.789421];
        const MIN_LAP_DISTANCE_METERS = 5000;
        const PROXIMITY_RADIUS_METERS = 50;
        const vehicleLapStates = {};
        const SHIFTS = {
            'shift1': {
                start: 13,
                end: 22
            },
            'shift2': {
                start: 22,
                end: 6
            },
            'shift3': {
                start: 6,
                end: 13
            }
        };

        const route1Coordinates = [
            [-33.4095444, -70.7893019],
            [-33.4092635, -70.7895518],
            [-33.404626, -70.7897795],
            [-33.4045659, -70.7889574],
            [-33.3965734, -70.7893183],
            [-33.3966737, -70.7910012],
            [-33.3970831, -70.790958],
            [-33.3971273, -70.7919677],
            [-33.4013289, -70.7917774],
            [-33.401446, -70.795415],
            [-33.399824, -70.7955015],
            [-33.3998119, -70.7961745],
            [-33.3963198, -70.796343],
            [-33.3960964, -70.7894296],
            [-33.3966985, -70.7893961],
            [-33.3967748, -70.7909972],
            [-33.3971721, -70.7909347],
            [-33.3972203, -70.792002],
            [-33.4045345, -70.7915771],
            [-33.4044984, -70.7897934],
            [-33.40931, -70.7895175],
            [-33.4096593, -70.7891232]
        ];
        const route2Coordinates = [
            [-33.4096489, -70.7892732],
            [-33.4093416, -70.7895579],
            [-33.4046013, -70.7898303],
            [-33.4045362, -70.7889762],
            [-33.3966243, -70.7893156],
            [-33.396535, -70.7894658],
            [-33.3960629, -70.7895151],
            [-33.3963403, -70.7977141],
            [-33.3964389, -70.7977093],
            [-33.3961615, -70.7895498],
            [-33.3966124, -70.7895158],
            [-33.3966597, -70.7909835],
            [-33.3970632, -70.7911581],
            [-33.3970881, -70.7919946],
            [-33.4044896, -70.7915298],
            [-33.4044823, -70.789894],
            [-33.4092579, -70.7896023],
            [-33.4096104, -70.7892531]
        ];
        const mapProviders = {
            esri: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 19
            },
            carto: {
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="https://carto.com/attributions">CARTO</a>',
                maxZoom: 20
            },
            osm: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }
        };

        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            } else {
                const auth = JSON.parse(localStorage.getItem('gpsAuth'));
                if (!auth) window.location.href = 'login.html';
                currentUserId = auth.username;
                isViewer = auth.isViewer;
                const isAdmin = auth.isAdmin;
                const savedVehicleNames = localStorage.getItem('vehicleNames');
                if (savedVehicleNames) {
                    vehicleNames = JSON.parse(savedVehicleNames);
                }
                initMap();
                setupUI(isAdmin);
                if (!isViewer && !isAdmin && !auth.vehicleNumber) {
                    document.getElementById('vehicleNumberModal').style.display = 'flex';
                } else {
                    document.getElementById('vehicleNumberModal').style.display = 'none';
                    setupAfterVehicleNumber(isAdmin);
                }
            }
        });

        function setupAfterVehicleNumber(isAdmin) {
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            if (auth.vehicleNumber) {
                vehicleNames[currentUserId] = auth.vehicleNumber;
                localStorage.setItem('vehicleNames', JSON.stringify(vehicleNames));
            }
            const displayName = (currentUserId === 'Funcionarios') ? 'Yo' : (vehicleNames[currentUserId] || currentUserId);
            document.getElementById('current-user-name').textContent = displayName;

            if (isAdmin) {
                document.getElementById('adminPanel').style.display = 'block';
                document.getElementById('other-vehicles-container').style.display = 'block';
                document.getElementById('user-info-panel').style.display = 'none';
                document.getElementById('currentUserIndicator').style.display = 'none';
                updateVehicleNamesInUI();
                initializeAllMarkers();
                startMonitoring(true);
                database.ref('laps').on('value', (snapshot) => {
                    const lapData = snapshot.val() || {};
                    updateAdminDashboard(lapData);
                });
            } else if (isViewer) {
                document.getElementById('other-vehicles-container').style.display = 'block';
                document.getElementById('user-info-panel').style.display = 'none';
                document.getElementById('currentUserIndicator').style.display = 'none';
                updateVehicleNamesInUI();
                initializeAllMarkers();
                startMonitoring();
            } else {
                initializeCurrentUserMarker();
                startGPSTracking(currentUserId);
                startMonitoring();
            }
        }

        function updateAdminDashboard(lapData) {
            const today = new Date().toISOString().slice(0, 10);
            const todayData = lapData[today] || {};
            const lapCountList = document.getElementById('lapCountList');
            const totalLapsTodaySpan = document.getElementById('totalLapsToday');

            lapCountList.innerHTML = '';

            const allTeamsLaps = {};
            let totalLaps = 0;
            const shiftLaps = {
                'shift1': 0,
                'shift2': 0,
                'shift3': 0
            };

            Object.entries(todayData).forEach(([shift, shiftData]) => {
                Object.entries(shiftData).forEach(([team, laps]) => {
                    allTeamsLaps[team] = (allTeamsLaps[team] || 0) + laps;
                    shiftLaps[shift] += laps;
                    totalLaps += laps;
                });
            });

            if (Object.keys(allTeamsLaps).length > 0) {
                Object.entries(allTeamsLaps).forEach(([team, laps]) => {
                    const li = document.createElement('li');
                    li.textContent = `Vueltas del equipo ${team}: ${laps}`;
                    lapCountList.appendChild(li);
                });
            } else {
                lapCountList.textContent = 'No hay vueltas registradas hoy.';
            }

            totalLapsTodaySpan.textContent = totalLaps;
            document.getElementById('shift1-laps').textContent = `13:00 - 22:00: ${shiftLaps.shift1} vueltas`;
            document.getElementById('shift2-laps').textContent = `22:00 - 06:00: ${shiftLaps.shift2} vueltas`;
            document.getElementById('shift3-laps').textContent = `06:00 - 13:00: ${shiftLaps.shift3} vueltas`;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                Math.cos(φ1) * Math.cos(φ2) *
                Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function getCurrentShift() {
            const now = new Date();
            const hour = now.getHours();
            if (hour >= 13 && hour < 22) return 'shift1';
            if (hour >= 22 || hour < 6) return 'shift2';
            return 'shift3';
        }

        function incrementLapCount(vehicleId, currentCoords) {
            const today = new Date().toISOString().slice(0, 10);
            const currentShift = getCurrentShift();
            const lapsRef = database.ref(`laps/${today}/${currentShift}/${vehicleId}`);
            const lapState = vehicleLapStates[vehicleId] || {};
            const lastLapCoords = lapState.lastLapCoords;

            if (lastLapCoords) {
                const distanceSinceLastLap = getDistance(lastLapCoords[0], lastLapCoords[1], currentCoords[0], currentCoords[1]);
                if (distanceSinceLastLap < MIN_LAP_DISTANCE_METERS) {
                    return;
                }
            }
            lapsRef.transaction(currentLaps => (currentLaps || 0) + 1);
            vehicleLapStates[vehicleId].lastLapCoords = currentCoords;
        }

        function checkAndCountLap(vehicleId, currentCoords) {
            if (!vehicleLapStates[vehicleId]) {
                vehicleLapStates[vehicleId] = {
                    isNearCheckpoint: false,
                    lastLapCoords: currentCoords
                };
            }
            const distance = getDistance(currentCoords[0], currentCoords[1], CHECKPOINT_COORDS[0], CHECKPOINT_COORDS[1]);
            const isNowNear = distance <= PROXIMITY_RADIUS_METERS;

            if (isNowNear && !vehicleLapStates[vehicleId].isNearCheckpoint) {
                incrementLapCount(vehicleId, currentCoords);
            }
            vehicleLapStates[vehicleId].isNearCheckpoint = isNowNear;
        }

        function initMap() {
            if (map) return;
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            changeMapProvider('esri');
        }

        function changeMapProvider(provider) {
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            const providerInfo = mapProviders[provider];
            currentTileLayer = L.tileLayer(providerInfo.url, {
                attribution: providerInfo.attribution,
                maxZoom: providerInfo.maxZoom
            }).addTo(map);
        }

        function setupUI(isAdmin) {
            const togglePanelBtn = document.getElementById('togglePanel');
            const controlPanel = document.getElementById('controlPanel');
            const mapTouchOverlay = document.getElementById('mapTouchOverlay');
            const refreshBtn = document.getElementById('refreshBtn');
            const mapProviderSelect = document.getElementById('mapProvider');
            const emergencyLocateBtn = document.getElementById('emergencyLocateBtn');

            togglePanelBtn.addEventListener('click', () => {
                controlPanel.classList.toggle('visible');
            });

            mapTouchOverlay.addEventListener('click', () => {
                controlPanel.classList.remove('visible');
            });

            refreshBtn.addEventListener('click', refreshData);

            mapProviderSelect.addEventListener('change', (e) => {
                changeMapProvider(e.target.value);
            });

            emergencyLocateBtn.addEventListener('click', () => {
                if (userPositionMarker) {
                    map.flyTo(userPositionMarker.getLatLng(), 18);
                } else {
                    showStatusNotification('Buscando tu ubicación, por favor espera...', 3000);
                }
            });

            if (isAdmin) {
                document.getElementById('other-vehicles-container').style.display = 'block';
            }
        }

        function showStatusNotification(message, duration = 3000) {
            const notification = document.getElementById('statusNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            showStatusNotification('Actualizando datos...', 1500);

            if (isViewer) {
                startMonitoring();
            } else {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            updateMyPosition(position);
                            updateVehicles();
                        },
                        (error) => {
                            console.error("Error al obtener la ubicación:", error);
                            showStatusNotification('Error de ubicación. Intenta de nuevo.', 3000);
                        }, {
                            enableHighAccuracy: true,
                            maximumAge: 0,
                            timeout: 5000
                        }
                    );
                } else {
                    showStatusNotification('Geolocalización no es soportada.', 3000);
                }
            }

            setTimeout(() => {
                refreshBtn.classList.remove('loading');
            }, 1000);
        }

        function updateMyPosition(position) {
            const coords = position.coords;
            const timestamp = position.timestamp;
            const speed = coords.speed ? (coords.speed * 3.6).toFixed(2) : 0;
            const newCoords = L.latLng(coords.latitude, coords.longitude);

            if (!userPositionMarker) {
                userPositionMarker = L.marker(newCoords, {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: `<div style="position: relative;"><div class="pulse-circle"></div><div class="user-icon online"></div></div>`,
                        iconSize: [20, 20],
                    })
                }).addTo(map);

                userAccuracyCircle = L.circle(newCoords, {
                    radius: coords.accuracy,
                    className: 'accuracy-circle'
                }).addTo(map);
            } else {
                userPositionMarker.setLatLng(newCoords);
                userAccuracyCircle.setLatLng(newCoords).setRadius(coords.accuracy);
            }

            lastKnownPosition = newCoords;

            document.getElementById('locationStatus').textContent = `Velocidad: ${speed} km/h`;
            document.getElementById('current-user-status').textContent = 'En ruta';
            document.getElementById('current-user-status').className = 'online';
            document.getElementById('current-user-coords').textContent = `${newCoords.lat.toFixed(6)}, ${newCoords.lng.toFixed(6)}`;

            const myVehicleRef = database.ref('vehicles/' + currentUserId);
            myVehicleRef.update({
                coords: {
                    lat: coords.latitude,
                    lon: coords.longitude
                },
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                speed: parseFloat(speed),
                status: 'online'
            });

            checkAndCountLap(currentUserId, [coords.latitude, coords.longitude]);
        }

        function initializeCurrentUserMarker() {
            document.getElementById('current-user-icon').classList.remove('offline');
            document.getElementById('current-user-icon').classList.add('online');
            document.getElementById('current-user-status').textContent = 'En ruta';
            document.getElementById('current-user-status').className = 'online';
        }

        function startGPSTracking() {
            if ("geolocation" in navigator) {
                backgroundGeolocationWatchId = navigator.geolocation.watchPosition(
                    updateMyPosition,
                    (error) => {
                        console.error("Error al obtener la ubicación:", error);
                        showStatusNotification(`Error: ${error.message}`, 5000);
                        document.getElementById('locationStatus').textContent = `Error de GPS: ${error.message}`;
                        document.getElementById('current-user-status').textContent = 'Desconectado';
                        document.getElementById('current-user-status').className = 'offline';
                        const myVehicleRef = database.ref('vehicles/' + currentUserId);
                        myVehicleRef.update({
                            status: 'offline'
                        });
                    }, {
                        enableHighAccuracy: true,
                        maximumAge: 3000,
                        timeout: 5000
                    }
                );
            } else {
                alert("Geolocalización no es soportada por este navegador.");
            }
        }

        function initializeAllMarkers() {
            const otherVehiclesContainer = document.getElementById('other-vehicles-container');
            const vehiclesList = document.getElementById('vehicles-list');
            vehiclesList.innerHTML = '';
            for (let i = 1; i <= 4; i++) {
                const vehicleId = `movil${i}`;
                const li = document.createElement('li');
                li.id = vehicleId;
                li.className = 'vehicle-card';
                li.innerHTML = `
                    <div class="vehicle-name">
                        <div id="movil${i}-icon" class="vehicle-icon offline"></div>
                        <span id="movil${i}-name">Móvil ${i}</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Estado:</span>
                        <span id="movil${i}-status" class="offline">Desconectado</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Velocidad:</span>
                        <span id="movil${i}-speed">-- km/h</span>
                    </div>
                    <div class="vehicle-status">
                        <span>Última vez:</span>
                        <span id="movil${i}-last-update">--</span>
                    </div>
                `;
                vehiclesList.appendChild(li);
                li.addEventListener('click', () => {
                    if (markers[vehicleId]) {
                        map.flyTo(markers[vehicleId].getLatLng(), 18);
                    }
                });
            }
            otherVehiclesContainer.style.display = 'block';
        }

        function updateVehicles() {
            const vehiclesRef = database.ref('vehicles');
            vehiclesRef.once('value', snapshot => {
                const vehicles = snapshot.val();
                if (vehicles) {
                    Object.keys(vehicles).forEach(id => {
                        const vehicle = vehicles[id];
                        if (id !== currentUserId) {
                            updateVehicleMarker(id, vehicle);
                        } else if (!isViewer) {
                            updateMyVehicleUI(id, vehicle);
                        }
                    });
                }
            });
        }

        function updateMyVehicleUI(id, vehicle) {
            document.getElementById('locationStatus').textContent = `Velocidad: ${vehicle.speed.toFixed(2)} km/h`;
            document.getElementById('current-user-status').textContent = vehicle.status === 'online' ? 'En ruta' : 'Desconectado';
            document.getElementById('current-user-status').className = vehicle.status;
            document.getElementById('current-user-coords').textContent = `${vehicle.coords.lat.toFixed(6)}, ${vehicle.coords.lon.toFixed(6)}`;
            document.getElementById('current-user-icon').className = `user-icon ${vehicle.status}`;
        }

        function updateVehicleMarker(id, vehicle) {
            const vehicleDisplayName = vehicleNames[id] || `Móvil ${id.slice(-1)}`;
            const vehicleId = `movil${id.slice(-1)}`;

            if (!markers[id]) {
                markers[id] = L.marker([0, 0], {
                    icon: L.divIcon({
                        className: `vehicle-marker ${vehicle.status}`,
                        html: `<div class="vehicle-marker ${vehicle.status}"><div class="vehicle-label">${vehicleDisplayName}</div></div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16],
                    })
                }).addTo(map);
            }

            if (vehicle.coords) {
                const newCoords = [vehicle.coords.lat, vehicle.coords.lon];
                markers[id].setLatLng(newCoords);
                markers[id].getIcon().options.html = `<div class="vehicle-marker ${vehicle.status}"><div class="vehicle-label">${vehicleDisplayName}</div></div>`;
                markers[id].getIcon()._updateImg();
            }

            const now = Date.now();
            const lastUpdate = vehicle.timestamp;
            const isOnline = (now - lastUpdate) < TEN_MINUTES && vehicle.status === 'online';
            const statusClass = isOnline ? 'online' : 'offline';
            const statusText = isOnline ? 'En ruta' : 'Desconectado';
            const speedText = vehicle.speed ? `${vehicle.speed.toFixed(2)} km/h` : '--';
            const lastUpdateTime = lastUpdate ? new Date(lastUpdate).toLocaleTimeString() : '--';

            const element = document.getElementById(`${vehicleId.toLowerCase()}-status`);
            const iconElement = document.getElementById(`${vehicleId.toLowerCase()}-icon`);

            if (element) {
                element.textContent = statusText;
                element.className = statusClass;
            }

            if (iconElement) {
                iconElement.className = `vehicle-icon ${statusClass}`;
            }

            const speedElement = document.getElementById(`${vehicleId.toLowerCase()}-speed`);
            if (speedElement) speedElement.textContent = speedText;

            const lastUpdateElement = document.getElementById(`${vehicleId.toLowerCase()}-last-update`);
            if (lastUpdateElement) lastUpdateElement.textContent = lastUpdateTime;
        }

        function startMonitoring(isAdmin = false) {
            const vehiclesRef = database.ref('vehicles');
            vehiclesRef.on('child_changed', snapshot => {
                const vehicle = snapshot.val();
                if (vehicle) {
                    if (isAdmin) {
                        checkAndCountLap(snapshot.key, [vehicle.coords.lat, vehicle.coords.lon]);
                    }
                    updateVehicleMarker(snapshot.key, vehicle);
                    if (snapshot.key === currentUserId) {
                        updateMyVehicleUI(snapshot.key, vehicle);
                    }
                }
            });
            vehiclesRef.on('child_added', snapshot => {
                const vehicle = snapshot.val();
                if (vehicle) {
                    if (isAdmin) {
                        checkAndCountLap(snapshot.key, [vehicle.coords.lat, vehicle.coords.lon]);
                    }
                    updateVehicleMarker(snapshot.key, vehicle);
                    if (snapshot.key === currentUserId) {
                        updateMyVehicleUI(snapshot.key, vehicle);
                    }
                }
            });
            vehiclesRef.on('child_removed', snapshot => {
                const id = snapshot.key;
                if (markers[id]) {
                    map.removeLayer(markers[id]);
                    delete markers[id];
                }
            });
        }

        function updateVehicleNamesInUI() {
            for (let i = 1; i <= 4; i++) {
                const mobileId = 'Movil' + i;
                const element = document.getElementById(`${mobileId.toLowerCase()}-name`);
                if (element && vehicleNames[mobileId.toLowerCase()]) {
                    element.textContent = vehicleNames[mobileId.toLowerCase()];
                }
            }
        }

        document.getElementById('vehicleNumberSubmit').addEventListener('click', function() {
            const vehicleNumber = document.getElementById('vehicleNumberInput').value.trim();
            if (!vehicleNumber) {
                alert('Por favor ingrese un número de vehículo');
                return;
            }
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            auth.vehicleNumber = vehicleNumber;
            localStorage.setItem('gpsAuth', JSON.stringify(auth));
            document.getElementById('vehicleNumberModal').style.display = 'none';
            setupAfterVehicleNumber(auth.isAdmin);
        });

        document.getElementById('vehicleNumberInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('vehicleNumberSubmit').click();
            }
        });

        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            if (viewerUpdateInterval) clearInterval(viewerUpdateInterval);
            if (backgroundGeolocationWatchId !== null) {
                navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
            }
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                });
            }
            database.ref('vehicles').off();
            database.ref('laps').off();
            firebase.auth().signOut();
            localStorage.removeItem('gpsAuth');
            localStorage.removeItem('panelState');
            window.location.href = 'login.html';
        }

        document.getElementById('logoutBtn').addEventListener('click', logout);
    </script>
</body>
</html>
