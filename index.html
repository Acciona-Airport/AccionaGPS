<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor GPS Dual | Acciona</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 280px;
            max-width: 90%;
        }
        .vehicle-info {
            margin-bottom: 15px;
        }
        .vehicle-info h3 {
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        .marker-movil1 {
            background-color: #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        .marker-movil2 {
            background-color: #2ecc71;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Mapa -->
    <div id="map"></div>
    
    <!-- Panel de control -->
    <div class="control-panel">
        <div class="vehicle-info">
            <h3>🚗 Estado de Flota</h3>
            <div class="vehicle-status">
                <span>Móvil 1:</span>
                <span id="movil1-status">Desconectado</span>
            </div>
            <div class="vehicle-status">
                <span>Móvil 2:</span>
                <span id="movil2-status">Desconectado</span>
            </div>
        </div>
        <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    
    <!-- Script principal -->
    <script>
        // Configuración inicial
        const SCL_COORDS = [-33.3931, -70.7858];
        const ZOOM_INICIAL = 14;
        let map;
        const markers = {
            Movil1: null,
            Movil2: null
        };
        
        // Datos simulados (en producción usar Firebase)
        const mobileData = {
            Movil1: { coords: null, lastUpdate: null, status: 'offline' },
            Movil2: { coords: null, lastUpdate: null, status: 'offline' }
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar autenticación
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            if (!auth) {
                window.location.href = 'login.html';
                return;
            }
            
            // Iniciar mapa
            initMap();
            
            // Configurar eventos
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Iniciar seguimiento según tipo de dispositivo
            if (auth.deviceType === 'gps') {
                startGPSTracking(auth.username);
            } else {
                startMonitoring();
            }
        });
        
        // Función para inicializar el mapa
        function initMap() {
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            
            // Capa base OSM
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Marcador del aeropuerto
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('✈️ Aeropuerto SCL')
                .openPopup();
        }
        
        // Función para iniciar GPS (dispositivos móviles)
        function startGPSTracking(mobileId) {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        const coords = [position.coords.latitude, position.coords.longitude];
                        updateMobilePosition(mobileId, coords);
                        
                        // En sistema real: enviar datos al servidor
                        console.log(`Posición ${mobileId}:`, coords);
                    },
                    error => {
                        console.error(`Error GPS (${mobileId}):`, error);
                        // Modo simulación si falla el GPS real
                        simulateGPS(mobileId);
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                alert('Tu dispositivo no soporta geolocalización');
                simulateGPS(mobileId);
            }
        }
        
        // Función para monitorear (centro de control)
        function startMonitoring() {
            // Simular datos para demo (en producción usar WebSockets/Firebase)
            setInterval(() => {
                if (!mobileData.Movil1.coords) simulateGPS('Movil1');
                if (!mobileData.Movil2.coords) simulateGPS('Movil2');
                
                updateInterface();
            }, 3000);
        }
        
        // Actualizar posición de un móvil
        function updateMobilePosition(mobileId, coords) {
            mobileData[mobileId] = {
                coords: coords,
                lastUpdate: new Date(),
                status: 'online'
            };
            
            // Crear o actualizar marcador
            if (!markers[mobileId]) {
                markers[mobileId] = L.marker(coords, {
                    icon: L.divIcon({
                        className: `marker-${mobileId.toLowerCase()}`,
                        html: mobileId === 'Movil1' ? '1' : '2',
                        iconSize: [30, 30]
                    })
                }).addTo(map)
                .bindPopup(`<b>${mobileId}</b><br>Última actualización: ${new Date().toLocaleTimeString()}`);
            } else {
                markers[mobileId]
                    .setLatLng(coords)
                    .setPopupContent(`<b>${mobileId}</b><br>Última actualización: ${new Date().toLocaleTimeString()}`);
            }
            
            updateInterface();
        }
        
        // Simular datos GPS (para demo)
        function simulateGPS(mobileId) {
            const offset = () => (Math.random() * 0.02 - 0.01);
            const newCoords = [
                SCL_COORDS[0] + offset(),
                SCL_COORDS[1] + offset()
            ];
            
            mobileData[mobileId] = {
                coords: newCoords,
                lastUpdate: new Date(),
                status: Math.random() > 0.1 ? 'online' : 'offline'
            };
            
            updateMobilePosition(mobileId, newCoords);
        }
        
        // Actualizar interfaz
        function updateInterface() {
            document.getElementById('movil1-status').textContent = 
                mobileData.Movil1.status === 'online' ? 'En movimiento' : 'Desconectado';
                
            document.getElementById('movil2-status').textContent = 
                mobileData.Movil2.status === 'online' ? 'En movimiento' : 'Desconectado';
        }
        
        // Cerrar sesión
        function logout() {
            localStorage.removeItem('gpsAuth');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
