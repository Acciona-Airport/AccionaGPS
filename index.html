<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel {
            position: fixed;
            top: 15px;
            right: 0;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 280px;
            transform: translateX(265px);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
        }
        .control-panel.visible {
            transform: translateX(0);
        }
        .toggle-panel {
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--white);
            border: 1px solid var(--red-light);
            width: 25px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .toggle-icon {
            color: var(--red-dark);
            font-size: 16px;
            transition: transform 0.3s;
        }
        .control-panel.visible .toggle-icon {
            transform: rotate(180deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: #27ae60; }
        .offline { color: var(--red-dark); }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        .marker {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .marker-movil1 { background-color: #3498db; }
        .marker-movil2 { background-color: #2ecc71; }
        .marker-movil3 { background-color: #e67e22; }
        .marker-movil4 { background-color: #9b59b6; }
        .marker-offline {
            background-color: #95a5a6 !important;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel visible" id="controlPanel">
        <button class="toggle-panel" id="togglePanel">
            <span class="toggle-icon">â—„</span>
        </button>
        
        <h3 style="margin-top:0;color:var(--red-dark);">ðŸš— Flota Acciona</h3>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil1" style="margin-right:8px;">1</span> MÃ³vil 1</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil1-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil2" style="margin-right:8px;">2</span> MÃ³vil 2</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil2-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil3" style="margin-right:8px;">3</span> MÃ³vil 3</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil3-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil4" style="margin-right:8px;">4</span> MÃ³vil 4</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil4-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <button class="logout-btn" id="logoutBtn">Cerrar SesiÃ³n</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ConfiguraciÃ³n
        const SCL_COORDS = [-33.3931, -70.7858];
        const ZOOM_INICIAL = 14;
        let map;
        const markers = {};
        let gpsInterval;
        
        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            if (!auth) {
                window.location.href = 'login.html';
                return;
            }
            
            initMap();
            setupUI();
            
            // Mostrar todos los mÃ³viles desde el inicio
            initializeAllMarkers();
            
            if (!auth.isViewer) {
                startGPSTracking(auth.username);
            } else {
                startMonitoring();
            }
        });
        
        function initMap() {
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            
            // Marcador del aeropuerto
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('âœˆï¸ Aeropuerto SCL')
                .openPopup();
        }
        
        function setupUI() {
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            const panel = document.getElementById('controlPanel');
            document.getElementById('togglePanel').addEventListener('click', function() {
                panel.classList.toggle('visible');
            });
        }
        
        function initializeAllMarkers() {
            // Crear marcadores para todos los mÃ³viles (inicialmente desconectados)
            const initialPositions = {
                Movil1: [-33.40, -70.78],
                Movil2: [-33.39, -70.79],
                Movil3: [-33.38, -70.77],
                Movil4: [-33.41, -70.80]
            };
            
            Object.keys(initialPositions).forEach(mobileId => {
                createMarker(mobileId, initialPositions[mobileId], false);
            });
        }
        
        function startGPSTracking(mobileId) {
            // Limpiar intervalo previo
            if (gpsInterval) clearInterval(gpsInterval);
            
            // Primera actualizaciÃ³n inmediata
            updatePosition(mobileId);
            
            // Actualizar cada 5 segundos
            gpsInterval = setInterval(() => {
                updatePosition(mobileId);
            }, 5000);
        }
        
        function updatePosition(mobileId) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const coords = [position.coords.latitude, position.coords.longitude];
                        savePosition(mobileId, coords);
                    },
                    error => {
                        console.error('Error GPS:', error);
                        updateStatus(mobileId, 'offline');
                    },
                    { enableHighAccuracy: true, timeout: 4000 }
                );
            }
        }
        
        function savePosition(mobileId, coords) {
            // Guardar en localStorage (simulando backend)
            const sharedData = JSON.parse(localStorage.getItem('gpsSharedData')) || {};
            sharedData[mobileId] = {
                coords,
                timestamp: new Date().getTime(),
                status: 'online'
            };
            localStorage.setItem('gpsSharedData', JSON.stringify(sharedData));
            
            // Actualizar mapa
            updateMarker(mobileId, coords, true);
            updateStatus(mobileId, 'online');
        }
        
        function startMonitoring() {
            // Verificar cambios cada 2 segundos
            setInterval(() => {
                const sharedData = JSON.parse(localStorage.getItem('gpsSharedData')) || {};
                
                // Actualizar todos los mÃ³viles
                ['Movil1', 'Movil2', 'Movil3', 'Movil4'].forEach(mobileId => {
                    if (sharedData[mobileId]?.coords) {
                        updateMarker(mobileId, sharedData[mobileId].coords, sharedData[mobileId].status === 'online');
                        updateStatus(mobileId, sharedData[mobileId].status || 'offline');
                    } else {
                        // MÃ³vil sin datos (desconectado)
                        updateStatus(mobileId, 'offline');
                        const marker = markers[mobileId];
                        if (marker) {
                            marker.getElement().classList.add('marker-offline');
                        }
                    }
                });
            }, 2000);
        }
        
        function createMarker(mobileId, coords, isOnline) {
            if (markers[mobileId]) return;
            
            const markerNumber = mobileId.replace('Movil', '');
            markers[mobileId] = L.marker(coords, {
                icon: L.divIcon({
                    className: `marker-${mobileId.toLowerCase()} ${isOnline ? '' : 'marker-offline'}`,
                    html: markerNumber,
                    iconSize: [30, 30],
                    className: 'marker'
                }),
                opacity: isOnline ? 1 : 0.6
            }).addTo(map)
            .bindPopup(`<b>${mobileId}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}`);
            
            if (!isOnline) {
                markers[mobileId].getElement().classList.add('marker-offline');
            }
        }
        
        function updateMarker(mobileId, coords, isOnline) {
            const markerNumber = mobileId.replace('Movil', '');
            
            if (!markers[mobileId]) {
                createMarker(mobileId, coords, isOnline);
            } else {
                markers[mobileId]
                    .setLatLng(coords)
                    .setPopupContent(`<b>${mobileId}</b><br>${isOnline ? 'En ruta' : 'Desconectado'}<br>${new Date().toLocaleTimeString()}`);
                
                const markerElement = markers[mobileId].getElement();
                if (isOnline) {
                    markerElement.classList.remove('marker-offline');
                    markers[mobileId].setOpacity(1);
                } else {
                    markerElement.classList.add('marker-offline');
                    markers[mobileId].setOpacity(0.6);
                }
            }
        }
        
        function updateStatus(mobileId, status) {
            const element = document.getElementById(`${mobileId.toLowerCase()}-status`);
            if (element) {
                element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                element.className = status === 'online' ? 'online' : 'offline';
            }
        }
        
        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            localStorage.removeItem('gpsAuth');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
