<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monitor GPS | Acciona</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f44336">
    <meta name="mobile-web-app-capable" content="yes">
    <style>
        :root {
            --white: #ffffff;
            --red-light: #ffebee;
            --red-primary: #f44336;
            --red-dark: #d32f2f;
            --gray-light: #f5f5f5;
            --online-color: #27ae60;
            --offline-color: #95a5a6;
            --user-position-color: #3498db;
            --blue-primary: #2196f3;
            --blue-light: #e3f2fd;
            --blue-dark: #1976d2;
            --route1-color: #e74c3c;
            --route2-color: #9b59b6;
        }
        * {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            background-color: #2c3e50;
            touch-action: pan-x pan-y;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel-container {
            position: fixed;
            top: 15px;
            right: 0;
            z-index: 1000;
            display: flex;
            overflow: hidden;
            pointer-events: none;
        }
        .control-panel {
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 280px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            border: 1px solid var(--red-light);
            position: relative;
            right: -100%;
            max-height: 80vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            pointer-events: auto;
        }
        .control-panel.visible {
            transform: translateX(0);
            right: 0;
        }
        .toggle-panel {
            background: var(--white);
            border: 1px solid var(--red-light);
            width: 40px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
            margin-left: 5px;
            flex-shrink: 0;
            pointer-events: auto;
        }
        .toggle-panel:hover {
            background: var(--red-light);
        }
        .hamburger-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            width: 20px;
        }
        .hamburger-line {
            height: 2px;
            background-color: var(--red-dark);
            transition: all 0.3s ease;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(1) {
            transform: translateY(6px) rotate(45deg);
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(2) {
            opacity: 0;
        }
        .control-panel.visible ~ .toggle-panel .hamburger-line:nth-child(3) {
            transform: translateY(-6px) rotate(-45deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--red-light);
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: var(--red-dark);
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-top: 5px;
        }
        .online { color: var(--online-color); }
        .offline { color: var(--offline-color); }
        .logout-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
            transition: background 0.3s;
        }
        .logout-btn:hover {
            background: var(--red-dark);
        }
        .diagnostic-panel-container {
            display: none;
        }
        /* Icono de usuario (persona) */
        .user-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
        }
        .user-icon.online {
            background-color: var(--online-color);
        }
        .user-icon.offline {
            background-color: var(--offline-color);
            opacity: 0.7;
        }
        /* Icono de veh√≠culo (coche) */
        .vehicle-icon {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            margin-right: 8px;
        }
        .vehicle-icon.online {
            background-color: var(--online-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-icon.offline {
            background-color: var(--offline-color);
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-marker {
            background-size: 70%;
            background-repeat: no-repeat;
            background-position: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .vehicle-marker.online {
            background-color: #27ae60;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
        }
        .vehicle-marker.offline {
            background-color: #95a5a6;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');
            opacity: 0.7;
        }
        .vehicle-label {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            text-shadow: 0 0 3px white;
            pointer-events: none;
        }
        .refresh-container {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 1000;
            pointer-events: none;
        }
        .refresh-btn {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background 0.3s, transform 0.2s;
            pointer-events: auto;
        }
        .refresh-btn:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
        }
        .refresh-btn:active {
            transform: translateY(0);
        }
        .refresh-icon {
            width: 16px;
            height: 16px;
            transition: transform 0.5s;
        }
        .refresh-btn.loading .refresh-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .map-provider-selector {
            position: fixed;
            bottom: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .map-provider-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        .status-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1001;
            display: none;
            font-size: 14px;
        }
        .current-user-indicator {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            font-weight: bold;
            color: var(--red-dark);
        }
        .pulse-circle {
            border-radius: 50%;
            background-color: var(--user-position-color);
            width: 20px;
            height: 20px;
            position: absolute;
            left: -10px;
            top: -10px;
            opacity: 0.6;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.6; }
            70% { transform: scale(2.5); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }
        .emergency-locate-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--user-position-color);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .accuracy-circle {
            fill: rgba(52, 152, 219, 0.2);
            stroke: rgba(52, 152, 219, 0.5);
            stroke-width: 1;
        }
        .leaflet-control-zoom {
            margin-top: 80px !important;
        }
        .leaflet-bar a {
            width: 40px !important;
            height: 40px !important;
            line-height: 40px !important;
            font-size: 24px !important;
        }
        .leaflet-container {
            touch-action: manipulation;
        }
        .map-touch-overlay {
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 100%;
            z-index: 999;
            display: none;
        }
        .control-panel.visible ~ .map-touch-overlay {
            display: block;
        }
        .route-selector {
            position: fixed;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .route-selector select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
            margin-top: 5px;
            width: 100%;
        }
        
        .leaflet-bottom.leaflet-right {
            bottom: 160px;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        
        /* Modal para n√∫mero de veh√≠culo */
        .vehicle-number-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        .vehicle-number-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .vehicle-number-form h2 {
            color: var(--red-dark);
            margin-bottom: 20px;
        }
        .vehicle-number-input {
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid var(--gray-light);
            border-radius: 8px;
            font-size: 18px;
            text-align: center;
        }
        .vehicle-number-input:focus {
            border-color: var(--red-primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }
        .vehicle-number-submit {
            background: var(--red-primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .vehicle-number-submit:hover {
            background: var(--red-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(211, 47, 47, 0.3);
        }
        
        /* Estilos para el Tablero y el Historial */
        .admin-nav {
            display: none; /* Inicialmente oculto para usuarios no-admin */
            justify-content: space-around;
            margin-top: 15px;
            border-bottom: 1px solid var(--gray-light);
            padding-bottom: 10px;
        }
        .admin-nav button {
            background: none;
            border: none;
            padding: 8px 12px;
            font-weight: 600;
            cursor: pointer;
            color: var(--red-dark);
            border-bottom: 2px solid transparent;
            transition: border-bottom 0.3s;
        }
        .admin-nav button.active {
            border-bottom-color: var(--red-primary);
        }
        .admin-content {
            padding-top: 10px;
        }
        .admin-panel {
            display: none;
        }
        .admin-panel.active {
            display: block;
        }
        .dashboard-metric {
            background: var(--gray-light);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .dashboard-metric h4 {
            margin: 0 0 5px 0;
            color: var(--red-dark);
        }
        .dashboard-metric p {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        .history-controls {
            margin-bottom: 10px;
        }
        .history-controls label, .history-controls select, .history-controls input, .history-controls button {
            display: block;
            width: 100%;
            margin-bottom: 10px;
        }
        .history-controls button {
            background: var(--blue-primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-touch-overlay" id="mapTouchOverlay"></div>
    
    <div class="status-notification" id="statusNotification"></div>
    
    <div class="current-user-indicator" id="currentUserIndicator">
        <span id="locationStatus">Buscando tu ubicaci√≥n...</span>
    </div>

    <div class="diagnostic-panel-container">
        <div class="diagnostic-panel" id="diagnosticPanel">
            <h3 style="margin-top:0;color:var(--blue-dark);">üìä Diagn√≥stico GPS</h3>
            
            <div class="diagnostic-info">
                <div class="diagnostic-item">
                    <span>Estado GPS:</span>
                    <span id="gpsStatus" class="diagnostic-value warning">Comprobando...</span>
                </div>
                <div class="diagnostic-item">
                    <span>Precisi√≥n:</span>
                    <span id="accuracyValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>√öltima actualizaci√≥n:</span>
                    <span id="lastUpdateValue" class="diagnostic-value">--</span>
                </div>
                <div class="diagnostic-item">
                    <span>M√©todo:</span>
                    <span id="methodValue" class="diagnostic-value">--</span>
                </div>
            </div>
            
            <button id="forceLocationBtn" style="margin-top: 15px; width: 100%; padding: 8px; background: var(--blue-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                Forzar Ubicaci√≥n
            </button>
        </div>
        
        <button class="toggle-diagnostic-panel" id="toggleDiagnosticPanel">
            <div class="diagnostic-hamburger-icon">
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
                <div class="diagnostic-hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="route-selector">
        <label for="routeSelector">Ruta:</label>
        <select id="routeSelector">
            <option value="none">Sin ruta</option>
            <option value="route1">Ruta 1</option>
            <option value="route2">Ruta 2</option>
        </select>
    </div>

    <button class="emergency-locate-btn" id="emergencyLocateBtn" title="Centrar en mi ubicaci√≥n">üìç</button>

    <div class="control-panel-container">
        <div class="control-panel" id="controlPanel">
            <h3 style="margin-top:0;color:var(--red-dark);">üöó Flota Acciona</h3>
            
            <div class="admin-nav" id="adminNav">
                <button id="viewFleetBtn" class="active">Flota</button>
                <button id="viewDashboardBtn">Tablero</button>
                <button id="viewHistoryBtn">Historial</button>
            </div>
            
            <div class="admin-content">
                <div id="fleetPanel" class="admin-panel active">
                    <div class="vehicle-card">
                        <div class="vehicle-name">
                            <div id="current-user-icon" class="user-icon offline"></div>
                            <span id="current-user-name">Mi Ubicaci√≥n</span>
                        </div>
                        <div class="vehicle-status">
                            <span>Estado:</span>
                            <span id="current-user-status" class="offline">Desconectado</span>
                        </div>
                        <div class="vehicle-status">
                            <span>Coordenadas:</span>
                            <span id="current-user-coords">--</span>
                        </div>
                    </div>
                    <div id="other-vehicles-container" style="display: none;">
                        <h4 style="margin: 15px 0 10px 0; color: var(--red-dark);">Carruseles:</h4>
                        <div class="vehicle-card">
                            <div class="vehicle-name">
                                <div id="movil1-icon" class="vehicle-icon offline"></div>
                                <span id="movil1-name">M√≥vil 1</span>
                            </div>
                            <div class="vehicle-status">
                                <span>Estado:</span>
                                <span id="movil1-status" class="offline">Desconectado</span>
                            </div>
                        </div>
                        <div class="vehicle-card">
                            <div class="vehicle-name">
                                <div id="movil2-icon" class="vehicle-icon offline"></div>
                                <span id="movil2-name">M√≥vil 2</span>
                            </div>
                            <div class="vehicle-status">
                                <span>Estado:</span>
                                <span id="movil2-status" class="offline">Desconectado</span>
                            </div>
                        </div>
                        <div class="vehicle-card">
                            <div class="vehicle-name">
                                <div id="movil3-icon" class="vehicle-icon offline"></div>
                                <span id="movil3-name">M√≥vil 3</span>
                            </div>
                            <div class="vehicle-status">
                                <span>Estado:</span>
                                <span id="movil3-status" class="offline">Desconectado</span>
                            </div>
                        </div>
                        <div class="vehicle-card">
                            <div class="vehicle-name">
                                <div id="movil4-icon" class="vehicle-icon offline"></div>
                                <span id="movil4-name">M√≥vil 4</span>
                            </div>
                            <div class="vehicle-status">
                                <span>Estado:</span>
                                <span id="movil4-status" class="offline">Desconectado</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="dashboardPanel" class="admin-panel">
                    <div class="dashboard-metric">
                        <h4>Veh√≠culos Online</h4>
                        <p id="onlineVehiclesCount">0</p>
                    </div>
                    <div class="dashboard-metric">
                        <h4>Veh√≠culos Offline</h4>
                        <p id="offlineVehiclesCount">0</p>
                    </div>
                    <div class="dashboard-metric">
                        <h4>Total de Carruseles</h4>
                        <p id="totalVehiclesCount">0</p>
                    </div>
                    <div class="dashboard-metric">
                        <h4>Distancia Total Recorrida</h4>
                        <p id="totalDistance">0 km</p>
                    </div>
                </div>
                
                <div id="historyPanel" class="admin-panel">
                    <div class="history-controls">
                        <label for="historyVehicleSelector">Seleccionar Veh√≠culo:</label>
                        <select id="historyVehicleSelector"></select>
                        
                        <label for="historyDateSelector">Seleccionar Fecha:</label>
                        <input type="date" id="historyDateSelector">
                        
                        <button id="loadHistoryBtn">Cargar Historial</button>
                    </div>
                </div>
            </div>
            <button class="logout-btn" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
        <button class="toggle-panel" id="togglePanel">
            <div class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </div>
        </button>
    </div>

    <div class="refresh-container">
        <button class="refresh-btn" id="refreshBtn">
            <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
            </svg>
            Actualizar
        </button>
    </div>

    <div class="map-provider-selector">
        <label for="mapProvider">Mapa:</label>
        <select id="mapProvider">
            <option value="esri">Satelital (Recomendada)</option>
            <option value="carto">Cartogr√°fica</option>
            <option value="osm">H√≠brida</option>
        </select>
    </div>

    <div class="vehicle-number-modal" id="vehicleNumberModal">
        <div class="vehicle-number-form">
            <h2>Ingrese n√∫mero de veh√≠culo</h2>
            <input type="text" class="vehicle-number-input" id="vehicleNumberInput" placeholder="Ej: 6142" maxlength="10">
            <button class="vehicle-number-submit" id="vehicleNumberSubmit">Continuar</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDT85qotm1EpAJzJzCFeoNwGyo-VKhM6dk",
            authDomain: "gpsaccionascl2025.firebaseapp.com",
            databaseURL: "https://gpsaccionascl2025-default-rtdb.firebaseio.com",
            projectId: "gpsaccionascl2025",
            storageBucket: "gpsaccionascl2025.appspot.com",
            messagingSenderId: "742246618721",
            appId: "1:742246618721:web:72d0046987416800f07c20"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const SCL_COORDS = [-33.3931, -70.7858];
        const INACTIVE_COORDS = [-33.409995, -70.788647];
        const ZOOM_INICIAL = 14;
        let map;
        let currentTileLayer;
        const markers = {};
        const lastUpdateTimes = {};
        const vehicleCache = {};
        let gpsInterval;
        let wakeLock = null;
        let backgroundGeolocationWatchId = null;
        const TEN_MINUTES = 10 * 60 * 1000;
        const UPDATE_INTERVAL = 30000;
        let currentUserId = null;
        let isViewer = false;
        let userPositionMarker = null;
        let userAccuracyCircle = null;
        let lastKnownPosition = null;
        let locationUpdateInterval = null;
        let viewerUpdateInterval = null;
        let currentRouteLayer = null;
        let historyRouteLayer = null;
        let vehicleNames = {};

        const route1Coordinates = [
            [-33.4095444, -70.7893019], [-33.4092635, -70.7895518], [-33.404626, -70.7897795], [-33.4045659, -70.7889574],
            [-33.3965734, -70.7893183], [-33.3966737, -70.7910012], [-33.3970831, -70.790958], [-33.3971273, -70.7919677],
            [-33.4013289, -70.7917774], [-33.401446, -70.795415], [-33.399824, -70.7955015], [-33.3998119, -70.7972767],
            [-33.4013148, -70.7975319], [-33.4015637, -70.7963495], [-33.4024887, -70.7962452], [-33.4024227, -70.7970347],
            [-33.4034563, -70.7972551], [-33.4042861, -70.7954845], [-33.4046187, -70.794697], [-33.4048866, -70.7947514],
            [-33.405408, -70.7948064], [-33.4053351, -70.7953282], [-33.405786, -70.7952857], [-33.4059086, -70.7949392],
            [-33.4060592, -70.7951052], [-33.4065406, -70.7951888], [-33.4066228, -70.7958045], [-33.4065369, -70.7960309],
            [-33.4067305, -70.7960718], [-33.4067399, -70.7963784], [-33.4072314, -70.7964468], [-33.4074251, -70.7959074],
            [-33.408226, -70.7960759], [-33.4081744, -70.7964861], [-33.4093845, -70.7963032], [-33.4095444, -70.7893019]
        ];

        const route2Coordinates = [
            [-33.4095444, -70.7893019], [-33.4092635, -70.7895518], [-33.404626, -70.7897795], [-33.4045659, -70.7889574],
            [-33.3965734, -70.7893183], [-33.3966737, -70.7910012], [-33.3970831, -70.790958], [-33.3971273, -70.7919677],
            [-33.4013289, -70.7917774], [-33.401446, -70.795415], [-33.4014169, -70.7959955], [-33.4004943, -70.7960166],
            [-33.4002773, -70.796191], [-33.4002621, -70.7964975], [-33.4001925, -70.7966953], [-33.4001991, -70.7968537],
            [-33.4001153, -70.7972412], [-33.4002741, -70.7975317], [-33.4004734, -70.7976693], [-33.4006245, -70.7978809],
            [-33.4006138, -70.7981507], [-33.4006268, -70.7982268], [-33.4008126, -70.7982548], [-33.400977, -70.7982631],
            [-33.401127, -70.7983696], [-33.4012752, -70.7984813], [-33.401428, -70.7985449], [-33.4015682, -70.7986062],
            [-33.4018241, -70.7986689], [-33.4019124, -70.7986161], [-33.402096, -70.7985015], [-33.4021295, -70.7986348],
            [-33.4020295, -70.798835], [-33.401905, -70.7988894], [-33.401777, -70.7989397], [-33.401666, -70.7989599],
            [-33.4014792, -70.7988884], [-33.4012746, -70.798751], [-33.4011036, -70.798622], [-33.4009277, -70.7985227],
            [-33.4007683, -70.7984183], [-33.4006245, -70.7982823], [-33.4005041, -70.7981561], [-33.400435, -70.7980242],
            [-33.4003507, -70.7978253], [-33.400325, -70.7976693], [-33.4002674, -70.7975323], [-33.400192, -70.7974465],
            [-33.4000497, -70.7973063], [-33.3999434, -70.7971842], [-33.3998119, -70.7972767], [-33.399824, -70.7955015],
            [-33.401446, -70.795415], [-33.4013289, -70.7917774], [-33.3971273, -70.7919677], [-33.3970831, -70.790958],
            [-33.3966737, -70.7910012], [-33.3965734, -70.7893183], [-33.4045659, -70.7889574], [-33.404626, -70.7897795],
            [-33.4092635, -70.7895518], [-33.4095444, -70.7893019]
        ];

        document.addEventListener('DOMContentLoaded', () => {
            const authData = JSON.parse(localStorage.getItem('gpsAuth'));
            if (!authData) {
                window.location.href = 'login.html';
                return;
            }

            currentUserId = authData.vehicleNumber;
            isViewer = authData.isViewer;
            const isAdmin = authData.username === 'Admin'; // Comprobaci√≥n del rol de administrador

            // Ocultar/mostrar elementos seg√∫n el rol
            document.getElementById('other-vehicles-container').style.display = isViewer ? 'block' : 'none';
            document.getElementById('routeSelector').style.display = isViewer ? 'block' : 'none';
            document.getElementById('emergencyLocateBtn').style.display = isViewer ? 'none' : 'flex';
            document.getElementById('adminNav').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('dashboardPanel').style.display = 'none';
            document.getElementById('historyPanel').style.display = 'none';
            
            initMap();
            if (isViewer) {
                startViewerUpdates();
                initViewerDashboard();
            } else {
                startGPSLocationTracking();
            }
            
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
            document.getElementById('emergencyLocateBtn').addEventListener('click', centerMapOnUser);
            document.getElementById('mapProvider').addEventListener('change', updateTileLayer);
            document.getElementById('routeSelector').addEventListener('change', updateRouteLayer);
            document.getElementById('togglePanel').addEventListener('click', togglePanel);
            
            // L√≥gica para el panel de diagn√≥stico, si es necesario
            // document.getElementById('toggleDiagnosticPanel').addEventListener('click', toggleDiagnosticPanel);
            // document.getElementById('forceLocationBtn').addEventListener('click', forceLocationUpdate);

            // Admin panel navigation
            if (isAdmin) {
                document.getElementById('viewFleetBtn').addEventListener('click', () => showPanel('fleet'));
                document.getElementById('viewDashboardBtn').addEventListener('click', () => showPanel('dashboard'));
                document.getElementById('viewHistoryBtn').addEventListener('click', () => showPanel('history'));
                document.getElementById('loadHistoryBtn').addEventListener('click', loadHistory);
                
                // Populate history vehicle selector
                const historyVehicleSelector = document.getElementById('historyVehicleSelector');
                const vehicleIds = ['movil1', 'movil2', 'movil3', 'movil4'];
                vehicleIds.forEach(id => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `M√≥vil ${id.slice(-1)}`;
                    historyVehicleSelector.appendChild(option);
                });
            }
        });

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView(SCL_COORDS, ZOOM_INICIAL);
            updateTileLayer();
            new L.Control.Zoom({ position: 'topright' }).addTo(map);
        }

        function updateTileLayer() {
            const selectedProvider = document.getElementById('mapProvider').value;
            let newLayer;
            if (currentTileLayer) {
                map.removeLayer(currentTileLayer);
            }
            
            if (selectedProvider === 'esri') {
                newLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                });
            } else if (selectedProvider === 'carto') {
                newLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
                });
            } else if (selectedProvider === 'osm') {
                newLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                });
            }
            map.addLayer(newLayer);
            currentTileLayer = newLayer;
        }

        function togglePanel() {
            const panel = document.getElementById('controlPanel');
            panel.classList.toggle('visible');
            localStorage.setItem('panelState', panel.classList.contains('visible') ? 'visible' : 'hidden');
        }

        // Funciones para Admin Panel
        function showPanel(panelName) {
            document.querySelectorAll('.admin-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelectorAll('.admin-nav button').forEach(button => button.classList.remove('active'));

            if (panelName === 'fleet') {
                document.getElementById('fleetPanel').classList.add('active');
                document.getElementById('viewFleetBtn').classList.add('active');
                // Asegurar que los marcadores de la flota est√©n visibles
                Object.values(markers).forEach(marker => map.addLayer(marker));
                if (historyRouteLayer) map.removeLayer(historyRouteLayer);
            } else if (panelName === 'dashboard') {
                document.getElementById('dashboardPanel').classList.add('active');
                document.getElementById('viewDashboardBtn').classList.add('active');
                // Ocultar marcadores para ver el dashboard
                Object.values(markers).forEach(marker => map.removeLayer(marker));
                if (historyRouteLayer) map.removeLayer(historyRouteLayer);
            } else if (panelName === 'history') {
                document.getElementById('historyPanel').classList.add('active');
                document.getElementById('viewHistoryBtn').classList.add('active');
                // Ocultar marcadores para ver el historial
                Object.values(markers).forEach(marker => map.removeLayer(marker));
            }
        }
        
        function initViewerDashboard() {
            // L√≥gica para inicializar el dashboard del admin
            database.ref('vehicles').on('value', (snapshot) => {
                const vehicles = snapshot.val();
                let onlineCount = 0;
                let offlineCount = 0;
                let totalDistance = 0; // Esta m√©trica requiere datos hist√≥ricos
                
                if (vehicles) {
                    const vehicleKeys = Object.keys(vehicles);
                    vehicleKeys.forEach(key => {
                        const vehicle = vehicles[key];
                        if (vehicle.status === 'online') {
                            onlineCount++;
                        } else {
                            offlineCount++;
                        }
                    });
                }
                
                document.getElementById('onlineVehiclesCount').textContent = onlineCount;
                document.getElementById('offlineVehiclesCount').textContent = offlineCount;
                document.getElementById('totalVehiclesCount').textContent = onlineCount + offlineCount;
                // La distancia total requerir√≠a un c√°lculo m√°s complejo, aqu√≠ solo se muestra un placeholder
                document.getElementById('totalDistance').textContent = 'Calculando...';
            });
        }
        
        function loadHistory() {
            const vehicleId = document.getElementById('historyVehicleSelector').value;
            const date = document.getElementById('historyDateSelector').value;
            
            if (!vehicleId || !date) {
                showNotification('Por favor, seleccione un veh√≠culo y una fecha.');
                return;
            }
            
            showNotification('Cargando historial...');
            
            // Formato de fecha para la base de datos (YYYY-MM-DD)
            const datePath = date.replace(/-/g, '');
            const historyRef = database.ref(`history/${vehicleId}/${datePath}`);
            
            historyRef.once('value', (snapshot) => {
                const historyData = snapshot.val();
                if (historyData) {
                    const latlngs = [];
                    // Convertir el objeto de historial a un array de coordenadas
                    Object.values(historyData).forEach(location => {
                        latlngs.push([location.lat, location.lng]);
                    });
                    
                    if (latlngs.length > 0) {
                        // Eliminar ruta de historial anterior si existe
                        if (historyRouteLayer) {
                            map.removeLayer(historyRouteLayer);
                        }
                        
                        historyRouteLayer = L.polyline(latlngs, { color: 'blue', weight: 5, opacity: 0.7 }).addTo(map);
                        map.fitBounds(historyRouteLayer.getBounds());
                        showNotification(`Historial cargado para ${vehicleId} en la fecha ${date}.`);
                    } else {
                        showNotification('No se encontraron datos de historial para esta fecha.');
                    }
                } else {
                    showNotification('No se encontraron datos de historial para esta fecha.');
                }
            }, (error) => {
                console.error("Error al cargar el historial:", error);
                showNotification('Error al cargar el historial. Intente de nuevo m√°s tarde.');
            });
        }

        // Funciones existentes, se mantienen sin cambios

        function startGPSLocationTracking() {
            requestWakeLock();
            if (navigator.geolocation) {
                const options = {
                    enableHighAccuracy: true,
                    maximumAge: 5000,
                    timeout: 27000,
                };
                
                // Forzar una actualizaci√≥n inicial
                navigator.geolocation.getCurrentPosition(updateGPSLocation, onLocationError, options);
                
                // Usar watchPosition para actualizaciones continuas
                backgroundGeolocationWatchId = navigator.geolocation.watchPosition(updateGPSLocation, onLocationError, options);
                
                // Intervalo de seguridad para forzar actualizaciones
                locationUpdateInterval = setInterval(() => {
                    navigator.geolocation.getCurrentPosition(updateGPSLocation, onLocationError, options);
                }, UPDATE_INTERVAL);
            } else {
                showNotification('Geolocalizaci√≥n no es compatible con este navegador.', 'error');
            }
        }
        
        function updateGPSLocation(position) {
            const { latitude, longitude, accuracy, speed } = position.coords;
            lastKnownPosition = [latitude, longitude];
            
            updateCurrentUserUI({
                lat: latitude.toFixed(6),
                lng: longitude.toFixed(6),
                accuracy: accuracy,
                speed: speed
            });

            // Actualizar ubicaci√≥n en la base de datos
            const updateData = {
                lat: latitude,
                lng: longitude,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                status: 'online',
                accuracy: accuracy,
                speed: speed
            };
            database.ref(`vehicles/${currentUserId}`).set(updateData);
            
            // Guardar en historial, solo si es un veh√≠culo en ruta
            if (!isViewer) {
                 const today = new Date();
                 const dateKey = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
                 const historyRef = database.ref(`history/${currentUserId}/${dateKey}`).push();
                 historyRef.set({
                    lat: latitude,
                    lng: longitude,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                 });
            }
        }
        
        function onLocationError(error) {
            console.error("Error de Geolocalizaci√≥n:", error);
            let message = 'Error de ubicaci√≥n desconocido.';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = "Permiso de geolocalizaci√≥n denegado. Habil√≠talo en la configuraci√≥n de tu navegador.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "La informaci√≥n de ubicaci√≥n no est√° disponible.";
                    break;
                case error.TIMEOUT:
                    message = "El tiempo de espera de la solicitud de ubicaci√≥n ha expirado.";
                    break;
            }
            updateCurrentUserUI({
                status: 'offline',
                message: message
            });
            database.ref(`vehicles/${currentUserId}/status`).set('offline');
            showNotification(`Error: ${message}`, 'warning');
        }

        function updateCurrentUserUI(data) {
            const statusElement = document.getElementById('current-user-status');
            const iconElement = document.getElementById('current-user-icon');
            const coordsElement = document.getElementById('current-user-coords');
            const locationStatus = document.getElementById('locationStatus');
            const accuracyValue = document.getElementById('accuracyValue');
            const gpsStatus = document.getElementById('gpsStatus');

            if (data.status) {
                statusElement.textContent = data.status === 'online' ? 'En ruta' : 'Desconectado';
                statusElement.className = data.status;
                iconElement.className = `user-icon ${data.status}`;
            }

            if (data.lat && data.lng) {
                coordsElement.textContent = `${data.lat}, ${data.lng}`;
                locationStatus.textContent = 'Tu ubicaci√≥n';
                
                // Actualizar marcador y c√≠rculo de precisi√≥n
                const newLatLng = L.latLng(data.lat, data.lng);
                if (!userPositionMarker) {
                    const iconHtml = `<div class="pulse-circle"></div><div class="vehicle-marker online" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');"></div>`;
                    userPositionMarker = L.marker(newLatLng, {
                        icon: L.divIcon({ className: 'custom-user-marker', html: iconHtml, iconSize: [42, 42], iconAnchor: [21, 21] }),
                    }).addTo(map);
                    userAccuracyCircle = L.circle(newLatLng, { radius: data.accuracy, className: 'accuracy-circle' }).addTo(map);
                } else {
                    userPositionMarker.setLatLng(newLatLng);
                    userAccuracyCircle.setLatLng(newLatLng).setRadius(data.accuracy);
                }
                
                accuracyValue.textContent = `${data.accuracy.toFixed(2)} m`;
                gpsStatus.textContent = "Activo";
                gpsStatus.className = "diagnostic-value online";
            } else {
                coordsElement.textContent = "--";
                locationStatus.textContent = 'Buscando tu ubicaci√≥n...';
                accuracyValue.textContent = "--";
                gpsStatus.textContent = "Inactivo";
                gpsStatus.className = "diagnostic-value offline";
            }
        }
        
        function updateViewerUI(vehicles) {
            let onlineCount = 0;
            if (!vehicles) return;
            
            Object.keys(vehicles).forEach(vehicleId => {
                if (vehicleId.toLowerCase().includes('movil') || vehicleId.toLowerCase() === 'admin') {
                    const vehicleData = vehicles[vehicleId];
                    const latLng = [vehicleData.lat, vehicleData.lng];
                    const status = (Date.now() - vehicleData.timestamp < TEN_MINUTES) ? 'online' : 'offline';
                    
                    if (status === 'online') onlineCount++;
                    
                    // Actualizar marcadores en el mapa
                    if (!markers[vehicleId]) {
                        const iconHtml = `<div class="vehicle-marker ${status}" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');"></div><div class="vehicle-label">${vehicleId}</div>`;
                        const customIcon = L.divIcon({ className: 'custom-vehicle-marker', html: iconHtml, iconSize: [42, 42], iconAnchor: [21, 21] });
                        markers[vehicleId] = L.marker(latLng, { icon: customIcon }).addTo(map);
                    } else {
                        markers[vehicleId].setLatLng(latLng);
                        const iconHtml = `<div class="vehicle-marker ${status}" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.85 7h10.29l1.08 3.11H5.77L6.85 7zM19 17H5v-5h14v5z"/><circle cx="7.5" cy="14.5" r="1.5"/><circle cx="16.5" cy="14.5" r="1.5"/></svg>');"></div><div class="vehicle-label">${vehicleId}</div>`;
                        const customIcon = L.divIcon({ className: 'custom-vehicle-marker', html: iconHtml, iconSize: [42, 42], iconAnchor: [21, 21] });
                        markers[vehicleId].setIcon(customIcon);
                    }
                    
                    // Actualizar info en el panel de control
                    updateVehiclePanel(vehicleId, status);
                }
            });
            // Remover marcadores de veh√≠culos que ya no est√°n en la lista
            Object.keys(markers).forEach(vehicleId => {
                if (!vehicles[vehicleId]) {
                    map.removeLayer(markers[vehicleId]);
                    delete markers[vehicleId];
                }
            });
        }
        
        function updateVehiclePanel(mobileId, status) {
            // Asegurarse de que no se actualice el panel de usuario si es un viewer
            if (mobileId !== currentUserId || !isViewer) {
                const element = document.getElementById(`${mobileId.toLowerCase()}-status`);
                const iconElement = document.getElementById(`${mobileId.toLowerCase()}-icon`);
                
                if (element) {
                    element.textContent = status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = status === 'online' ? 'online' : 'offline';
                }
                
                if (iconElement) {
                    iconElement.className = `vehicle-icon ${status === 'online' ? 'online' : 'offline'}`;
                }
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('statusNotification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function startViewerUpdates() {
            viewerUpdateInterval = setInterval(fetchVehicles, UPDATE_INTERVAL);
            fetchVehicles(); // Fetch inicial
        }
        
        function fetchVehicles() {
            database.ref('vehicles').once('value').then(snapshot => {
                updateViewerUI(snapshot.val());
            }).catch(error => {
                console.error("Error fetching vehicles: ", error);
                showNotification("Error al cargar datos de veh√≠culos.", 'error');
            });
        }

        function refreshData() {
            if (isViewer) {
                fetchVehicles();
            } else {
                navigator.geolocation.getCurrentPosition(updateGPSLocation, onLocationError, { enableHighAccuracy: true });
            }
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('loading');
            setTimeout(() => refreshBtn.classList.remove('loading'), 1000);
        }

        function centerMapOnUser() {
            if (lastKnownPosition) {
                map.setView(lastKnownPosition, map.getZoom());
                showNotification('Centrado en tu ubicaci√≥n');
            } else {
                showNotification('Ubicaci√≥n no disponible a√∫n.', 'warning');
            }
        }
        
        function updateRouteLayer() {
            if (currentRouteLayer) {
                map.removeLayer(currentRouteLayer);
            }
            
            const selectedRoute = document.getElementById('routeSelector').value;
            let routeCoordinates = [];
            let color = 'gray';

            if (selectedRoute === 'route1') {
                routeCoordinates = route1Coordinates;
                color = var(--route1-color);
            } else if (selectedRoute === 'route2') {
                routeCoordinates = route2Coordinates;
                color = var(--route2-color);
            }

            if (routeCoordinates.length > 0) {
                currentRouteLayer = L.polyline(routeCoordinates, { color: color, weight: 5, opacity: 0.7 }).addTo(map);
            }
        }
        
        function requestWakeLock() {
            if ('wakeLock' in navigator) {
                navigator.wakeLock.request('screen').then(lock => {
                    wakeLock = lock;
                    console.log('Wake Lock activo!');
                }).catch(err => {
                    console.error('No se pudo activar Wake Lock:', err.name, err.message);
                });
            }
        }
        
        function logout() {
            if (gpsInterval) clearInterval(gpsInterval);
            if (locationUpdateInterval) clearInterval(locationUpdateInterval);
            if (viewerUpdateInterval) clearInterval(viewerUpdateInterval);
            if (backgroundGeolocationWatchId !== null) {
                navigator.geolocation.clearWatch(backgroundGeolocationWatchId);
            }
            if (wakeLock !== null) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                });
            }
            database.ref('vehicles').off();
            firebase.auth().signOut();
            localStorage.removeItem('gpsAuth');
            localStorage.removeItem('panelState');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
