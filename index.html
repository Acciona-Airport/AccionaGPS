<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS | Acciona</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        .control-panel {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 280px;
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .online { color: #27ae60; }
        .offline { color: #e74c3c; }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }
        /* Marcadores personalizados */
        .marker-movil1 { background-color: #3498db; }
        .marker-movil2 { background-color: #2ecc71; }
        .marker-movil3 { background-color: #e67e22; }
        .marker-movil4 { background-color: #9b59b6; }
        .marker {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <h3 style="margin-top:0;color:#2c3e50;">🚗 Flota Acciona</h3>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil1" style="margin-right:8px;">1</span> Móvil 1</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil1-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil2" style="margin-right:8px;">2</span> Móvil 2</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil2-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil3" style="margin-right:8px;">3</span> Móvil 3</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil3-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil4" style="margin-right:8px;">4</span> Móvil 4</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil4-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuración
        const SCL_COORDS = [-33.3931, -70.7858];
        const ZOOM_INICIAL = 14;
        let map;
        const markers = {};
        
        // Datos iniciales (simulados)
        const mobileData = {
            Movil1: { coords: null, status: 'offline', color: '#3498db' },
            Movil2: { coords: null, status: 'offline', color: '#2ecc71' },
            Movil3: { coords: null, status: 'offline', color: '#e67e22' },
            Movil4: { coords: null, status: 'offline', color: '#9b59b6' }
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            const auth = JSON.parse(localStorage.getItem('gpsAuth'));
            if (!auth) {
                window.location.href = 'login.html';
                return;
            }
            
            initMap();
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Iniciar seguimiento según tipo de usuario
            if (!auth.isViewer) {
                startGPSTracking(auth.username);
            } else {
                startMonitoring();
            }
        });
        
        function initMap() {
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            
            // Marcador aeropuerto
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('✈️ Aeropuerto SCL')
                .openPopup();
        }
        
        function startGPSTracking(mobileId) {
            // Simulación para demo (en producción usar GPS real)
            simulateGPS(mobileId);
            setInterval(() => simulateGPS(mobileId), 10000);
            
            /* Código para GPS real:
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        const coords = [position.coords.latitude, position.coords.longitude];
                        updateMobilePosition(mobileId, coords);
                    },
                    error => {
                        console.error('Error GPS:', error);
                        simulateGPS(mobileId);
                    },
                    { enableHighAccuracy: true }
                );
            } else {
                alert('GPS no soportado');
                simulateGPS(mobileId);
            }
            */
        }
        
        function startMonitoring() {
            // Simular los 4 móviles para funcionarios
            Object.keys(mobileData).forEach(mobile => {
                simulateGPS(mobile);
                setInterval(() => simulateGPS(mobile), 8000);
            });
        }
        
        function simulateGPS(mobileId) {
            const offset = () => (Math.random() * 0.03 - 0.015);
            const newCoords = [
                SCL_COORDS[0] + offset(),
                SCL_COORDS[1] + offset()
            ];
            
            mobileData[mobileId] = {
                coords: newCoords,
                status: Math.random() > 0.2 ? 'online' : 'offline',
                lastUpdate: new Date()
            };
            
            updateMobilePosition(mobileId, newCoords);
        }
        
        function updateMobilePosition(mobileId, coords) {
            // Crear/actualizar marcador
            if (!markers[mobileId]) {
                markers[mobileId] = L.marker(coords, {
                    icon: L.divIcon({
                        className: `marker-${mobileId.toLowerCase()}`,
                        html: mobileId.replace('Movil', ''),
                        iconSize: [30, 30],
                        className: 'marker'
                    })
                }).addTo(map)
                .bindPopup(`<b>${mobileId}</b>`);
            } else {
                markers[mobileId]
                    .setLatLng(coords)
                    .setPopupContent(`<b>${mobileId}</b><br>${new Date().toLocaleTimeString()}`);
            }
            
            // Actualizar UI
            updateStatusUI();
        }
        
        function updateStatusUI() {
            Object.keys(mobileData).forEach(mobile => {
                const element = document.getElementById(`${mobile.toLowerCase()}-status`);
                if (element) {
                    element.textContent = mobileData[mobile].status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = mobileData[mobile].status === 'online' ? 'online' : 'offline';
                }
            });
        }
        
        function logout() {
            localStorage.removeItem('gpsAuth');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
