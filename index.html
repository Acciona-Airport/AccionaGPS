<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor GPS | Acciona</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }
        /* Panel deslizante */
        .control-panel {
            position: fixed;
            top: 15px;
            right: 0;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px 0 0 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            width: 280px;
            transform: translateX(265px);
            transition: transform 0.3s ease;
        }
        .control-panel.visible {
            transform: translateX(0);
        }
        .toggle-panel {
            position: absolute;
            left: -25px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.9);
            border: none;
            width: 25px;
            height: 60px;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -3px 0 5px rgba(0,0,0,0.1);
        }
        .toggle-panel:hover {
            background: #f8f9fa;
        }
        .toggle-icon {
            font-size: 16px;
            transition: transform 0.3s;
        }
        .control-panel.visible .toggle-icon {
            transform: rotate(180deg);
        }
        .vehicle-card {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        .vehicle-card:last-child {
            border-bottom: none;
        }
        .vehicle-name {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        .vehicle-status {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .online { color: #27ae60; }
        .offline { color: #e74c3c; }
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }
        /* Marcadores personalizados */
        .marker-movil1 { background-color: #3498db; }
        .marker-movil2 { background-color: #2ecc71; }
        .marker-movil3 { background-color: #e67e22; }
        .marker-movil4 { background-color: #9b59b6; }
        .marker {
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel" id="controlPanel">
        <button class="toggle-panel" id="togglePanel">
            <span class="toggle-icon">◄</span>
        </button>
        
        <h3 style="margin-top:0;color:#2c3e50;">🚗 Flota Acciona</h3>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil1" style="margin-right:8px;">1</span> Móvil 1</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil1-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil2" style="margin-right:8px;">2</span> Móvil 2</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil2-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil3" style="margin-right:8px;">3</span> Móvil 3</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil3-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <div class="vehicle-card">
            <div class="vehicle-name"><span class="marker marker-movil4" style="margin-right:8px;">4</span> Móvil 4</div>
            <div class="vehicle-status">
                <span>Estado:</span>
                <span id="movil4-status" class="offline">Desconectado</span>
            </div>
        </div>
        
        <button class="logout-btn" id="logoutBtn">Cerrar Sesión</button>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Configuración
        const SCL_COORDS = [-33.3931, -70.7858];
        const ZOOM_INICIAL = 14;
        let map;
        const markers = {};
        let gpsInterval;
        
        // Datos compartidos (simulados)
        const mobileData = {
            Movil1: { coords: null, status: 'offline', color: '#3498db' },
            Movil2: { coords: null, status: 'offline', color: '#2ecc71' },
            Movil3: { coords: null, status: 'offline', color: '#e67e22' },
            Movil4: { coords: null, status: 'offline', color: '#9b59b6' }
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            const session = JSON.parse(localStorage.getItem('mobileSession'));
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            
            initMap();
            setupUI();
            
            if (!session.isViewer) {
                // Modo móvil - envío de posición
                startGPSTracking(session.username);
            } else {
                // Modo funcionarios - solo visualización
                startMonitoring();
            }
        });
        
        function initMap() {
            map = L.map('map').setView(SCL_COORDS, ZOOM_INICIAL);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
            
            // Marcador aeropuerto
            L.marker(SCL_COORDS)
                .addTo(map)
                .bindPopup('✈️ Aeropuerto SCL')
                .openPopup();
        }
        
        function setupUI() {
            // Botón de logout
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Toggle del panel
            const panel = document.getElementById('controlPanel');
            document.getElementById('togglePanel').addEventListener('click', function() {
                panel.classList.toggle('visible');
            });
            
            // Mostrar panel por defecto en pantallas grandes
            if (window.innerWidth > 768) {
                panel.classList.add('visible');
            }
        }
        
        function startGPSTracking(mobileId) {
            // 1. Detener cualquier seguimiento previo
            if (gpsInterval) clearInterval(gpsInterval);
            
            // 2. Enviar posición inicial inmediatamente
            getCurrentPosition(mobileId);
            
            // 3. Actualizar cada 5 segundos
            gpsInterval = setInterval(() => {
                getCurrentPosition(mobileId);
            }, 5000);
        }
        
        function getCurrentPosition(mobileId) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const coords = [position.coords.latitude, position.coords.longitude];
                        updateMobilePosition(mobileId, coords, 'online');
                        
                        // En sistema real: enviar a servidor con fetch/API
                        console.log(`Posición ${mobileId}:`, coords);
                    },
                    error => {
                        console.error(`Error GPS (${mobileId}):`, error);
                        updateMobilePosition(mobileId, mobileData[mobileId]?.coords || SCL_COORDS, 'offline');
                    },
                    { 
                        enableHighAccuracy: true,
                        timeout: 4000,
                        maximumAge: 0 // Siempre obtener posición fresca
                    }
                );
            } else {
                alert('Tu dispositivo no soporta geolocalización');
            }
        }
        
        function startMonitoring() {
            // Simular actualización de los 4 móviles
            Object.keys(mobileData).forEach(mobile => {
                if (!mobileData[mobile].coords) {
                    simulateGPS(mobile);
                }
            });
            
            // Actualizar posiciones cada 3 segundos (simulado)
            setInterval(() => {
                Object.keys(mobileData).forEach(mobile => {
                    simulateGPS(mobile);
                });
            }, 3000);
        }
        
        function simulateGPS(mobileId) {
            const offset = () => (Math.random() * 0.03 - 0.015);
            const newCoords = mobileData[mobileId]?.coords 
                ? [
                    mobileData[mobileId].coords[0] + offset(),
                    mobileData[mobileId].coords[1] + offset()
                  ]
                : [
                    SCL_COORDS[0] + offset(),
                    SCL_COORDS[1] + offset()
                  ];
            
            const status = Math.random() > 0.1 ? 'online' : 'offline';
            updateMobilePosition(mobileId, newCoords, status);
        }
        
        function updateMobilePosition(mobileId, coords, status) {
            if (!coords) return;
            
            // Actualizar datos
            mobileData[mobileId] = {
                coords,
                status,
                lastUpdate: new Date()
            };
            
            // Crear/actualizar marcador
            if (!markers[mobileId]) {
                markers[mobileId] = L.marker(coords, {
                    icon: L.divIcon({
                        className: `marker-${mobileId.toLowerCase()}`,
                        html: mobileId.replace('Movil', ''),
                        iconSize: [30, 30],
                        className: 'marker'
                    })
                }).addTo(map)
                .bindPopup(`<b>${mobileId}</b>`);
            } else {
                markers[mobileId]
                    .setLatLng(coords)
                    .setPopupContent(`<b>${mobileId}</b><br>Última actualización: ${new Date().toLocaleTimeString()}`);
            }
            
            // Centrar mapa en la posición del móvil actual (solo si es el usuario activo)
            const session = JSON.parse(localStorage.getItem('mobileSession'));
            if (!session.isViewer && session.username === mobileId) {
                map.setView(coords);
            }
            
            updateStatusUI();
        }
        
        function updateStatusUI() {
            Object.keys(mobileData).forEach(mobile => {
                const element = document.getElementById(`${mobile.toLowerCase()}-status`);
                if (element) {
                    element.textContent = mobileData[mobile].status === 'online' ? 'En ruta' : 'Desconectado';
                    element.className = mobileData[mobile].status === 'online' ? 'online' : 'offline';
                }
            });
        }
        
        function logout() {
            // Limpiar intervalo de GPS
            if (gpsInterval) clearInterval(gpsInterval);
            
            // Eliminar sesión
            localStorage.removeItem('mobileSession');
            
            // Redirigir al login
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
